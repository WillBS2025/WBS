<div id="UsuariosView"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;
const { Table, Button, Modal, Form, Input, Select, Space, message, Typography, Card, Row, Col, Tag } = antd;
const icons = (window.icons || window.iconsAntd || {});
const { Title } = Typography;

function Usuarios() {
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(false);
  const [open, setOpen] = useState(false);
  const [mode, setMode] = useState('create'); // 'create' | 'edit'
  const [form] = antd.Form.useForm();
  const [empleados, setEmpleados] = useState([]);
  const [toDelete, setToDelete] = useState(null);
  const [sucursalFiltro, setSucursalFiltro] = useState(null);
  const [openDelete, setOpenDelete] = useState(false);

  const columns = [
    { title: 'N.', dataIndex: '__n__', key: '__n__', width: 80, render: (_r,_d,i)=> i+1 },
    { title: 'Nombre completo', dataIndex: 'nombreCompleto', key: 'nombreCompleto' },
    { title: 'Usuario', dataIndex: 'nombre_usuario', key: 'nombre_usuario' },
    { title: 'Sucursal', dataIndex: 'nombreSucursal', key: 'nombreSucursal' },
    { title: 'Rol', dataIndex: 'rol', key: 'rol', render: (v)=> String(v||'').replace('_',' ').toUpperCase() },
    { title: 'Estado', dataIndex: 'estado', key: 'estado' },
    {
      title: 'Acciones',
      key: 'acciones',
      width: 160,
      render: (_, record) => (
        <Space>
          <Button size="small" icon={<icons.EditOutlined />} onClick={() => abrirEditar(record)}>Editar</Button>
          <Button size="small" danger icon={<icons.DeleteOutlined />} onClick={() => { setToDelete(record); setOpenDelete(true); }}>Eliminar</Button>
        </Space>
      ),
    },
  ];

  useEffect(() => {
    cargar();
    cargarEmpleados();
  }, []);

  function normalizeResponse(res) {
    try { return (typeof res === 'string') ? JSON.parse(res) : res; }
    catch (e) { return res; }
  }

  function cargar() {
    setLoading(true);
    google.script.run
      .withSuccessHandler((res) => {
        setLoading(false);
        const r = normalizeResponse(res);
        const arr = Array.isArray((r && r.usuarios)) ? r.usuarios : Array.isArray(r) ? r : [];
        setData(arr);
      })
      .withFailureHandler((err) => {
        setLoading(false);
        Modal.error({ title: 'Error', content: String((err && err.message) || err) });
      })
      .listarUsuarios();
  }

  function cargarEmpleados() {
    google.script.run
      .withSuccessHandler((res) => {
        const r = normalizeResponse(res);
        const arr = Array.isArray((r && r.empleados)) ? r.empleados : Array.isArray(r) ? r : [];
        setEmpleados(arr.filter(e => String(e.estado||'')==='Activo'));
      })
      .withFailureHandler(() => setEmpleados([]))
      .listarEmpleados();
  }

  function abrirNuevo(){
    setMode('create'); form.resetFields(); setOpen(true);
  }
  function abrirEditar(record){
    setMode('edit');
    form.setFieldsValue({
      id: record.id,
      nombreCompleto: record.nombreCompleto,
      correo: record.correo,
      contrasenia: '',
      rol: record.rol,
      estado: record.estado,
      nombre_usuario: record.nombre_usuario,
    });
    setOpen(true);
  }

  function onSubmit(){
    form.validateFields().then(values => {
      setLoading(true);
      const runner = (mode==='create') ? 'guardarUsuarioSeguro' : 'actualizarUsuarioSeguro';
      const payload = {
        id: values.id || undefined,
        nombreCompleto: values.nombreCompleto,
        nombre_usuario: values.nombre_usuario,
        contrasenia: values.contrasenia || '',
        rol: values.rol,
        estado: values.estado,
      };

      google.script.run
        .withSuccessHandler(res => {
          setLoading(false);
          const r = normalizeResponse(res);
          if (r && (r.ok || r.titulo)) {
            message.success(mode==='create'?'Usuario creado':'Usuario actualizado');
            setOpen(false);
            form.resetFields();
            cargar();
          } else {
            Modal.error({ title: 'Error', content: (r && r.message) || 'No se pudo guardar' });
          }
        })
        .withFailureHandler(err => {
          setLoading(false);
          Modal.error({ title:'Error', content: String((err && err.message) || err) });
        })
        [runner](JSON.stringify(payload));
    });
  }

  function confirmarEliminar(){
    if (!toDelete) return;
    setLoading(true);
    google.script.run
      .withSuccessHandler(res => {
        setLoading(false);
        const r = normalizeResponse(res);
        if (r && (r.ok || r.titulo)) {
          message.success('Usuario eliminado');
          setOpenDelete(false); setToDelete(null); cargar();
        } else {
          Modal.error({ title: 'Error', content: (r && r.message) || 'No se pudo eliminar' });
        }
      })
      .withFailureHandler(err => {
        setLoading(false);
        Modal.error({ title: 'Error', content: String((err && err.message) || err) });
      })
      .eliminarUsuario(toDelete.id);
  }

  /* ========== NUEVO: Estilo + KPIs y dashboards (look Sucursales) ========== */
  function useCountUp(value, duration=700){
    const [display, setDisplay] = useState(0);
    const prevRef = useRef(0);
    useEffect(()=>{
      const start = performance.now();
      const from = prevRef.current;
      const to = Number(value||0);
      let raf;
      function tick(t){
        const p = Math.min(1, (t - start)/duration);
        const eased = 1 - Math.pow(1 - p, 3);
        setDisplay(from + (to - from) * eased);
        if (p < 1) raf = requestAnimationFrame(tick);
      }
      raf = requestAnimationFrame(tick);
      prevRef.current = to;
      return ()=> cancelAnimationFrame(raf);
    }, [value, duration]);
    return display;
  }
  function KPI({ title, value, suffix }){
    const v = useCountUp(value);
    return (
      <Card bodyStyle={{ padding: 14 }} className="usr-kpi">
        <div className="usr-kpi-sub">{title}</div>
        <div className="usr-kpi-val">{Math.round(Number(v))}{suffix||''}</div>
      </Card>
    );
  }

  // Dataset filtrado por la sucursal seleccionada (para que KPIs respondan al filtro)
  const filtered = (Array.isArray(data)?data:[]).filter(r => !sucursalFiltro || String(r.nombreSucursal||'')===String(sucursalFiltro));

  // KPIs
  const total = filtered.length;
  const activos = filtered.filter(r => String(r.estado||'')==='Activo').length;
  const inactivos = filtered.filter(r => String(r.estado||'')==='Inactivo').length;
  const sucursalesConUsuarios = new Set(filtered.map(r=>r.nombreSucursal).filter(Boolean)).size;

  // Distribuciones
  const rolMap = {}; filtered.forEach(r => { const k=(r.rol||'').toLowerCase(); rolMap[k]=(rolMap[k]||0)+1; });
  const rolRows = Object.keys(rolMap).map(k => ({ rol: (k||'').replace('_',' ').toUpperCase(), cantidad: rolMap[k] }));

  const sucMap = {}; filtered.forEach(r => { const s=r.nombreSucursal||'(Sin suc.)'; sucMap[s]=(sucMap[s]||0)+1; });
  const sucRows = Object.keys(sucMap).map(s => ({ sucursal:s, cantidad:sucMap[s] })).sort((a,b)=> b.cantidad - a.cantidad);
  const maxSuc = Math.max(1, ...sucRows.map(r=>r.cantidad));

  const colsRoles = [
    { title:'Rol', dataIndex:'rol', key:'rol' },
    { title:'Usuarios', dataIndex:'cantidad', key:'cantidad', align:'right', width:110 },
  ];
  const colsSucursales = [
    { title:'Sucursal', dataIndex:'sucursal', key:'sucursal' },
    { title:'Usuarios', dataIndex:'cantidad', key:'cantidad', align:'right', width:110 },
    { title:'', key:'bar', render:(_,r)=>(
      <div className="usr-bar"><span style={{ width:(r.cantidad*100/maxSuc)+'%' }} /></div>
    )},
  ];

  return (
    <div className="p-4">
      {/* ===== Estilos scopeados (no tocan tu sidebar) ===== */}
      <style>{`
        .usr-hero{ display:flex; align-items:center; gap:10px; }
        .usr-hero-title{ position:relative; padding-left:12px; font-weight:800; }
        .usr-spark{
          position:absolute; left:0; top:6px; width:6px; height:22px; border-radius:3px;
          background: linear-gradient(180deg,#60a5fa,#a78bfa,#34d399);
          animation: usrSpark 2.6s ease-in-out infinite;
        }
        @keyframes usrSpark{ 0%{opacity:.4; transform:translateY(0)} 50%{opacity:1; transform:translateY(6px)} 100%{opacity:.4; transform:translateY(0)} }

        .usr-kpi{ border-radius:14px; background: linear-gradient(135deg,#e0eaff,#e9fff6); box-shadow: 0 2px 10px rgba(15,23,42,.06); }
        .usr-kpi-sub{ font-size:12px; color:#6b7280 }
        .usr-kpi-val{ font-size:26px; font-weight:800; color:#0f172a }

        .usr-bar{ height:10px; background:#eef2ff; border-radius:999px; overflow:hidden; }
        .usr-bar > span{ display:block; height:100%; background:linear-gradient(90deg,#60a5fa,#34d399); }

        .usr-table .ant-table{ border-radius:14px; overflow:hidden; }
        .usr-table .ant-table-thead > tr > th{ background:#f8fafc !important; border-bottom:0; color:#334155; font-weight:700; }
        .usr-table .ant-table-tbody > tr{ transition: transform .15s ease, box-shadow .15s ease, background .2s; }
        .usr-table .ant-table-tbody > tr:hover{ transform: scale(1.01); box-shadow: 0 10px 24px rgba(2,6,23,.08); }
        .usr-table .ant-table-tbody > tr:nth-child(odd) td{ background:#fcfdff; }
      `}</style>

      {/* ======= Tu header original (NO LO QUITO) ======= */}
      <div className="flex items-center justify-between mb-3">
        <div className="usr-hero">
          <icons.UserOutlined />
          <div className="usr-hero-title"><span className="usr-spark"></span>Usuarios</div>
        </div>
        <Space>
          <Select allowClear placeholder="Filtrar por sucursal" style={{width:220}}
                  value={sucursalFiltro}
                  options={Array.from(new Set((data||[]).map(r => r.nombreSucursal).filter(Boolean)))
                            .map(s => ({value:s,label:s}))}
                  onChange={(v)=>setSucursalFiltro(v||null)} />
          <Button icon={<icons.ReloadOutlined />} onClick={cargar}>Refrescar</Button>
          <Button type="primary" icon={<icons.PlusOutlined />} onClick={abrirNuevo}>Nuevo</Button>
        </Space>
      </div>

      {/* ===== KPIs ===== */}
      <Row gutter={[12,12]} style={{ marginBottom: 8 }}>
        <Col xs={24} sm={6}><KPI title="Usuarios" value={total} /></Col>
        <Col xs={24} sm={6}><KPI title="Activos" value={activos} /></Col>
        <Col xs={24} sm={6}><KPI title="Inactivos" value={inactivos} /></Col>
        <Col xs={24} sm={6}><KPI title="Sucursales con usuarios" value={sucursalesConUsuarios} /></Col>
      </Row>

      {/* ===== Dashboards ===== */}
      <Row gutter={[12,12]} style={{ marginBottom: 8 }}>
        <Col xs={24} lg={12}>
          <Card size="small" title="Distribución por sucursal">
            <Table size="small" dataSource={sucRows.map((r,i)=>({ ...r, key:i }))} columns={colsSucursales} pagination={false} rowKey="key" />
          </Card>
        </Col>
        <Col xs={24} lg={12}>
          <Card size="small" title="Distribución por rol">
            <Table size="small" dataSource={rolRows.map((r,i)=>({ ...r, key:i }))} columns={colsRoles} pagination={false} rowKey="key" />
          </Card>
        </Col>
      </Row>

      {/* ===== Tu tabla original, solo envuelta para el estilo ===== */}
      <div className="usr-table">
        <Table
          rowKey="id"
          dataSource={filtered}
          columns={Array.isArray(columns)?columns:[]}
          loading={loading}
          pagination={{ pageSize: 8 }}
        />
      </div>

      {/* ===== Modales originales (SIN CAMBIOS) ===== */}
      <Modal
        visible={open}
        onCancel={()=>setOpen(false)}
        onOk={onSubmit}
        title={mode==='create'?'Nuevo Usuario':'Editar Usuario'}
        okText={mode==='create'?'Crear':'Guardar'}
        confirmLoading={loading}
        destroyOnClose
      >
        <Form form={form} layout="vertical" preserve={false}>
          <Form.Item name="id" hidden><Input /></Form.Item>
          <Form.Item
            name="nombreCompleto"
            label="Nombre completo"
            rules={[{ required:true, message:'Selecciona un empleado' }]}
          >
            <Select
              showSearch
              placeholder="Selecciona un empleado..."
              optionFilterProp="label"
              options={(empleados||[]).map(e => ({ value: e.nombre_empleado, label: e.nombre_empleado }))}
            />
          </Form.Item>
          <Form.Item
            name="nombre_usuario"
            label="Usuario"
            rules={[{ required:true, message:'Usuario válido' }]}
          >
            <Input placeholder="usuario (ej. andresp)" />
          </Form.Item>
          <Form.Item
            name="contrasenia"
            label="Contraseña"
            rules={mode==='create'?[{ required:true, message:'Ingresa una contraseña' }]:[]}
          >
            <Input.Password placeholder={mode==='create'?'Nueva contraseña':'(Opcional) nueva contraseña'} />
          </Form.Item>
          <Form.Item name="rol" label="Rol" rules={[{ required:true, message:'Selecciona un rol' }]}>
            <Select options={[ { value:'super_admin', label:'Super Admin' }, { value:'admin', label:'Admin' } ]} />
          </Form.Item>
          <Form.Item name="estado" label="Estado" rules={[{ required:true, message:'Selecciona estado' }]}>
            <Select options={[ { value:'Activo', label:'Activo' }, { value:'Inactivo', label:'Inactivo' } ]} />
          </Form.Item>
        </Form>
      </Modal>

      <Modal
        visible={openDelete}
        onCancel={() => { setOpenDelete(false); setToDelete(null); }}
        onOk={confirmarEliminar}
        title="Confirmar eliminación"
        okText="Eliminar"
        okButtonProps={{ danger:true }}
        confirmLoading={loading}
      >
        <p>¿Eliminar el usuario <b>{(toDelete && toDelete.nombreCompleto)}</b>?</p>
      </Modal>
    </div>
  );
}

ReactDOM.render(<Usuarios />, document.getElementById('UsuariosView'));
</script>
