<style>
  .page-title{font-weight:600;font-size:16px;margin-bottom:12px}
</style>

<div id="ReportesView"></div>

<script type="text/babel">
  const { useState, useEffect, useMemo, useRef } = React;
  const { Tabs, Table, Card, message, Button, Row, Col, Input, Select, Statistic, Space, Tag } = antd;

  function Reportes(){
    // ===== Ventas (existente) =====
    const [loadingVentas, setLoadingVentas] = useState(false);
    const [ventas, setVentas] = useState([]);
    const [activeKey, setActiveKey] = useState('ventas');

    function fromCache(){
      try{
        const raw = sessionStorage.getItem('repVentas');
        if (raw){
          const arr = JSON.parse(raw);
          if (Array.isArray(arr)) setVentas(arr);
        }
      }catch(e){}
    }

    function fetchVentas(){
      setLoadingVentas(true);
      try{
        if (google && google.script && google.script.run){
          google.script.run
            .withSuccessHandler(function(res){
              try{
                const r = (typeof res === 'string') ? JSON.parse(res) : res;
                if (r && r.ok && Array.isArray(r.data)){
                  sessionStorage.setItem('repVentas', JSON.stringify(r.data));
                  setVentas(r.data);
                } else {
                  message.warning('No se encontraron registros.');
                }
              }catch(e){
                console && console.error && console.error(e);
              }
              setLoadingVentas(false);
            })
            .withFailureHandler(function(err){
              setLoadingVentas(false);
              message.error(String((err && err.message) || err || 'Error al cargar'));
            })
            .bootstrapReportesVentas();
        } else {
          setLoadingVentas(false);
        }
      }catch(e){
        setLoadingVentas(false);
      }
    }

    // ===== Gastos (con mejoras) =====
    const [loadingGastos, setLoadingGastos] = useState(false);
    const [gastos, setGastos] = useState([]);
    const [resumenG, setResumenG] = useState(null);
    const [sucursales, setSucursales] = useState([]);

    const yearNow = new Date().getFullYear();
    const monthNow = new Date().getMonth() + 1; // 1..12

    const [filtrosG, setFiltrosG] = useState({
      periodo: 'anual',      // 'anual' | 'mensual' | 'quincenal' | 'semanal' | 'diario'
      anio: yearNow,
      mes: monthNow,         // mensual/quincenal
      quincena: 1,           // 1 o 2
      fechaRef: new Date().toISOString().slice(0,10), // semanal/diario (YYYY-MM-DD)
      nombreSucursal: '',
      q: ''
    });

    const currency = (n) => {
      try{
        return 'L.' + new Intl.NumberFormat('es-HN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(Number(n||0));
      }catch(e){
        return 'L.' + Number(n||0).toFixed(2);
      }
    };

    // ==== Helpers periodo ====
    function endOfMonth(y, m){ return new Date(y, m, 0).getDate(); } // m 1..12
    function ymd(d){
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }

    // Debounce para autorefresh
    const debounceRef = useRef({});
    function debouncedFetch(key, overrides, delay=350){
      try{
        if (debounceRef.current[key]) clearTimeout(debounceRef.current[key]);
        debounceRef.current[key] = setTimeout(()=>{ fetchGastos(overrides); }, delay);
      }catch(e){}
    }

    // Construye payload para el backend (acepta overrides)
    function buildFiltrosG(overrides){
      const F = { ...filtrosG, ...(overrides||{}) };
      const p = F.periodo || 'anual';
      const out = {
        nombreSucursal: F.nombreSucursal || '',
        q: F.q || ''
      };
      const y = Number(F.anio || 0) || new Date().getFullYear();

      if (p === 'anual'){
        out.anio = y;
      } else if (p === 'mensual'){
        const m = Number(F.mes||0) || monthNow;
        out.anio = y;
        out.mes = m;
      } else if (p === 'quincenal'){
        const m = Number(F.mes||0) || monthNow;
        const q = Number(F.quincena||1)===2 ? 2 : 1;
        const start = new Date(y, m-1, q===1?1:16, 0,0,0);
        const endDay = q===1 ? 15 : endOfMonth(y, m);
        const end = new Date(y, m-1, endDay, 23,59,59);
        out.desde = ymd(start);
        out.hasta = ymd(end);
      } else if (p === 'semanal'){
        const ref = F.fechaRef ? new Date(F.fechaRef) : new Date();
        const d = new Date(ref.getFullYear(), ref.getMonth(), ref.getDate());
        const day = d.getDay(); // 0..6
        const diffToMon = (day === 0 ? -6 : 1 - day);
        const mon = new Date(d); mon.setDate(d.getDate() + diffToMon);
        const sun = new Date(mon); sun.setDate(mon.getDate() + 6); sun.setHours(23,59,59,0);
        out.desde = ymd(mon);
        out.hasta = ymd(sun);
      } else if (p === 'diario'){
        const ref = F.fechaRef ? new Date(F.fechaRef) : new Date();
        const start = new Date(ref.getFullYear(), ref.getMonth(), ref.getDate(), 0,0,0);
        const end = new Date(ref.getFullYear(), ref.getMonth(), ref.getDate(), 23,59,59);
        out.desde = ymd(start);
        out.hasta = ymd(end);
      }
      return out;
    }

    // ====== Sucursales robusto (3 fuentes) ======
    function fetchSucursales(){
      function setSucursalNames(names){
        try{
          const arr = Array.from(new Set((names || []).filter(Boolean)))
            .sort((a,b)=> a.localeCompare(b,'es',{sensitivity:'base'}));
          if (arr.length) setSucursales(arr);
        }catch(e){}
      }

      try{
        if (google && google.script && google.script.run){
          // 1) Preferido: directo desde hoja de Gastos
          google.script.run
            .withSuccessHandler(function(res){
              try{
                const r = (typeof res === 'string') ? JSON.parse(res) : res;
                let names = [];
                if (r && r.ok && Array.isArray(r.sucursales)){
                  if (typeof r.sucursales[0] === 'string'){
                    names = r.sucursales;
                  } else {
                    names = r.sucursales.map(x => x && (x.nombreSucursal || x.sucursal || x.Sucursal)).filter(Boolean);
                  }
                }
                setSucursalNames(names);

                // 2) Fallback si vacío: Activas
                if (!names || !names.length){
                  try{
                    google.script.run
                      .withSuccessHandler(function(res2){
                        try{
                          const r2 = (typeof res2 === 'string') ? JSON.parse(res2) : res2;
                          let names2 = [];
                          if (r2 && r2.ok && Array.isArray(r2.sucursales)){
                            if (typeof r2.sucursales[0] === 'string'){
                              names2 = r2.sucursales;
                            } else {
                              names2 = r2.sucursales.map(s => s && (s.nombreSucursal || s.sucursal || s.Sucursal)).filter(Boolean);
                            }
                          }
                          setSucursalNames(names2);

                          // 3) Último recurso: derivar de gastos/cache
                          if (!names2 || !names2.length){
                            try{
                              const raw = sessionStorage.getItem('repGastos');
                              const obj = raw ? JSON.parse(raw) : null;
                              const list = (obj && Array.isArray(obj.list)) ? obj.list : (Array.isArray(gastos) ? gastos : []);
                              const derivadas = Array.from(new Set((list || []).map(g => g && g.nombreSucursal).filter(Boolean)));
                              setSucursalNames(derivadas);
                            }catch(e){}
                          }
                        }catch(e){}
                      })
                      .withFailureHandler(function(err){ /* silencioso */ })
                      .listarSucursalesActivas();
                  }catch(e){}
                }
              }catch(e){}
            })
            .withFailureHandler(function(err){
              // Si falla el nuevo endpoint, probar Activas
              try{
                google.script.run
                  .withSuccessHandler(function(res2){
                    try{
                      const r2 = (typeof res2 === 'string') ? JSON.parse(res2) : res2;
                      let names2 = [];
                      if (r2 && r2.ok && Array.isArray(r2.sucursales)){
                        if (typeof r2.sucursales[0] === 'string'){
                          names2 = r2.sucursales;
                        } else {
                          names2 = r2.sucursales.map(s => s && (s.nombreSucursal || s.sucursal || s.Sucursal)).filter(Boolean);
                        }
                      }
                      setSucursalNames(names2);
                    }catch(e){}
                  })
                  .withFailureHandler(function(err2){ /* silencioso */ })
                  .listarSucursalesActivas();
              }catch(e){}
            })
            .listarSucursalesGastos(); // NUEVO endpoint
        }
      }catch(e){}
    }

    function fromCacheG(){
      try{
        const raw = sessionStorage.getItem('repGastos');
        if (!raw) return;
        const obj = JSON.parse(raw);
        if (obj && Array.isArray(obj.list)){
          setGastos(obj.list);
          setResumenG(obj.resumen || null);
        }
      }catch(e){}
    }

    function saveCacheG(list, resumen){
      try{
        sessionStorage.setItem('repGastos', JSON.stringify({ list, resumen }));
      }catch(e){}
    }

    function fetchGastos(overrides){
      setLoadingGastos(true);
      try{
        if (google && google.script && google.script.run){
          const payload = buildFiltrosG(overrides);
          google.script.run
            .withSuccessHandler(function(res){
              setLoadingGastos(false);
              try{
                const r = (typeof res === 'string') ? JSON.parse(res) : res;
                if (r && r.ok && r.data && Array.isArray(r.data.list)){
                  setGastos(r.data.list);
                  setResumenG(r.data.resumen || null);
                  saveCacheG(r.data.list, r.data.resumen || null);
                } else {
                  message.info('Sin datos para los filtros seleccionados.');
                  setGastos([]);
                  setResumenG(null);
                  saveCacheG([], null);
                }
              }catch(e){
                console && console.error && console.error(e);
              }
            })
            .withFailureHandler(function(err){
              setLoadingGastos(false);
              message.error(String((err && err.message) || err || 'Error al cargar gastos'));
            })
            .bootstrapReportesGastos(payload);
        } else {
          setLoadingGastos(false);
        }
      }catch(e){
        setLoadingGastos(false);
      }
    }

    // Cargas iniciales
    useEffect(function(){
      // Ventas
      fromCache();
      const hasCache = !!sessionStorage.getItem('repVentas');
      if (!hasCache){
        fetchVentas();
      } else {
        setTimeout(fetchVentas, 120);
      }

      // Gastos
      fetchSucursales();
      fromCacheG();
      fetchGastos(); // auto carga
    }, []);

    // Red de seguridad: si no hay sucursales, derivarlas de gastos cargados
    useEffect(function(){
      if (!sucursales.length && Array.isArray(gastos) && gastos.length){
        const names = Array.from(new Set(gastos.map(g => g && g.nombreSucursal).filter(Boolean)))
          .sort((a,b)=> a.localeCompare(b,'es',{sensitivity:'base'}));
        if (names.length) setSucursales(names);
      }
    }, [gastos]);

    const colsVentas = useMemo(function(){
      return [
        { title:'N.', dataIndex:'n', key:'n', width:80, align:'center', sorter:function(a,b){return Number(a.n||0)-Number(b.n||0);} },
        { title:'Descripción', dataIndex:'descripcion', key:'descripcion', ellipsis:true },
        { title:'Cant.', dataIndex:'cantidad', key:'cantidad', width:90, align:'right' },
        { title:'Precio', dataIndex:'precio', key:'precio', width:110, align:'right', render:function(v){ return 'L.'+Number(v||0).toFixed(2); } },
        { title:'Total línea', dataIndex:'total_linea', key:'total_linea', width:130, align:'right', render:function(v){ return 'L.'+Number(v||0).toFixed(2); } },
        { title:'Método de pago', dataIndex:'metodo_pago', key:'metodo_pago', width:160 }
      ];
    }, []);

    const colsGastos = useMemo(() => ([
      { title: 'Fecha', dataIndex: 'fecha', key: 'fecha', width: 110 },
      { title: 'Categoría', dataIndex: 'categoria', key: 'categoria', width: 140,
        render: (v) => v ? <Tag>{v}</Tag> : '-' },
      { title: 'Descripción', dataIndex: 'descripcion', key: 'descripcion' },
      { title: 'Monto', dataIndex: 'monto', key: 'monto', align: 'right', width: 120,
        render: (v) => <strong>{currency(v)}</strong> },
      { title: 'Método de pago', dataIndex: 'metodoPago', key: 'metodoPago', width: 140 },
      { title: 'Proveedor', dataIndex: 'proveedor', key: 'proveedor', width: 160 },
      { title: 'Sucursal', dataIndex: 'nombreSucursal', key: 'nombreSucursal', width: 140 },
      { title: 'Comprobante', dataIndex: 'comprobanteURL', key: 'comprobanteURL', width: 120,
        render: (v) => v ? <a href={v} target="_blank" rel="noreferrer">Ver</a> : '-' },
    ]), []);

    const KPIsG = useMemo(() => {
      const r = resumenG || {};
      return [
        { label: 'Total', value: currency(r.total || 0) },
        { label: 'Registros', value: String(r.registros || 0) },
        { label: 'Prom. mensual', value: currency(r.promedioMensual || 0) },
      ];
    }, [resumenG]);

    const periodOptions = useMemo(()=>[
      { label:'Anual', value:'anual' },
      { label:'Mensual', value:'mensual' },
      { label:'Quincenal', value:'quincenal' },
      { label:'Semanal', value:'semanal' },
      { label:'Diario', value:'diario' },
    ], []);
    const monthOptions = useMemo(()=>[
      {value:1,label:'Enero'},{value:2,label:'Febrero'},{value:3,label:'Marzo'},{value:4,label:'Abril'},
      {value:5,label:'Mayo'},{value:6,label:'Junio'},{value:7,label:'Julio'},{value:8,label:'Agosto'},
      {value:9,label:'Septiembre'},{value:10,label:'Octubre'},{value:11,label:'Noviembre'},{value:12,label:'Diciembre'}
    ], []);

    const showMes = filtrosG.periodo === 'mensual' || filtrosG.periodo === 'quincenal';
    const showQuincena = filtrosG.periodo === 'quincenal';
    const showFechaRef = filtrosG.periodo === 'semanal' || filtrosG.periodo === 'diario';

    return (
      <div>
        <div className="page-title">Reportes</div>
        <Tabs activeKey={activeKey} onChange={setActiveKey}>
          {/* ===== Tab Ventas ===== */}
          <Tabs.TabPane tab="Reporte de ventas" key="ventas">
            <Card
              size="small"
              extra={<Button onClick={fetchVentas}>Refrescar</Button>}
            >
              <Table
                size="middle"
                rowKey={function(_,i){ return 'rv-'+i; }}
                columns={colsVentas}
                dataSource={ventas}
                loading={loadingVentas}
                pagination={{ pageSize: 10, showSizeChanger:true }}
                scroll={{ x: 800 }}
              />
            </Card>
          </Tabs.TabPane>

          {/* ===== Tab Gastos ===== */}
          <Tabs.TabPane tab="Reporte de gastos" key="gastos">
            <Card size="small" style={{ marginBottom: 12 }}>
              <Row gutter={[12,12]} align="middle">
                <Col xs={24} md={6}>
                  <label>Periodo</label>
                  <Select
                    style={{ width:'100%' }}
                    value={filtrosG.periodo}
                    onChange={(v)=>{
                      setFiltrosG(prev => ({ ...prev, periodo: v }));
                      debouncedFetch('periodo', { periodo: v }, 250);
                    }}
                    options={periodOptions}
                  />
                </Col>

                <Col xs={24} md={6}>
                  <label>Año</label>
                  <Input
                    type="number"
                    value={filtrosG.anio}
                    min={2000}
                    max={2100}
                    onChange={(e)=>{
                      const val = Number(e.target.value||0);
                      setFiltrosG(prev => ({ ...prev, anio: val }));
                      debouncedFetch('anio', { anio: val }, 350);
                    }}
                    onPressEnter={()=>fetchGastos()}
                  />
                </Col>

                {showMes && (
                  <Col xs={24} md={6}>
                    <label>Mes</label>
                    <Select
                      style={{ width:'100%' }}
                      value={filtrosG.mes}
                      onChange={(v)=>{
                        const val = Number(v);
                        setFiltrosG(prev => ({ ...prev, mes: val }));
                        debouncedFetch('mes', { mes: val }, 250);
                      }}
                      options={monthOptions}
                    />
                  </Col>
                )}

                {showQuincena && (
                  <Col xs={24} md={6}>
                    <label>Quincena</label>
                    <Select
                      style={{ width:'100%' }}
                      value={filtrosG.quincena}
                      onChange={(v)=>{
                        const val = Number(v);
                        setFiltrosG(prev => ({ ...prev, quincena: val }));
                        debouncedFetch('quincena', { quincena: val }, 250);
                      }}
                      options={[
                        { label:'1 (1–15)', value:1 },
                        { label:'2 (16–fin de mes)', value:2 },
                      ]}
                    />
                  </Col>
                )}

                {showFechaRef && (
                  <Col xs={24} md={6}>
                    <label>Fecha</label>
                    <Input
                      type="date"
                      value={filtrosG.fechaRef}
                      onChange={(e)=>{
                        const val = e.target.value;
                        setFiltrosG(prev => ({ ...prev, fechaRef: val }));
                        debouncedFetch('fechaRef', { fechaRef: val }, 300);
                      }}
                      onPressEnter={()=>fetchGastos()}
                    />
                  </Col>
                )}

                <Col xs={24} md={8}>
                  <label>Sucursal</label>
                  <Select
                    allowClear
                    style={{ width:'100%' }}
                    placeholder="(todas)"
                    value={filtrosG.nombreSucursal || undefined}
                    onChange={(v)=>{
                      const val = v || '';
                      setFiltrosG(prev => ({ ...prev, nombreSucursal: val }));
                      // aplica automáticamente
                      debouncedFetch('sucursal', { nombreSucursal: val }, 200);
                    }}
                    options={[
                      { label: '(todas)', value: '' },
                      ...sucursales.map(s => ({ label: s, value: s }))
                    ]}
                  />
                </Col>

                <Col xs={24} md={10}>
                  <label>Buscar</label>
                  <Input
                    placeholder="categoría, proveedor, método, descripción…"
                    value={filtrosG.q}
                    onChange={(e)=>{
                      const val = e.target.value;
                      setFiltrosG(prev => ({ ...prev, q: val }));
                      debouncedFetch('q', { q: val }, 500);
                    }}
                    onPressEnter={()=>fetchGastos()}
                  />
                </Col>

                <Col xs={24}>
                  <Space>
                    <Button type="primary" onClick={()=>fetchGastos()} loading={loadingGastos}>
                      Actualizar
                    </Button>
                    <Button
                      onClick={()=>{
                        const rows = gastos || [];
                        if (!rows.length){ message.info('No hay datos para exportar'); return; }
                        const cols = ['id','fecha','categoria','descripcion','monto','metodoPago','proveedor','nombreSucursal','comprobanteURL'];
                        const csv = [cols.join(',')].concat(
                          rows.map(r => cols.map(k=>{
                            const val = (r[k]==null? '' : String(r[k]).replace(/"/g,'""'));
                            return `"${val}"`;
                          }).join(','))
                        ).join('\n');
                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `reporte_gastos_${filtrosG.periodo}_${filtrosG.anio||'all'}.csv`;
                        a.click();
                        URL.revokeObjectURL(url);
                      }}
                    >
                      Exportar CSV
                    </Button>
                  </Space>
                </Col>
              </Row>
            </Card>

            <Row gutter={[12,12]}>
              {KPIsG.map(k => (
                <Col xs={24} md={8} key={k.label}>
                  <Card size="small">
                    <Statistic title={k.label} value={k.value} />
                  </Card>
                </Col>
              ))}
            </Row>

            <Card size="small" style={{ marginTop: 12 }}>
              <Table
                size="middle"
                rowKey={function(r,i){ return r && r.id ? `rg-${r.id}` : `rg-${i}`; }}
                loading={loadingGastos}
                dataSource={gastos}
                columns={colsGastos}
                pagination={{ pageSize: 10, showSizeChanger:true }}
                scroll={{ x: 1000 }}
              />
            </Card>
          </Tabs.TabPane>
        </Tabs>
      </div>
    );
  }

  ReactDOM.render(<Reportes />, document.getElementById('ReportesView'));
</script>
