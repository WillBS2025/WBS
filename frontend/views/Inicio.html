//<script type="text/jsx">
function Inicio() {
  const { useState, useEffect } = React;
  const { Card, Row, Col, Space, Select, Button, Table, Tag, Statistic } = antd;

  const [loading, setLoading] = useState(false);
  const [refreshMs, setRefreshMs] = useState(60000);
  const [lastUpdated, setLastUpdated] = useState(null);
  const [productos, setProductos] = useState([]);
  const [empleados, setEmpleados] = useState([]);
  const [gastos, setGastos] = useState([]);
  const [compras, setCompras] = useState([]);
  const [sucursales, setSucursales] = useState([]);
  const [ventas, setVentas] = useState([]);
  const [ventaFiltro, setVentaFiltro] = useState('semana');

  function safeParse(x){ try{ return (typeof x==='string')? JSON.parse(x) : x; }catch(_){ return x; } }
  function formatHNL(n){ n = Number(n)||0; try{ return new Intl.NumberFormat('es-HN',{style:'currency',currency:'HNL',maximumFractionDigits:2}).format(n);}catch(_){return 'L. '+(Math.round(n*100)/100).toFixed(2);} }
  function thisMonthFilter(){ const d=new Date(); return { mes:d.getMonth()+1, anio:d.getFullYear() }; }
  function fechaOf(v){ const k=v.fecha||v.fechaVenta||v.fecha_venta||v.fechaCierre||v.createdAt||v.actualizado; if(!k) return null; const d=new Date(k); return isNaN(d)?null:d; }
  function estadoOf(v){ return String(v.estado||v.estatus||'').toLowerCase(); }
  function vendedorOf(v){ return String(v.vendedor||v.empleado||v.nombre_empleado||v.usuario||v.creadoPor||''); }
  function sucursalOf(v){ return String(v.nombreSucursal||v.sucursal||''); }
  function clienteOf(v){ return String(v.cliente||v.nombre_cliente||''); }
  function montoOf(v){ return Number(v.monto||v.total||v.totalVenta||v.montoTotal||0); }
  function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  function sameYMD(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }

  function gsCall(name, args){
    return new Promise(resolve=>{
      try{
        google.script.run
          .withSuccessHandler(res=>resolve({ok:true,data:res}))
          .withFailureHandler(()=>resolve({ok:false}))
          [name].apply(google.script.run, args||[]);
      }catch(_){ resolve({ok:false}); }
    });
  }
  async function callFirst(candidates){
    for (let i=0;i<candidates.length;i++){
      const {fn,args} = candidates[i];
      const r = await gsCall(fn, args);
      if (r.ok) return safeParse(r.data);
    }
    return [];
  }

  function loadProductos(){ return new Promise(resolve=>{ google.script.run.withSuccessHandler(res=>resolve(safeParse(res)||[])).withFailureHandler(()=>resolve([])).listarProductos(); }); }
  function loadEmpleados(){ return new Promise(resolve=>{ google.script.run.withSuccessHandler(res=>resolve(safeParse(res)||[])).withFailureHandler(()=>resolve([])).listarEmpleados(); }); }
  function loadGastos(){ const filtros=thisMonthFilter(); return new Promise(resolve=>{ google.script.run.withSuccessHandler(res=>resolve(safeParse(res)||[])).withFailureHandler(()=>resolve([])).listarGastos(JSON.stringify(filtros)); }); }
  function loadCompras(){ return new Promise(resolve=>{ google.script.run.withSuccessHandler(res=>resolve(safeParse(res)||[])).withFailureHandler(()=>resolve([])).listarComprasSuministros(); }); }

  async function loadSucursales(){
    const data = await callFirst([
      { fn:'sucursales_listar_activas' },
      { fn:'listarSucursalesActivas' },
      { fn:'sucursales_listar' },
      { fn:'listarSucursales' }
    ]);
    if (Array.isArray(data)) return data.filter(x=>String((x.estado||'')).toLowerCase().includes('activo'));
    if (data && data.ok && Array.isArray(data.sucursales)) return data.sucursales;
    return [];
  }

  async function loadVentas(){
    const base = await callFirst([
      { fn:'listarVentasPorPeriodo', args:[ventaFiltro] },
      { fn:'ventas_listar_por_periodo', args:[ventaFiltro] },
      { fn:'ventas_listar' },
      { fn:'listarVentas' },
      { fn:'listarVentasCerradas' },
      { fn:'ventas_listar_cerradas' }
    ]);
    return Array.isArray(base) ? base : [];
  }

  function refreshAll(){
    setLoading(true);
    Promise.all([loadProductos(),loadEmpleados(),loadGastos(),loadCompras(),loadSucursales(),loadVentas()]).then(([p,e,g,c,s,v])=>{
      setProductos(Array.isArray(p)?p:[]);
      setEmpleados(Array.isArray(e)?e:[]);
      setGastos(Array.isArray(g)?g:[]);
      setCompras(Array.isArray(c)?c:[]);
      setSucursales(Array.isArray(s)?s:[]);
      setVentas(Array.isArray(v)?v:[]);
      setLastUpdated(new Date());
    }).finally(()=>setLoading(false));
  }

  useEffect(()=>{ refreshAll(); },[]);
  useEffect(()=>{ if(!refreshMs) return; const t=setInterval(refreshAll, refreshMs); return ()=>clearInterval(t); },[refreshMs]);
  useEffect(()=>{ loadVentas().then(v=>setVentas(v)); },[ventaFiltro]);

  const totalProductos = productos.length;
  const totalStock = productos.reduce((a,r)=>a+Number(r.stock||0),0);
  const lowStock = [...productos].sort((a,b)=>Number(a.stock||0)-Number(b.stock||0)).slice(0,5);
  const empleadosActivos = empleados.filter(x=>String(x.estado||'').toLowerCase().includes('activo')).length;
  const proximosCumples = empleados.map(x=>{ const d=x.fecha_nacimiento?new Date(x.fecha_nacimiento):null; if(!d||isNaN(d))return null; const hoy=startOfDay(new Date()); const prox=new Date(hoy.getFullYear(),d.getMonth(),d.getDate()); if(prox<hoy) prox.setFullYear(prox.getFullYear()+1); const dias=Math.round((prox-hoy)/86400000); return { nombre:x.nombre_empleado, nombreSucursal:x.nombreSucursal, enDias:dias }; }).filter(Boolean).sort((a,b)=>a.enDias-b.enDias).slice(0,5);
  const totalGastosMes = gastos.reduce((a,r)=>a+Number(r.monto||0),0);
  const gastosRecientes = [...gastos].sort((a,b)=>{ const da=new Date(a.fecha), db=new Date(b.fecha); return db-da; }).slice(0,6);
  const totalSucursalesActivas = sucursales.length;
  function estadoLote(r){ const ini=r&&r.fechaInicioUso; const fin=r&&r.fechaFinUso; if(ini&&!fin)return'EN_USO'; if(ini&&fin)return'COMPLETADO'; return'NUEVO'; }
  const comprasEstado = compras.reduce((acc,r)=>{ const e=estadoLote(r); acc[e]=(acc[e]||0)+1; return acc; },{NUEVO:0,EN_USO:0,COMPLETADO:0});

  const hoy = startOfDay(new Date());
  const hace7 = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate() - 6);
  const ventasCerradas = ventas.filter(v=> estadoOf(v)==='' || estadoOf(v)==='cerrada' || estadoOf(v)==='cerrado' || estadoOf(v)==='pagada' || estadoOf(v)==='pagado');
  const ventasHoy = ventasCerradas.filter(v=>{ const d=fechaOf(v); return d && sameYMD(d,hoy); });
  const ventasSemana = ventasCerradas.filter(v=>{ const d=fechaOf(v); return d && d>=hace7 && d<=new Date(hoy.getFullYear(),hoy.getMonth(),hoy.getDate(),23,59,59,999); });
  const montoHoy = ventasHoy.reduce((a,v)=>a+montoOf(v),0);
  const montoSemana = ventasSemana.reduce((a,v)=>a+montoOf(v),0);
  const porEmpleado = {};
  ventasCerradas.forEach(v=>{ const d=fechaOf(v); if(!d) return; const key=vendedorOf(v)||'Sin asignar'; if(!porEmpleado[key]) porEmpleado[key]={ empleado:key, hoy:0, semana:0 }; if(sameYMD(d,hoy)) porEmpleado[key].hoy+=1; if(d>=hace7 && d<=new Date(hoy.getFullYear(),hoy.getMonth(),hoy.getDate(),23,59,59,999)) porEmpleado[key].semana+=1; });
  const actividadEmpleados = Object.values(porEmpleado).sort((a,b)=> b.hoy - a.hoy || b.semana - a.semana).slice(0,12);
  const ventasTabla = (ventaFiltro==='dia'? ventasHoy : ventasSemana).slice(0,10).map((v,i)=>({ key:i, fecha:fechaOf(v), empleado:vendedorOf(v), monto:montoOf(v), sucursal:sucursalOf(v), cliente:clienteOf(v) }));

  const colsLowStock = [
    { title:'Producto', dataIndex:'nombreProducto', key:'nombreProducto' },
    { title:'Stock', dataIndex:'stock', key:'stock', align:'right', width:90 },
    { title:'Sucursal', dataIndex:'nombreSucursal', key:'nombreSucursal', width:180 }
  ];
  const colsGastosRecientes = [
    { title:'Fecha', dataIndex:'fecha', key:'fecha', width:110, render:v=>{ try{ const d=new Date(v); const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); return dd+'/'+mm+'/'+d.getFullYear(); }catch(_){ return ''; } } },
    { title:'Categoría', dataIndex:'categoria', key:'categoria', width:140, render:v=><Tag color="blue">{v||'-'}</Tag> },
    { title:'Descripción', dataIndex:'descripcion', key:'descripcion' },
    { title:'Monto', dataIndex:'monto', key:'monto', align:'right', width:120, render:v=><b>{formatHNL(v)}</b> },
    { title:'Sucursal', dataIndex:'nombreSucursal', key:'nombreSucursal', width:160 }
  ];
  const colsCumples = [
    { title:'Empleado', dataIndex:'nombre', key:'nombre' },
    { title:'Sucursal', dataIndex:'nombreSucursal', key:'nombreSucursal', width:160 },
    { title:'En', dataIndex:'enDias', key:'enDias', width:80, render:v=>(v===0?'Hoy':(v+' días')) }
  ];
  const colsVentas = [
    { title:'Fecha', dataIndex:'fecha', key:'fecha', width:110, render:v=>{ if(!v) return ''; const d=v; const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); return dd+'/'+mm+'/'+d.getFullYear(); } },
    { title:'Empleado', dataIndex:'empleado', key:'empleado' },
    { title:'Monto', dataIndex:'monto', key:'monto', align:'right', width:120, render:v=><b>{formatHNL(v)}</b> }
  ];
  const colsActividad = [
    { title:'Empleado', dataIndex:'empleado', key:'empleado' },
    { title:'Hoy', dataIndex:'hoy', key:'hoy', width:90, align:'right' },
    { title:'Semana', dataIndex:'semana', key:'semana', width:110, align:'right' }
  ];

  return (
    <div className="inicio-wrap">
      <style>
        {`
          .grid-gap { margin-top:12px }
          .tile { border-radius:16px; overflow:hidden; box-shadow: 0 6px 18px rgba(0,0,0,.06); transition: transform .2s ease, box-shadow .2s ease; }
          .tile:hover { transform: translateY(-2px); box-shadow: 0 10px 24px rgba(0,0,0,.10); }
          .tone-blue .ant-card-body { background: linear-gradient(180deg,#e6f4ff, #ffffff); }
          .tone-green .ant-card-body { background: linear-gradient(180deg,#f6ffed, #ffffff); }
          .tone-purple .ant-card-body { background: linear-gradient(180deg,#f9f0ff, #ffffff); }
          .tone-amber .ant-card-body { background: linear-gradient(180deg,#fff7e6, #ffffff); }
          .kpi .ant-statistic-title { color:#64748b }
          .kpi .ant-statistic-content { font-weight:700 }
          .equal { min-height: 320px }
          .equal-sm { min-height: 300px }
          .tight .ant-card-head { margin:0; padding:12px 16px }
          .tight .ant-card-body { padding:12px 16px }
        `}
      </style>

      <Row justify="space-between" align="middle" style={{ marginBottom: 8 }}>
        <Col>
          <Space>
            <icons.DashboardOutlined />
            <h2 style={{ margin: 0 }}>Resumen general</h2>
          </Space>
          <div style={{ fontSize:12, color:'#888' }}>{lastUpdated ? ('Actualizado: ' + lastUpdated.toLocaleString()) : '—'}</div>
        </Col>
        <Col>
          <Space>
            <Select value={String(refreshMs)} onChange={v=>setRefreshMs(Number(v))} style={{ width: 180 }} options={[
              { value:'0', label:'Auto-actualizar: Apagado' },
              { value:'30000', label:'Cada 30s' },
              { value:'60000', label:'Cada 1 min' },
              { value:'300000', label:'Cada 5 min' }
            ]}/>
            <Button onClick={refreshAll} loading={loading} icon={<icons.ReloadOutlined />}>Refrescar</Button>
          </Space>
        </Col>
      </Row>

      <Row gutter={[12,12]}>
        <Col xs={24} md={12} lg={6}>
          <Card className="tile tone-amber kpi tight"><Statistic title="Gastos del mes" value={formatHNL(totalGastosMes)} /></Card>
        </Col>
        <Col xs={24} md={12} lg={6}>
          <Card className="tile tone-blue kpi tight"><Statistic title="Productos activos" value={totalProductos} /><div style={{ color:'#888', fontSize:12 }}>Stock total: <b>{totalStock}</b></div></Card>
        </Col>
        <Col xs={24} md={12} lg={6}>
          <Card className="tile tone-green kpi tight"><Statistic title="Sucursales activas" value={totalSucursalesActivas} /><div style={{ color:'#888', fontSize:12 }}>Empleados activos: <b>{empleadosActivos}</b></div></Card>
        </Col>
        <Col xs={24} md={12} lg={6}>
          <Card className="tile tone-purple kpi tight">
            <Row align="middle" justify="space-between">
              <Col><Statistic title={ventaFiltro==='dia'?'Ventas de hoy':'Ventas 7 días'} value={ventaFiltro==='dia'? formatHNL(montoHoy) : formatHNL(montoSemana)} /></Col>
              <Col>
                <Select size="small" value={ventaFiltro} onChange={setVentaFiltro} style={{ width:120 }} options={[
                  { value:'dia', label:'Hoy' },
                  { value:'semana', label:'7 días' }
                ]}/>
              </Col>
            </Row>
          </Card>
        </Col>
      </Row>

      <Row gutter={[12,12]} className="grid-gap">
        <Col xs={24} lg={12}>
          <Card title="Productos con bajo stock (Top 5)" className="tile tight equal-sm">
            <Table size="small" dataSource={lowStock} columns={colsLowStock} rowKey={r=>(r&&r.id!=null)?r.id:r.key} pagination={false}/>
          </Card>
        </Col>
        <Col xs={24} lg={12}>
          <Card title="Gastos recientes" className="tile tight equal-sm">
            <Table size="small" dataSource={gastosRecientes} columns={colsGastosRecientes} rowKey={r=>(r&&r.id!=null)?r.id:r.key} pagination={false}/>
          </Card>
        </Col>
      </Row>

      <Row gutter={[12,12]} className="grid-gap">
        <Col xs={24} lg={12}>
          <Card title="Próximos cumpleaños (Top 5)" className="tile tight equal-sm">
            <Table size="small" dataSource={proximosCumples} columns={colsCumples} rowKey={(r,i)=>i} pagination={false}/>
          </Card>
        </Col>
        <Col xs={24} lg={12}>
          <Card title="Estado de compras / suministros" className="tile tight equal-sm">
            <Row gutter={[12,12]}>
              <Col span={8}><Card size="small" className="tile tight"><b>Nuevos</b><div style={{fontSize:22}}>{comprasEstado.NUEVO||0}</div></Card></Col>
              <Col span={8}><Card size="small" className="tile tight"><b>En uso</b><div style={{fontSize:22}}>{comprasEstado.EN_USO||0}</div></Card></Col>
              <Col span={8}><Card size="small" className="tile tight"><b>Completados</b><div style={{fontSize:22}}>{comprasEstado.COMPLETADO||0}</div></Card></Col>
            </Row>
            <div style={{ color:'#888', fontSize:12, marginTop:6 }}>* Basado en fechas de inicio/fin de uso de cada lote.</div>
          </Card>
        </Col>
      </Row>

      <Row gutter={[12,12]} className="grid-gap">
        <Col xs={24} lg={12}>
          <Card title={ventaFiltro==='dia'?'Ventas cerradas de hoy':'Ventas cerradas 7 días'} className="tile tight equal">
            <Table size="small" dataSource={ventasTabla} columns={colsVentas} pagination={false}/>
          </Card>
        </Col>
        <Col xs={24} lg={12}>
          <Card title="Actividad por empleado" className="tile tight equal">
            <Table size="small" dataSource={actividadEmpleados} columns={colsActividad} pagination={false} rowKey="empleado"/>
          </Card>
        </Col>
      </Row>
    </div>
  );
}
//</script>
