<script type="text/jsx">
function Suministros() {
  const { useState, useEffect, useRef } = React;
  const { Table, Card, Button, Modal, Form, Input, InputNumber, Select, Space, Row, Col, Divider, Tag, Tabs, message } = antd;

  /********************* ESTADO *********************/
  const [suministros, setSuministros] = useState([]); // catálogo
  const [compras, setCompras] = useState([]);         // lotes
  const [loading, setLoading] = useState(false);

  // filtros (para lotes)
  const [q, setQ] = useState('');
  const [fSucursal, setFSucursal] = useState(undefined);
  const [fEstado, setFEstado] = useState(undefined);
  const [fMes, setFMes] = useState(''); // NUEVO: filtro por mes (YYYY-MM)

  // ******************* FILTROS PARA CATÁLOGO *******************
  const [qCat, setQCat] = useState('');
  const [fCatCategoria, setFCatCategoria] = useState();
  const [fCatUnidadBase, setFCatUnidadBase] = useState();
  const [fCatConsumo, setFCatConsumo] = useState();

  // sucursales
  const [sucursales, setSucursales] = useState([]);

  // modal crear compra
  const [form] = Form.useForm();
  const [modalOpen, setModalOpen] = useState(false);

  // modal editar compra
  const [editOpen, setEditOpen] = useState(false);
  const [editRecord, setEditRecord] = useState(null);
  const [editForm] = Form.useForm();

  // MODALES DE SUMINISTRO
  const [sumForm] = Form.useForm();        // NUEVO SUMINISTRO
  const [sumOpen, setSumOpen] = useState(false);
  const [selectNewInCompra, setSelectNewInCompra] = useState(false);

  const [sumEditForm] = Form.useForm();    // EDITAR SUMINISTRO
  const [sumEditOpen, setSumEditOpen] = useState(false);
  const [sumEditRecord, setSumEditRecord] = useState(null);

  /********************* HELPERS *********************/
  function safeParse(res) {
    try { return (typeof res === 'string') ? JSON.parse(res) : res; }
    catch(e){ return res; }
  }
  function toArray(x){ return Array.isArray(x) ? x : []; }

  function pickArrayPayload(x) {
    if (Array.isArray(x)) return x;
    if (x && Array.isArray(x.data)) return x.data;
    if (x && Array.isArray(x.rows)) return x.rows;
    if (x && Array.isArray(x.values)) return x.values;
    if (x && Array.isArray(x.suministros)) return x.suministros;
    if (x && Array.isArray(x.compras)) return x.compras;
    return [];
  }

  // === PATCH FECHAS (UI) ===
  function isYMD(str){ return typeof str === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(str); }
  /** Si es 'YYYY-MM-DD' -> Date local fija (sin shift); si no, intenta new Date() */
  function parseYMD(d) {
    if (!d) return null;
    if (isYMD(d)) { var p = d.split('-'); return new Date(+p[0], +p[1]-1, +p[2]); }
    var dt = new Date(d);
    return isNaN(dt) ? null : dt;
  }
  /** Mostrar bonita YYYY/MM/DD a partir de Date local */
  function formatNice(d){
    if (!d) return '';
    var dt = parseYMD(d);
    if (!dt) return String(d);
    var y = dt.getFullYear(), m = String(dt.getMonth()+1).padStart(2,'0'), day = String(dt.getDate()).padStart(2,'0');
    return y + '/' + m + '/' + day;
  }
  function formatHNL(value) {
    var n = Number(value); if (!isFinite(n)) n = 0;
    try { return 'L.' + new Intl.NumberFormat('en-US',{ minimumFractionDigits:2, maximumFractionDigits:2 }).format(n); }
    catch(e){ return 'L.' + n.toFixed(2); }
  }
  function diffDaysInclusive(a, b) {
    var da = parseYMD(a), db = parseYMD(b);
    if (!da || !db) return null;
    var ms = db.getTime() - da.getTime();
    return Math.floor(ms/86400000) + 1;
  }
  function estadoLote(r){
    var ini = r && r.fechaInicioUso;
    var fin = r && r.fechaFinUso;
    if (ini && !fin) return 'EN_USO';
    if (ini && fin) return 'COMPLETADO';
    return 'NUEVO';
  }
  function consumoDiarioCalc(cantidad, duracion){
    var cant = Number(cantidad || 0);
    var d = Number(duracion || 0);
    if (!d) return null;
    return cant / d;
  }
  /** Para inputs <input type="date"> */
  function asInputYMD(d){
    if (!d) return '';
    if (isYMD(d)) return d;
    var dt = parseYMD(d); if (!dt) return '';
    var y = dt.getFullYear(), m = String(dt.getMonth()+1).padStart(2,'0'), day = String(dt.getDate()).padStart(2,'0');
    return y + '-' + m + '-' + day;
  }
  function todayYMD(){
    var dt = new Date();
    var y = dt.getFullYear(), m = String(dt.getMonth()+1).padStart(2,'0'), day = String(dt.getDate()).padStart(2,'0');
    return y + '-' + m + '-' + day;
  }
  function extractNumericFromUnidadBase(txt){
    var s = String(txt == null ? '' : txt);
    var m = s.match(/(\d+(\.\d+)?)/);
    if (!m) return null;
    var v = Number(m[1]);
    return isFinite(v) ? v : null;
  }

  // NUEVO: helpers para clave de mes (YYYY-MM) con parse seguro
  function monthKeyFromDate(d){
    if (!d) return '';
    var dt = parseYMD(d);
    if (!dt) return '';
    return dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0');
  }
  function currentMonthKey(){
    var dt = new Date();
    return dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0');
  }

  /********************* NORMALIZADORES *********************/
  function normalizeSuministros(raw) {
    var parsed = safeParse(raw);
    var data = pickArrayPayload(parsed);
    if (!Array.isArray(data)) return [];
    if (data.length && typeof data[0] === 'object' && !Array.isArray(data[0])) return data;

    var rows = data;
    if (!rows.length) return [];
    if (Array.isArray(rows[0])) {
      var lower = rows[0].map(function(x){ return String(x||'').trim().toLowerCase(); });
      var hasHeader = lower.indexOf('idsuministro') >= 0 && lower.indexOf('nombresuministro') >= 0;
      if (hasHeader) {
        var headers = rows[0], body = rows.slice(1);
        function idx(h){ var i = headers.indexOf(h); return (i>=0? i : -1); }
        return body.map(function(r, i){
          var id = r[idx('idSuministro')];
          return {
            idSuministro: id,
            nombreSuministro: r[idx('nombreSuministro')],
            unidadBase: r[idx('unidadBase')],
            categoria: r[idx('categoria')],
            minStock: r[idx('minStock')],
            estado: r[idx('estado')],
            notas: r[idx('notas')],
            key: (id != null ? id : i)
          };
        });
      }
    }
    return rows.map(function(r, i){
      var id = r[0];
      return {
        idSuministro: r[0],
        nombreSuministro: r[1],
        unidadBase: r[2],
        categoria: r[3],
        minStock: r[4],
        estado: r[5],
        notas: r[6],
        key: (id != null ? id : i)
      };
    });
  }

  function normalizeCompras(raw) {
    var parsed = safeParse(raw);
    var data = pickArrayPayload(parsed);
    if (!Array.isArray(data)) return [];
    if (data.length && typeof data[0] === 'object' && !Array.isArray(data[0])) return data;

    var rows = data;
    if (!rows.length) return [];
    if (Array.isArray(rows[0])) {
      var lower = rows[0].map(function(x){ return String(x||'').trim().toLowerCase(); });
      var hasHeader = lower.indexOf('idcompra') >= 0 && lower.indexOf('idsuministro') >= 0;
      if (hasHeader) {
        var headers = rows[0], body = rows.slice(1);
        function idx(h){ var i = headers.indexOf(h); return (i>=0? i : -1); }
        return body.map(function(r, i){
          var id = r[idx('idCompra')];
          return {
            idCompra: id,
            idSuministro: r[idx('idSuministro')],
            sucursal: r[idx('sucursal')],
            fechaCompra: r[idx('fechaCompra')],
            cantidadUnidades: r[idx('cantidadUnidades')],
            costoTotal: r[idx('costoTotal')],
            fechaInicioUso: r[idx('fechaInicioUso')],
            fechaFinUso: r[idx('fechaFinUso')],
            observaciones: r[idx('observaciones')],
            duracionDias: null, consumoDiario: null, estado: null,
            key: (id != null ? id : i)
          };
        });
      }
    }
    return rows.map(function(r, i){
      var id = r[0];
      return {
        idCompra: r[0],
        idSuministro: r[1],
        sucursal: r[2],
        fechaCompra: r[3],
        cantidadUnidades: r[4],
        costoTotal: r[5],
        fechaInicioUso: r[6],
        fechaFinUso: r[7],
        observaciones: r[8],
        duracionDias: null, consumoDiario: null, estado: null,
        key: (id != null ? id : i)
      };
    });
  }

  /********************* CARGA INICIAL *********************/
  function cargarTodo() {
    setLoading(true);
    var alive = true; var pending = 3;
    function done(){ pending -= 1; if (alive && pending <= 0) setLoading(false); }

    google.script.run
      .withSuccessHandler(function(res){ if (!alive) return; setSuministros(normalizeSuministros(res)); done(); })
      .withFailureHandler(function(){ if (!alive) return; setSuministros([]); done(); })
      .listarSuministros();

    google.script.run
      .withSuccessHandler(function(res){ if (!alive) return; setCompras(normalizeCompras(res)); done(); })
      .withFailureHandler(function(){ if (!alive) return; setCompras([]); done(); })
      .listarComprasSuministros();

    google.script.run
      .withSuccessHandler(function(res){
        if (!alive) return;
        var r = safeParse(res);
        var arr = Array.isArray(r) ? r : (r && r.ok && Array.isArray(r.sucursales) ? r.sucursales : []);
        setSucursales(arr);
        done();
      })
      .withFailureHandler(function(){ if (!alive) return; setSucursales([]); done(); })
      .sucursales_listar_activas();

    return function cleanup(){ alive = false; };
  }
  useEffect(cargarTodo, []);

  /********************* MAPEOS / ESTADÍSTICAS *********************/
  var nombreById = {};
  var unidadBaseById = {};
  var unidadCapById = {};
  for (var i = 0; i < suministros.length; i++) {
    var s = suministros[i];
    nombreById[String(s.idSuministro)] = s.nombreSuministro;
    unidadBaseById[String(s.idSuministro)] = s.unidadBase;
    unidadCapById[String(s.idSuministro)] = extractNumericFromUnidadBase(s.unidadBase);
  }

  var comprasBySum = {};
  for (var j = 0; j < compras.length; j++) {
    var c = compras[j];
    var k = String(c.idSuministro);
    if (!comprasBySum[k]) comprasBySum[k] = [];
    comprasBySum[k].push(c);
  }
  function estadoConsumoDe(id) {
    var arr = comprasBySum[String(id)] || [];
    if (arr.some(function(x){ return x.fechaInicioUso && !x.fechaFinUso; })) return 'EN_USO';
    if (arr.some(function(x){ return !x.fechaInicioUso && !x.fechaFinUso; })) return 'NUEVO';
    if (arr.length > 0) return 'AGOTADO';
    return 'SIN_COMPRAS';
  }
  function ultimaCompraDe(id) {
    var arr = comprasBySum[String(id)] || [];
    var max = null;
    for (var i2 = 0; i2 < arr.length; i2++) {
      var d = parseYMD(arr[i2].fechaCompra);
      if (d && (!max || d > max)) max = d;
    }
    return max ? formatNice(max) : '';
  }
  var suministrosEnriquecidos = toArray(suministros).map(function(s){
    var k = String(s.idSuministro);
    return Object.assign({}, s, {
      consumoEstado: estadoConsumoDe(k),
      comprasCount: (comprasBySum[k] || []).length,
      ultimaCompra: ultimaCompraDe(k)
    });
  });

  /********************* FILTRO (LOTES) *********************/
  var filtered = toArray(compras).filter(function(c){
    var nom = (nombreById[String(c.idSuministro)] || '').toLowerCase();
    var okQ = q ? nom.indexOf(q.toLowerCase().trim()) >= 0 : true;
    var okS = fSucursal ? String(c.sucursal) === String(fSucursal) : true;
    var e = c.estado || estadoLote(c);
    var okE = fEstado ? String(e) === String(fEstado) : true;

    // NUEVO: filtro por mes (YYYY-MM) basado en fechaCompra
    var okM = true;
    if (fMes) okM = (monthKeyFromDate(c.fechaCompra) === fMes);

    return okQ && okS && okE && okM; // NUEVO: incluye okM
  });

  // OPCIONES PARA FILTROS DE CATÁLOGO
  var catCategorias = Array.from(new Set(toArray(suministros).map(function(s){ return s.categoria; }).filter(function(x){ return !!x; })));
  var catUnidades  = Array.from(new Set(toArray(suministros).map(function(s){ return s.unidadBase; }).filter(function(x){ return !!x; })));

  // FILTRADO DE CATÁLOGO
  var catalogoFiltered = toArray(suministrosEnriquecidos).filter(function(s){
    var okQ = qCat ? String(s.nombreSuministro || '').toLowerCase().indexOf(qCat.toLowerCase().trim()) >= 0 : true;
    var okC = fCatCategoria ? String(s.categoria) === String(fCatCategoria) : true;
    var okU = fCatUnidadBase ? String(s.unidadBase) === String(fCatUnidadBase) : true;
    var okE = fCatConsumo ? String(s.consumoEstado) === String(fCatConsumo) : true;
    return okQ && okC && okU && okE;
  });

  /********************* DASHBOARDS (KPIs) *********************/
  function sumBy(arr, pick){ var s = 0; for (var i=0;i<arr.length;i++) s += Number(pick(arr[i])||0); return s; }

  // Catálogo
  var kpiCat_total = catalogoFiltered.length;
  var kpiCat_enUso = catalogoFiltered.filter(function(s){ return s.consumoEstado === 'EN_USO'; }).length;
  var kpiCat_nuncaComprados = catalogoFiltered.filter(function(s){ return s.consumoEstado === 'SIN_COMPRAS'; }).length;

  // Compras
  var kpiCom_lotes = filtered.length;
  var kpiCom_gasto = sumBy(filtered, function(c){ return c.costoTotal; });
  var kpiCom_enUso = filtered.filter(function(c){ return (c.estado || estadoLote(c)) === 'EN_USO'; }).length;

  // KPI UI
  function useCountUp(value, duration=700){
    const [display, setDisplay] = useState(0);
    const prevRef = useRef(0);
    useEffect(()=>{
      const start = performance.now();
      const from = prevRef.current;
      const to = Number(value||0);
      let raf;
      function tick(t){
        const p = Math.min(1, (t - start)/duration);
        const eased = 1 - Math.pow(1 - p, 3);
        setDisplay(from + (to - from) * eased);
        if (p < 1) raf = requestAnimationFrame(tick);
      }
      raf = requestAnimationFrame(tick);
      prevRef.current = to;
      return ()=> cancelAnimationFrame(raf);
    }, [value, duration]);
    return display;
  }
  function KPI({ title, value, money }) {
    const v = useCountUp(value);
    return (
      <Card bodyStyle={{ padding: 14 }} className="sum-kpi fade-in">
        <div className="sum-kpi-sub">{title}</div>
        <div className="sum-kpi-val">{money ? formatHNL(v) : Math.round(Number(v))}</div>
      </Card>
    );
  }

  /********************* ACCIONES: COMPRAS *********************/
  function abrirNuevo(){ setSelectNewInCompra(false); form.resetFields(); setModalOpen(true); }

  function validateFechaNoFutura(_, value){
    if (!value) return Promise.resolve();
    var d = parseYMD(value), t = new Date();
    var today = new Date(t.getFullYear(), t.getMonth(), t.getDate());
    if (!d) return Promise.reject(new Error('Fecha inválida'));
    if (d > today) return Promise.reject(new Error('La fecha no puede ser futura'));
    return Promise.resolve();
  }
  function validateInicioVsCompra(getter, _rule, value){
    if (!value) return Promise.resolve();
    var fCompra = parseYMD(getter('fechaCompra'));
    var fInicio = parseYMD(value);
    var t = new Date(); var today = new Date(t.getFullYear(), t.getMonth(), t.getDate());
    if (!fInicio) return Promise.reject(new Error('Fecha inválida'));
    if (fInicio > today) return Promise.reject(new Error('La fecha no puede ser futura'));
    if (fCompra && fInicio < fCompra) return Promise.reject(new Error('El inicio no puede ser anterior a la compra'));
    return Promise.resolve();
  }
  function validateFinVsInicioCompra(getter, _rule, value){
    if (!value) return Promise.resolve();
    var fCompra = parseYMD(getter('fechaCompra'));
    var fInicio = parseYMD(getter('fechaInicioUso'));
    var fFin = parseYMD(value);
    var t = new Date(); var today = new Date(t.getFullYear(), t.getMonth(), t.getDate());
    if (!fFin) return Promise.reject(new Error('Fecha inválida'));
    if (fFin > today) return Promise.reject(new Error('La fecha no puede ser futura'));
    if (fCompra && fFin < fCompra) return Promise.reject(new Error('El fin no puede ser anterior a la compra'));
    if (fInicio && fFin < fInicio) return Promise.reject(new Error('El fin no puede ser anterior al inicio'));
    return Promise.resolve();
  }
  function validateCantidadVsUnidadBase(getter, _rule, value){
    if (value == null) return Promise.resolve();
    var id = getter('idSuministro');
    var cap = id != null ? unidadCapById[String(id)] : null;
    if (cap != null && Number(value) > Number(cap)) {
      return Promise.reject(new Error('La cantidad no puede ser mayor que ' + cap + ' (unidad base registrada).'));
    }
    return Promise.resolve();
  }

  function onSubmit(values){
    var payload = {
      idSuministro: values.idSuministro,
      sucursal: values.sucursal,
      fechaCompra: values.fechaCompra, // 'YYYY-MM-DD'
      cantidadUnidades: Number(values.cantidadUnidades || 0),
      costoTotal: Number(values.costoTotal || 0),
      fechaInicioUso: values.fechaInicioUso || '',
      observaciones: values.observaciones || ''
    };
    setLoading(true);
    google.script.run
      .withSuccessHandler(function(res){
        var r = safeParse(res);
        if (r && r.ok) { message.success('Compra registrada'); setModalOpen(false); cargarTodo(); }
        else { Modal.error({ title: 'No se pudo crear', content: (r && r.message) || 'Error desconocido' }); setLoading(false); }
      })
      .withFailureHandler(function(err){
        setLoading(false);
        Modal.error({ title:'Error de servidor', content:String((err && err.message) || err) });
      })
      .crearCompraSuministro(JSON.stringify(payload));
  }

  function abrirEditarCompra(r){
    setEditRecord(r);
    editForm.setFieldsValue({
      idCompra: r.idCompra,
      idSuministro: String(r.idSuministro),
      sucursal: r.sucursal || undefined,
      fechaCompra: asInputYMD(r.fechaCompra),
      cantidadUnidades: Number(r.cantidadUnidades || 0),
      costoTotal: Number(r.costoTotal || 0),
      fechaInicioUso: asInputYMD(r.fechaInicioUso),
      fechaFinUso: asInputYMD(r.fechaFinUso),
      observaciones: r.observaciones || ''
    });
    setEditOpen(true);
  }
  function onSubmitEdit(values){
    var payload = {
      idCompra: values.idCompra,
      idSuministro: values.idSuministro,
      sucursal: values.sucursal,
      fechaCompra: values.fechaCompra, // 'YYYY-MM-DD'
      cantidadUnidades: Number(values.cantidadUnidades || 0),
      costoTotal: Number(values.costoTotal || 0),
      fechaInicioUso: values.fechaInicioUso || '',
      fechaFinUso: values.fechaFinUso || '',
      observaciones: values.observaciones || ''
    };
    setLoading(true);
    google.script.run
      .withSuccessHandler(function(res){
        var r = (typeof res === 'string') ? JSON.parse(res) : res;
        if (r && r.ok){ message.success('Compra actualizada'); setEditOpen(false); setEditRecord(null); cargarTodo(); }
        else { Modal.error({ title:'No se pudo actualizar', content:(r && r.message) || 'Error' }); setLoading(false); }
      })
      .withFailureHandler(function(err){ setLoading(false); Modal.error({ title:'Error de servidor', content:String(err) }); })
      .actualizarCompraSuministro(JSON.stringify(payload));
  }
  function iniciarUso(idCompra){
    Modal.confirm({
      title:'Iniciar uso',
      content:'Se colocará la fecha de inicio en HOY.',
      onOk: function(){
        google.script.run
          .withSuccessHandler(function(res){
            var r = (typeof res === 'string') ? JSON.parse(res) : res;
            if (r && r.ok){ message.success('Lote en uso'); cargarTodo(); }
            else { Modal.error({ title:'No se pudo iniciar', content:(r && r.message) || 'Error' }); }
          })
          .withFailureHandler(function(err){ Modal.error({ title:'Error de servidor', content:String(err) }); })
          .iniciarUsoCompra(idCompra, todayYMD());
      }
    });
  }
  function marcarAgotado(record){
    Modal.confirm({
      title: 'Marcar lote como agotado',
      content: 'Se colocará la fecha de fin en HOY. ¿Confirmas?',
      okButtonProps:{ danger:true },
      onOk: function(){
        google.script.run
          .withSuccessHandler(function(res){
            var r = safeParse(res);
            if (r && r.ok){
              message.success('Lote marcado como agotado');
              cargarTodo();
            } else {
              Modal.error({ title:'No se pudo marcar', content:(r && r.message) || 'Error' });
            }
          })
          .withFailureHandler(function(err){
            Modal.error({ title:'Error de servidor', content:String((err && err.message) || err) });
          })
          .marcarCompraAgotada(record.idCompra);
      }
    });
  }

  /********************* ACCIONES: CATÁLOGO *********************/
  function abrirNuevoSuministro(desdeCompra){
    setSelectNewInCompra(!!desdeCompra);
    sumForm.resetFields();
    setSumOpen(true);
  }
  function onSubmitSuministro(values){
    var payload = {
      nombreSuministro: values.nombreSuministro,
      unidadBase: values.unidadBase || '',
      categoria: values.categoria || '',
      minStock: Number(values.minStock || 0),
      notas: values.notas || '',
      estado: 'Activo'
    };
    setLoading(true);
    google.script.run
      .withSuccessHandler(function(res){
        var r = safeParse(res);
        if (r && r.ok){
          message.success('Suministro creado');
          setSumOpen(false);
          cargarTodo();
          if (selectNewInCompra && r.idSuministro != null) {
            form.setFieldsValue({ idSuministro: String(r.idSuministro) });
            setModalOpen(true);
          }
        } else {
          Modal.error({ title:'No se pudo crear', content:(r && r.message) || 'Error' });
          setLoading(false);
        }
      })
      .withFailureHandler(function(err){
        setLoading(false);
        Modal.error({ title:'Error de servidor', content:String(err) });
      })
      .crearSuministro(JSON.stringify(payload));
  }

  function abrirEditarSuministro(rec){
    setSumEditRecord(rec);
    sumEditForm.setFieldsValue({
      idSuministro: rec.idSuministro,
      nombreSuministro: rec.nombreSuministro || '',
      unidadBase: rec.unidadBase || '',
      categoria: rec.categoria || '',
      minStock: Number(rec.minStock || 0),
      notas: rec.notas || '',
      estado: rec.estado || 'Activo'
    });
    setSumEditOpen(true);
  }
  function onSubmitSuministroEdit(values){
    var payload = {
      idSuministro: values.idSuministro,
      nombreSuministro: values.nombreSuministro,
      unidadBase: values.unidadBase || '',
      categoria: values.categoria || '',
      minStock: Number(values.minStock || 0),
      notas: values.notas || '',
      estado: values.estado || 'Activo'
    };
    setLoading(true);
    google.script.run
      .withSuccessHandler(function(res){
        var r = safeParse(res);
        if (r && r.ok){
          message.success('Suministro actualizado');
          setSumEditOpen(false);
          setSumEditRecord(null);
          cargarTodo();
        } else {
          Modal.error({ title:'No se pudo actualizar', content:(r && r.message) || 'Error' });
          setLoading(false);
        }
      })
      .withFailureHandler(function(err){
        setLoading(false);
        Modal.error({ title:'Error de servidor', content:String(err) });
      })
      .actualizarSuministro(JSON.stringify(payload));
  }

  /********************* COLUMNAS *********************/
  const columnsCompras = [
    { title:'No.', dataIndex:'idCompra', key:'idCompra', width:90,
      sorter:function(a,b){ return Number(a.idCompra)-Number(b.idCompra); } },

    { title:'Suministro', dataIndex:'idSuministro', key:'idSuministro', width:200,
      render:function(v){ return nombreById[String(v)] || ('#'+v); } },

    { title:'Sucursal', dataIndex:'sucursal', key:'sucursal', width:160,
      render:function(v){ return v ? <Tag color="geekblue">{v}</Tag> : ''; } },

    { title:'Fecha compra', dataIndex:'fechaCompra', key:'fechaCompra', width:130,
      render:function(v){ return formatNice(v); } },

    { title:'Cantidad (unidad base)', dataIndex:'cantidadUnidades', key:'cantidadUnidades', align:'right', width:170 },

    { title:'Costo total', dataIndex:'costoTotal', key:'costoTotal', align:'right', width:130,
      render:function(v){ return formatHNL(v); } },

    { title:'Inicio uso', dataIndex:'fechaInicioUso', key:'fechaInicioUso', width:130,
      render:function(v){ return formatNice(v); } },

    { title:'Fin uso', dataIndex:'fechaFinUso', key:'fechaFinUso', width:130,
      render:function(v){ return formatNice(v); } },

    { title:'Estado', dataIndex:'estado', key:'estado', width:120,
      render:function(v, r){
        var e = v || estadoLote(r);
        if (e === 'EN_USO') return <Tag color="gold">EN USO</Tag>;
        if (e === 'COMPLETADO') return <Tag color="green">COMPLETADO</Tag>;
        return <Tag>Nuevo</Tag>;
      }
    },

    { title:'Duración (días)', dataIndex:'duracionDias', key:'duracionDias', align:'right', width:140,
      render:function(_, r){
        var d = (r.duracionDias != null) ? r.duracionDias : diffDaysInclusive(r.fechaInicioUso, r.fechaFinUso);
        return d != null ? d : '';
      }
    },

    { title:'Consumo/día', dataIndex:'consumoDiario', key:'consumoDiario', align:'right', width:130,
      render:function(_, r){
        var d = (r.duracionDias != null) ? r.duracionDias : diffDaysInclusive(r.fechaInicioUso, r.fechaFinUso);
        var c = (r.consumoDiario != null) ? r.consumoDiario : consumoDiarioCalc(r.cantidadUnidades, d);
        return (c == null) ? '' : Number(c).toFixed(2);
      }
    },

    { title:'Acciones', key:'acciones', fixed:'right', width:280,
      render:function(_,r){
        var e = r.estado || estadoLote(r);
        if (e === 'COMPLETADO') return null;
        return (
          <Space wrap>
            <Button size="small" onClick={function(){ abrirEditarCompra(r); }}>Editar</Button>
            {e === 'NUEVO' && (
              <Button size="small" type="primary" onClick={function(){ iniciarUso(r.idCompra); }}>Iniciar uso</Button>
            )}
            {e === 'EN_USO' && (
              <Button size="small" danger onClick={function(){ marcarAgotado(r); }}>Marcar agotado</Button>
            )}
          </Space>
        );
      }
    }
  ];

  const columnsCatalogo = [
    { title:'No.', dataIndex:'idSuministro', key:'idSuministro', width:90,
      sorter:function(a,b){ return Number(a.idSuministro)-Number(b.idSuministro); } },
    { title:'Nombre', dataIndex:'nombreSuministro', key:'nombreSuministro' },

    // *** OCULTAR "UNIDAD BASE" EN TABLA (SIN ELIMINAR COLUMNA NI DATOS) ***
    { title:'Unidad base', dataIndex:'unidadBase', key:'unidadBase', width:0,
      onHeaderCell: function(){ return { style:{ display:'none' } }; },
      onCell: function(){ return { style:{ display:'none' } }; }
    },

    { title:'Categoría', dataIndex:'categoria', key:'categoria', width:140 },
    { title:'Min. stock', dataIndex:'minStock', key:'minStock', align:'right', width:0,
      onHeaderCell: function(){ return { style:{ display:'none' } }; },
      onCell: function(){ return { style:{ display:'none' } }; }
    },
    { title:'Estado (cat.)', dataIndex:'estado', key:'estado', width:0,
      render:function(v){ return <Tag color={v==='Activo'?'green':'default'}>{v||''}</Tag>; },
      onHeaderCell: function(){ return { style:{ display:'none' } }; },
      onCell: function(){ return { style:{ display:'none' } }; }
    },
    { title:'Consumo', dataIndex:'consumoEstado', key:'consumoEstado', width:130,
      render:function(v){
        if (v === 'EN_USO') return <Tag color="gold">EN USO</Tag>;
        if (v === 'NUEVO') return <Tag color="blue">NUEVO</Tag>;
        if (v === 'AGOTADO') return <Tag color="red">AGOTADO</Tag>;
        return <Tag>SIN COMPRAS</Tag>;
      }
    },
    { title:'Veces comprado', dataIndex:'comprasCount', key:'comprasCount', width:130, align:'right' },
    { title:'Última compra', dataIndex:'ultimaCompra', key:'ultimaCompra', width:130 },
    { title:'Acciones', key:'acciones', width:220,
      render:function(_, rec){
        return (
          <Space>
            <Button size="small" type="primary" onClick={function(){
              form.setFieldsValue({ idSuministro: String(rec.idSuministro) });
              setModalOpen(true);
            }}>
              Comprar
            </Button>
            <Button size="small" onClick={function(){ abrirEditarSuministro(rec); }}>
              Editar
            </Button>
          </Space>
        );
      }
    }
  ];

  // ====== OPCIONES ======
  var sucOptions = toArray(sucursales).map(function(s){ return { value:s.nombreSucursal, label:s.nombreSucursal }; });
  var sumOptions = toArray(suministros).map(function(s){ return { value:String(s.idSuministro), label:s.nombreSuministro }; });

  function resetFiltros(){
    setQ(''); setFSucursal(undefined); setFEstado(undefined); setFMes(''); // NUEVO: limpiar mes
  }
  function resetFiltrosCatalogo(){ setQCat(''); setFCatCategoria(undefined); setFCatUnidadBase(undefined); setFCatConsumo(undefined); }

  /********************* UI (Diseño estilo Sucursales) *********************/
  return (
    <div className="suministros-wrap">
      <Card
        title={<div className="sum-hero-title"><span className="sum-spark"></span>Suministros</div>}
        extra={
          <Space wrap>
            <Button onClick={cargarTodo} loading={loading} icon={<icons.ReloadOutlined />}>Refrescar</Button>
            <Button type="primary" onClick={function(){ abrirNuevoSuministro(false); }} icon={<icons.PlusOutlined />}>Nuevo suministro</Button>
            <Button onClick={abrirNuevo} icon={<icons.PlusOutlined />}>Registrar compra</Button>
          </Space>
        }
      >
        <style>{`
          .fade-in { animation: fadeIn .45s ease; }
          @keyframes fadeIn { from { opacity:.0; transform: translateY(4px) } to { opacity:1; transform: translateY(0) } }

          /* Hero título con spark */
          .sum-hero-title{ position:relative; padding-left:12px; font-weight:800; }
          .sum-spark{
            position:absolute; left:0; top:6px; width:6px; height:22px; border-radius:3px;
            background: linear-gradient(180deg,#60a5fa,#a78bfa,#34d399);
            animation: sumSpark 2.6s ease-in-out infinite;
          }
          @keyframes sumSpark{ 0%{opacity:.4; transform:translateY(0)} 50%{opacity:1; transform:translateY(6px)} 100%{opacity:.4; transform:translateY(0)} }

          /* KPIs estilo tiles */
          .sum-kpi{ border-radius:14px; background: linear-gradient(135deg,#e0eaff,#e9fff6); box-shadow: 0 2px 10px rgba(15,23,42,.06); }
          .sum-kpi-sub{ font-size:12px; color:#6b7280 }
          .sum-kpi-val{ font-size:26px; font-weight:800; color:#0f172a }

          /* Centrado de tablas y look pastel */
          .tbl-center { max-width: 1200px; margin: 0 auto; }
          .month-inline { display:flex; gap:8px; align-items:center; }

          .suministros-wrap .sum-table .ant-table{ border-radius:14px; overflow:hidden; }
          .suministros-wrap .sum-table .ant-table-thead > tr > th{
            background:#f8fafc !important; border-bottom:0; color:#334155; font-weight:700;
          }
          .suministros-wrap .sum-table .ant-table-tbody > tr{
            transition: transform .15s ease, box-shadow .15s ease, background .2s;
            animation: sumFadeUp .35s ease both;
          }
          @keyframes sumFadeUp{ from{ opacity:0; transform:translateY(6px) } to{ opacity:1; transform:translateY(0) } }
          .suministros-wrap .sum-table .ant-table-tbody > tr:hover{
            transform: scale(1.01); box-shadow: 0 10px 24px rgba(2,6,23,.08);
          }
          .suministros-wrap .sum-table .ant-table-tbody > tr:nth-child(odd) td{ background:#fcfdff; }

          /* Estado fila bloqueada */
          .suministros-wrap .row-bloqueado td{ background:#f9fafb !important; color:#64748B; }
        `}</style>

        <Tabs defaultActiveKey="catalogo">
          <Tabs.TabPane tab="Catálogo" key="catalogo">
            {/* === DASHBOARDS (Catálogo) === */}
            <Row gutter={[12,12]} style={{ marginBottom: 8 }}>
              <Col xs={24} sm={8}><KPI title="Total suministros" value={kpiCat_total} /></Col>
              <Col xs={24} sm={8}><KPI title="En uso" value={kpiCat_enUso} /></Col>
              <Col xs={24} sm={8}><KPI title="Nunca comprados" value={kpiCat_nuncaComprados} /></Col>
            </Row>

            {/* === FILTROS CATÁLOGO === */}
            <Row gutter={[12,12]} align="bottom" style={{ marginBottom: 12 }}>
              <Col xs={24} md={8}>
                <label style={{ display:'block', marginBottom:4 }}>Buscar por nombre</label>
                <Input
                  allowClear
                  placeholder="Papel higiénico, Café…"
                  value={qCat}
                  onChange={function(e){ setQCat(e.target.value); }}
                  addonAfter={<Button size="small" onClick={resetFiltrosCatalogo}>Limpiar</Button>}
                />
              </Col>
              <Col xs={12} md={5}>
                <label style={{ display:'block', marginBottom:4 }}>Categoría</label>
                <Select allowClear placeholder="Todas"
                        value={fCatCategoria} onChange={function(v){ setFCatCategoria(v); }}
                        style={{ width:'100%' }}
                        options={Array.from(new Set(catCategorias)).map(function(c){ return { value:c, label:c }; })} />
              </Col>
              <Col xs={12} md={5}>
                <label style={{ display:'block', marginBottom:4 }}>Unidad base</label>
                <Select allowClear placeholder="Todas"
                        value={fCatUnidadBase} onChange={function(v){ setFCatUnidadBase(v); }}
                        style={{ width:'100%' }}
                        options={Array.from(new Set(catUnidades)).map(function(u){ return { value:u, label:u }; })} />
              </Col>
              <Col xs={12} md={6}>
                <label style={{ display:'block', marginBottom:4 }}>Estado consumo</label>
                <Select allowClear placeholder="Todos"
                        value={fCatConsumo} onChange={function(v){ setFCatConsumo(v); }}
                        style={{ width:'100%' }}
                        options={[
                          { value:'NUEVO', label:'Nuevo' },
                          { value:'EN_USO', label:'En uso' },
                          { value:'AGOTADO', label:'Agotado' },
                          { value:'SIN_COMPRAS', label:'Sin compras' }
                        ]} />
              </Col>
            </Row>

            {/* === TABLA CATÁLOGO (CENTRADA) === */}
            <div className="tbl-center">
              <Table
                className="sum-table"
                dataSource={catalogoFiltered}
                columns={columnsCatalogo}
                loading={loading && compras.length===0}
                rowKey={function(r){ return r.idSuministro; }}
                scroll={{ x: true }}
                pagination={{ pageSize: 10 }}
              />
            </div>
          </Tabs.TabPane>

          <Tabs.TabPane tab="Compras" key="compras">
            {/* === DASHBOARDS (Compras) === */}
            <Row gutter={[12,12]} style={{ marginBottom: 8 }}>
              <Col xs={24} sm={8}><KPI title="Lotes (filtrados)" value={kpiCom_lotes} /></Col>
              <Col xs={24} sm={8}><KPI title="Gasto total" value={kpiCom_gasto} money /></Col>
              <Col xs={24} sm={8}><KPI title="Lotes en uso" value={kpiCom_enUso} /></Col>
            </Row>

            {/* === FILTROS COMPRAS === */}
            <Row gutter={[12,12]} align="bottom">
              <Col xs={24} md={8}>
                <label style={{ display:'block', marginBottom:4 }}>Buscar por suministro</label>
                <Input
                  allowClear
                  placeholder="Papel higiénico, café…"
                  value={q}
                  onChange={function(e){ setQ(e.target.value); }}
                  addonAfter={<Button size="small" onClick={resetFiltros}>Limpiar</Button>}
                />
              </Col>
              <Col xs={12} md={8}>
                <label style={{ display:'block', marginBottom:4 }}>Sucursal</label>
                <Select options={sucOptions} allowClear placeholder="Todas"
                        value={fSucursal} onChange={function(v){ setFSucursal(v); }} style={{ width:'100%' }} />
              </Col>
              <Col xs={12} md={8}>
                <label style={{ display:'block', marginBottom:4 }}>Estado</label>
                <Select allowClear placeholder="Todos" value={fEstado} onChange={function(v){ setFEstado(v); }}
                        style={{ width:'100%' }}
                        options={[
                          { value:'NUEVO', label:'Nuevo' },
                          { value:'EN_USO', label:'En uso' },
                          { value:'COMPLETADO', label:'Completado' }
                        ]}
                />
              </Col>
            </Row>

            {/* Filtro Mes */}
            <Row gutter={[12,12]} align="bottom" style={{ marginTop: 8 }}>
              <Col xs={24} md={8}>
                <label style={{ display:'block', marginBottom:4 }}>Mes</label>
                <div className="month-inline">
                  <Input type="month" value={fMes} onChange={function(e){ setFMes(e.target.value); }} />
                  <Button size="small" onClick={function(){ setFMes(''); }}>Todos</Button>
                  <Button size="small" onClick={function(){ setFMes(currentMonthKey()); }}>Este mes</Button>
                </div>
              </Col>
            </Row>

            <Divider style={{ margin:'12px 0' }} />

            {/* === TABLA COMPRAS (CENTRADA) === */}
            <div className="tbl-center">
              <Table
                className="sum-table"
                dataSource={filtered}
                columns={columnsCompras}
                loading={loading}
                rowKey={function(r){ return r.idCompra; }}
                scroll={{ x: true }}
                pagination={{ pageSize: 10 }}
                rowClassName={function(record){
                  var e = record.estado || estadoLote(record);
                  return e === 'COMPLETADO' ? 'row-bloqueado' : '';
                }}
              />
            </div>
          </Tabs.TabPane>
        </Tabs>

        {/* MODAL: NUEVA COMPRA */}
        <Modal
          centered
          title={<Space><icons.PlusOutlined /><span>Registrar compra</span></Space>}
          open={modalOpen} visible={modalOpen}
          onCancel={function(){ setModalOpen(false); }}
          onOk={function(){ form.submit(); }}
          okText="Guardar" cancelText="Cancelar"
          confirmLoading={loading}
          destroyOnClose maskClosable={false} keyboard={false}
        >
          <Form form={form} layout="vertical" onFinish={onSubmit}>
            <Form.Item label="Suministro" name="idSuministro"
              rules={[{ required:true, message:'Seleccione un suministro' }]}
              extra={<a onClick={function(){ setModalOpen(true); setSelectNewInCompra(true); setSumOpen(true); }}>¿No está? Agregar nuevo</a>}
            >
              <Select options={sumOptions} placeholder="Seleccione" showSearch optionFilterProp="label" />
            </Form.Item>

            <Form.Item label="Sucursal" name="sucursal"
              rules={[{ required:true, message:'Seleccione una sucursal' }]}>
              <Select options={sucOptions} placeholder="Seleccione" />
            </Form.Item>

            <Form.Item label="Fecha de compra" name="fechaCompra"
              rules={[
                { required:true, message:'Ingrese la fecha de compra' },
                { validator: validateFechaNoFutura }
              ]}>
              <Input type="date" />
            </Form.Item>

            <Form.Item label="Fecha de inicio de uso" name="fechaInicioUso"
              tooltip="Si empiezas a usar el mismo día, colócalo; si no, déjalo vacío."
              rules={[
                { validator: validateInicioVsCompra.bind(null, form.getFieldValue) }
              ]}>
              <Input type="date" />
            </Form.Item>

            <Row gutter={12}>
              <Col span={12}>
                <Form.Item
                  label="Cantidad (unidad base)"
                  name="cantidadUnidades"
                  rules={[
                    { required:true, message:'Ingrese la cantidad' },
                    { validator: validateCantidadVsUnidadBase.bind(null, form.getFieldValue) }
                  ]}
                  dependencies={['idSuministro']}
                >
                  <InputNumber min={0} step={1} style={{ width:'100%' }} placeholder="Ej. 48" />
                </Form.Item>
              </Col>
              <Col span={12}>
                <Form.Item label="Costo total (L.)" name="costoTotal"
                  rules={[{ required:true, message:'Ingrese el costo total' }]}>
                  <InputNumber min={0} step={0.01} style={{ width:'100%' }} placeholder="Ej. 1200.00" />
                </Form.Item>
              </Col>
            </Row>

            <Form.Item label="Observaciones" name="observaciones">
              <Input.TextArea rows={3} placeholder="Notas opcionales" />
            </Form.Item>
          </Form>
        </Modal>

        {/* MODAL: EDITAR COMPRA */}
        <Modal
          centered
          title={<Space><icons.EditOutlined /><span>Editar compra</span></Space>}
          open={editOpen} visible={editOpen}
          onCancel={function(){ setEditOpen(false); setEditRecord(null); }}
          onOk={function(){ editForm.submit(); }}
          okText="Guardar" cancelText="Cancelar"
          confirmLoading={loading}
          destroyOnClose maskClosable={false} keyboard={false}
        >
          <Form form={editForm} layout="vertical" onFinish={onSubmitEdit}>
            <Form.Item name="idCompra" style={{ display:'none' }}><Input /></Form.Item>

            <Form.Item name="idSuministro" label="Suministro" rules={[{ required:true, message:'Seleccione un suministro' }]}>
              <Select
                options={toArray(suministros).map(function(s){ return { value:String(s.idSuministro), label:s.nombreSuministro }; })}
                placeholder="Seleccione" showSearch optionFilterProp="label"
              />
            </Form.Item>

            <Form.Item name="sucursal" label="Sucursal" rules={[{ required:true, message:'Seleccione una sucursal' }]}>
              <Select options={toArray(sucursales).map(function(s){ return { value:s.nombreSucursal, label:s.nombreSucursal }; })} placeholder="Seleccione" />
            </Form.Item>

            <Form.Item name="fechaCompra" label="Fecha de compra"
              rules={[
                { required:true, message:'Ingrese la fecha de compra' },
                { validator: validateFechaNoFutura }
              ]}>
              <Input type="date" />
            </Form.Item>

            <Row gutter={12}>
              <Col span={12}>
                <Form.Item name="fechaInicioUso" label="Inicio de uso"
                  rules={[ { validator: validateInicioVsCompra.bind(null, editForm.getFieldValue) } ]}>
                  <Input type="date" />
                </Form.Item>
              </Col>
              <Col span={12}>
                <Form.Item name="fechaFinUso" label="Fin de uso"
                  rules={[ { validator: validateFinVsInicioCompra.bind(null, editForm.getFieldValue) } ]}>
                  <Input type="date" />
                </Form.Item>
              </Col>
            </Row>

            <Row gutter={12}>
              <Col span={12}>
                <Form.Item
                  name="cantidadUnidades"
                  label="Cantidad (unidad base)"
                  rules={[
                    { required:true, message:'Ingrese la cantidad' },
                    { validator: validateCantidadVsUnidadBase.bind(null, editForm.getFieldValue) }
                  ]}
                  dependencies={['idSuministro']}
                >
                  <InputNumber min={0} step={1} style={{ width:'100%' }} />
                </Form.Item>
              </Col>
              <Col span={12}>
                <Form.Item name="costoTotal" label="Costo total (L.)" rules={[{ required:true, message:'Ingrese el costo total' }]}>
                  <InputNumber min={0} step={0.01} style={{ width:'100%' }} />
                </Form.Item>
              </Col>
            </Row>

            <Form.Item name="observaciones" label="Observaciones">
              <Input.TextArea rows={3} />
            </Form.Item>
          </Form>
        </Modal>

        {/* MODAL: NUEVO SUMINISTRO */}
        <Modal
          centered
          title={<Space><icons.PlusOutlined /><span>Nuevo suministro</span></Space>}
          open={sumOpen} visible={sumOpen}
          onCancel={function(){ setSumOpen(false); }}
          onOk={function(){ sumForm.submit(); }}
          okText="Crear" cancelText="Cancelar"
          confirmLoading={loading}
          destroyOnClose maskClosable={false} keyboard={false}
        >
          <Form form={sumForm} layout="vertical" onFinish={onSubmitSuministro}>
            <Form.Item name="nombreSuministro" label="Nombre" rules={[{ required:true, message:'Ingrese el nombre' }]}>
              <Input placeholder="Papel higiénico, Café..." />
            </Form.Item>
            <Row gutter={12}>
              <Col span={12}>
                <Form.Item name="categoria" label="Categoría">
                  <Input placeholder="Limpieza, Bebidas..." />
                </Form.Item>
              </Col>
              <Col span={12}>
                {/* *** OCULTAR CAMPO DE UNIDAD BASE EN NUEVO SUMINISTRO (SIN ELIMINARLO) *** */}
                <Form.Item name="unidadBase" label="Unidad base" style={{ display:'none' }}>
                  <Input placeholder="rollo, bolsa, botella... o un número (p. ej. 50)" />
                </Form.Item>
              </Col>
            </Row>

            <Form.Item name="minStock" label="Stock mínimo" style={{ display:'none' }}>
              <InputNumber min={0} step={1} style={{ width:'100%' }} placeholder="0" />
            </Form.Item>

            <Form.Item name="notas" label="Notas">
              <Input.TextArea rows={3} placeholder="Notas opcionales" />
            </Form.Item>
          </Form>
        </Modal>

        {/* MODAL: EDITAR SUMINISTRO */}
        <Modal
          centered
          title={<Space><icons.EditOutlined /><span>Editar suministro</span></Space>}
          open={sumEditOpen} visible={sumEditOpen}
          onCancel={function(){ setSumEditOpen(false); setSumEditRecord(null); }}
          onOk={function(){ sumEditForm.submit(); }}
          okText="Guardar" cancelText="Cancelar"
          confirmLoading={loading}
          destroyOnClose maskClosable={false} keyboard={false}
        >
          <Form form={sumEditForm} layout="vertical" onFinish={onSubmitSuministroEdit}>
            <Form.Item name="idSuministro" style={{ display:'none' }}><Input /></Form.Item>

            <Form.Item name="nombreSuministro" label="Nombre" rules={[{ required:true, message:'Ingrese el nombre' }]}>
              <Input />
            </Form.Item>

            <Row gutter={12}>
              <Col span={12}>
                <Form.Item name="categoria" label="Categoría">
                  <Input />
                </Form.Item>
              </Col>
              <Col span={12}>
                {/* *** OCULTAR CAMPO DE UNIDAD BASE EN EDITAR SUMINISTRO (SIN ELIMINARLO) *** */}
                <Form.Item name="unidadBase" label="Unidad base" style={{ display:'none' }}>
                  <Input placeholder="rollo, bolsa, botella... o un número (p. ej. 50)" />
                </Form.Item>
              </Col>
            </Row>

            <Form.Item name="minStock" label="Stock mínimo" style={{ display:'none' }}>
              <InputNumber min={0} step={1} style={{ width:'100%' }} />
            </Form.Item>

            <Form.Item name="estado" style={{ display:'none' }}>
              <Input />
            </Form.Item>

            <Form.Item name="notas" label="Notas">
              <Input.TextArea rows={3} />
            </Form.Item>
          </Form>
        </Modal>
      </Card>
    </div>
  );
}
ReactDOM.render(<Suministros />, document.getElementById('root'));
</script>
