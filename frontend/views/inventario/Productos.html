//<script type="text/jsx">
function Productos() {
  const { useState, useEffect, useMemo, useRef } = React;
  const { Table, Card, Button, Modal, Form, Input, InputNumber, Select, Space, message, Row, Col, Divider, Tooltip, Tag, Collapse, AutoComplete } = antd;

  // ===== Estado general =====
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(false);

  // Sucursales (para Select)
  const [sucursales, setSucursales] = useState([]);

  // Modal + formulario
  const [form] = Form.useForm();
  const [modalOpen, setModalOpen] = useState(false);
  const [modalMode, setModalMode] = useState('create'); // 'create' | 'edit' | 'duplicate'
  const [canSubmit, setCanSubmit] = useState(true);     // para bloquear Guardar en 'duplicate'
  const dupOriginalRef = useRef(null);                  // valores originales para comparar en 'duplicate'

  // Eliminar
  const [deleteOpen, setDeleteOpen] = useState(false);
  const [toDelete, setToDelete] = useState(null);

  // ===== Filtros =====
  const [q, setQ] = useState(''); // buscador global
  const [fSucursal, setFSucursal] = useState(undefined);
  const [fCategoria, setFCategoria] = useState(undefined); // <-- agregado
  const [fDesde, setFDesde] = useState(''); // yyyy-mm-dd
  const [fHasta, setFHasta] = useState(''); // yyyy-mm-dd
  const [fPrecioMin, setFPrecioMin] = useState(null);
  const [fPrecioMax, setFPrecioMax] = useState(null);
  const [fStockMin, setFStockMin] = useState(null);
  const [fStockMax, setFStockMax] = useState(null);

  // Umbral stock bajo para dashboard
  const [lowThreshold, setLowThreshold] = useState(5);

  // ===== PAGINACIÓN (Load more) =====
  const [batchSize, setBatchSize] = useState(10);
  const [visibleCount, setVisibleCount] = useState(10);

  useEffect(function(){
    setVisibleCount(batchSize);
  }, [q, fSucursal, fCategoria, fDesde, fHasta, fPrecioMin, fPrecioMax, fStockMin, fStockMax, data, batchSize]);

  // ===== Helpers Precio (L.) =====
  function formatHNL(value) {
    var n = Number(value);
    if (!isFinite(n)) n = 0;
    try {
      var num = new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
        useGrouping: true
      }).format(n);
      return 'L.' + num;
    } catch (e) {
      var raw = n.toFixed(2);
      var withCommas = raw.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      return 'L.' + withCommas;
    }
  }

  // ===== Helpers Fecha =====
  function parseFechaFlexible(v) {
    if (v instanceof Date) return v;
    if (typeof v === 'number') return new Date(v);
    if (typeof v === 'string') {
      if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return new Date(v + 'T00:00:00');
      var m = v.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
      if (m) {
        var d = parseInt(m[1], 10), mo = parseInt(m[2], 10) - 1, y = parseInt(m[3], 10);
        if (y < 100) y += 2000;
        return new Date(y, mo, d);
      }
      var d2 = new Date(v);
      if (!isNaN(d2)) return d2;
      return null;
    }
    var d0 = new Date(v);
    return isNaN(d0) ? null : d0;
  }
  function formatYMD(d) {
    var y = d.getFullYear();
    var m = String(d.getMonth() + 1).padStart(2, '0');
    var day = String(d.getDate()).padStart(2, '0');
    return y + '/' + m + '/' + day;
  }
  function formatInputDate(d) {
    if (!d) return '';
    var y = d.getFullYear();
    var m = String(d.getMonth() + 1).padStart(2, '0');
    var day = String(d.getDate()).padStart(2, '0');
    return y + '-' + m + '-' + day;
  }
  function parseInputDate(v) {
    if (!v) return null;
    var m = v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return null;
    return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
  }

  // --------- Paleta & estilos suaves ---------
  const PALETTE = ['#7FB3FF','#9FD3FF','#B8E1C6','#FFD6A5','#F9A8D4','#C3B8FF','#BDE0FE','#CFF5E7','#FFE3B3','#D0BCFF','#B0BEC5','#C6E2FF'];

  // ===== Data productos =====
  function cargar() {
    setLoading(true);
    google.script.run
      .withSuccessHandler(function (res) {
        try {
          var arr = JSON.parse(res) || [];
          var normalizados = arr.map(function (r, i) {
            return Object.assign({}, r, { key: (r && r.id != null ? r.id : i) });
          });
          // Orden permanente: ID DESC
          normalizados.sort(function(a,b){ return Number(b.id||0) - Number(a.id||0); });
          setData(normalizados);
        } catch (e) {
          Modal.error({ title: 'Error', content: 'No se pudo leer la respuesta del servidor.' });
        } finally {
          setLoading(false);
        }
      })
      .withFailureHandler(function (err) {
        setLoading(false);
        Modal.error({ title: 'Error de servidor', content: String((err && err.message) || err) });
      })
      .listarProductos();
  }

  // ===== Data sucursales =====
  function cargarSucursales() {
    google.script.run
      .withSuccessHandler(function (res) {
        try {
          var r = typeof res === 'string' ? JSON.parse(res) : res;
          if (Array.isArray(r)) {
            setSucursales(r);
          } else if (r && r.ok && Array.isArray(r.sucursales)) {
            setSucursales(r.sucursales);
          } else {
            setSucursales([]);
          }
        } catch (e) { setSucursales([]); }
      })
      .withFailureHandler(function () { setSucursales([]); })
      .sucursales_listar_activas();
  }

  useEffect(function () {
    cargar();
    cargarSucursales();
  }, []);

  function isInSucursalOptions(value) {
    for (var i = 0; i < sucursales.length; i++) {
      if (sucursales[i].nombreSucursal === value) return true;
    }
    return false;
  }

  // Lista de categorías deducidas de los datos (para filtro rápido)
  const categoriasOptions = useMemo(function(){
    var set = {};
    (data || []).forEach(function(r){
      var c = (r && r.categoria != null ? String(r.categoria) : '').trim();
      if (c) set[c] = true;
    });
    return Object.keys(set).sort().map(function(n){ return { value: n, label: n }; });
  }, [data]);

  // ====== CATEGORÍAS PARA EL MODAL ======
  const [categoriasSelect, setCategoriasSelect] = useState([]);
  const [catOpen, setCatOpen] = useState(false);

  const categoriasFromData = useMemo(function(){
    var s = {};
    (data || []).forEach(function(r){
      var c = (r && r.categoria != null ? String(r.categoria) : '').trim().toUpperCase();
      if (c) s[c] = true;
    });
    return Object.keys(s).sort();
  }, [data]);

  useEffect(function(){
    setCategoriasSelect(function(prev){
      var setx = new Set(prev);
      categoriasFromData.forEach(function(c){ setx.add(c); });
      return Array.from(setx).sort();
    });
  }, [categoriasFromData]);

  const categoriasSelectOptions = useMemo(function(){
    return categoriasSelect.map(function(c){ return { value: c, label: c }; });
  }, [categoriasSelect]);

  // ===== Modals =====
  function abrirNuevo() {
    setModalMode('create');
    setCanSubmit(true);
    cargarSucursales();
    form.resetFields();
    setModalOpen(true);
  }

  function abrirEditar(rec) {
    setModalMode('edit');
    setCanSubmit(true);
    cargarSucursales();
    var d = parseFechaFlexible(rec.fechaEntrada);
    var sucPreset = isInSucursalOptions(rec.nombreSucursal) ? rec.nombreSucursal : undefined;

    form.setFieldsValue({
      id: rec.id,
      nombreProducto: rec.nombreProducto || '',
      categoria: (rec.categoria || '').toString().toUpperCase(),
      precio: Number(rec.precio || 0),
      stock: Number(rec.stock || 0),
      fechaEntrada: d ? formatInputDate(d) : '',
      descripcion: rec.descripcion || '',
      nombreSucursal: sucPreset
    });
    setModalOpen(true);
  }

  // NUEVO: abrir "Agregar" (duplicar para otra sucursal)
  function abrirAgregar(rec) {
    setModalMode('duplicate');
    setCanSubmit(false); // bloquear hasta que cambie algo
    cargarSucursales();
    var d = parseFechaFlexible(rec.fechaEntrada);
    var sucPreset = isInSucursalOptions(rec.nombreSucursal) ? rec.nombreSucursal : undefined;
    var initial = {
      id: '', // sin ID para que sea nuevo
      nombreProducto: rec.nombreProducto || '',
      categoria: (rec.categoria || '').toString().toUpperCase(),
      precio: Number(rec.precio || 0),
      stock: Number(rec.stock || 0),
      fechaEntrada: d ? formatInputDate(d) : '',
      descripcion: rec.descripcion || '',
      nombreSucursal: sucPreset
    };
    form.setFieldsValue(initial);
    // guardar originales de los campos que sí se pueden cambiar
    dupOriginalRef.current = {
      precio: Number(initial.precio || 0),
      stock: Number(initial.stock || 0),
      fechaEntrada: initial.fechaEntrada || '',
      descripcion: initial.descripcion || '',
      nombreSucursal: initial.nombreSucursal || ''
    };
    setModalOpen(true);
  }

  function abrirEliminar(rec) {
    setToDelete(rec);
    setDeleteOpen(true);
  }

  // ===== Tras crear: recargar y subir el creado al inicio =====
  function cargarNuevo(recienCreado) {
    setLoading(true);
    google.script.run
      .withSuccessHandler(function (res) {
        try {
          var arr = JSON.parse(res) || [];
          var normalizados = arr.map(function (r, i) {
            return Object.assign({}, r, { key: (r && r.id != null ? r.id : i) });
          });
          var ymdNuevo = recienCreado && recienCreado.fechaEntrada ? formatInputDate(parseInputDate(recienCreado.fechaEntrada)) : '';
          var idx = -1;
          for (var i = 0; i < normalizados.length; i++) {
            var r = normalizados[i];
            var d = parseFechaFlexible(r.fechaEntrada);
            var ymdR = d ? formatInputDate(d) : '';
            if (
              String(r.nombreProducto || '') === String(recienCreado.nombreProducto || '') &&
              String(r.categoria || '') === String(recienCreado.categoria || '') &&
              Number(r.precio || 0) === Number(recienCreado.precio || 0) &&
              Number(r.stock || 0) === Number(recienCreado.stock || 0) &&
              String(r.descripcion || '') === String(recienCreado.descripcion || '') &&
              String(r.nombreSucursal || '') === String(recienCreado.nombreSucursal || '') &&
              String(ymdR || '') === String(ymdNuevo || '')
            ) { idx = i; break; }
          }
          if (idx > -1) {
            var rec = normalizados[idx];
            normalizados.splice(idx, 1);
            normalizados.unshift(rec);
          } else {
            normalizados.sort(function(a,b){ return Number(b.id||0) - Number(a.id||0); });
          }
          // asegurar orden ID DESC
          normalizados.sort(function(a,b){ return Number(b.id||0) - Number(a.id||0); });
          setData(normalizados);
        } catch (e) {
          Modal.error({ title: 'Error', content: 'No se pudo leer la respuesta del servidor.' });
        } finally {
          setLoading(false);
        }
      })
      .withFailureHandler(function (err) {
        setLoading(false);
        Modal.error({ title: 'Error de servidor', content: String((err && err.message) || err) });
      })
      .listarProductos();
  }

  // ===== Guardar (crear/editar/duplicar) =====
  function onSubmit(values) {
    var payload = {
      id: values.id,
      nombreProducto: values.nombreProducto,
      categoria: values.categoria || '',
      precio: Number(values.precio || 0),
      stock: Number(values.stock || 0),
      fechaEntrada: values.fechaEntrada || '',
      descripcion: values.descripcion || '',
      nombreSucursal: values.nombreSucursal || ''
    };

    // normalizar categoría a MAYÚSCULAS y actualizar catálogo evitando duplicados
    payload.categoria = (payload.categoria || '').toString().trim().toUpperCase();
    if (payload.categoria) {
      setCategoriasSelect(function(prev){
        var setx = new Set(prev); setx.add(payload.categoria);
        return Array.from(setx).sort();
      });
    }

    // En modo 'duplicate', bloquear si no hay cambios y forzar creación (sin id)
    if (modalMode === 'duplicate') {
      if (!canSubmit) {
        message.warning('Realice algún cambio (sucursal, fecha, precio, stock o descripción) para poder agregar.');
        return;
      }
      delete payload.id; // asegurar nuevo registro
    }

    setLoading(true);
    if (modalMode === 'create' || modalMode === 'duplicate') {
      google.script.run
        .withSuccessHandler(function (res) {
          setLoading(false);
          try {
            var r = typeof res === 'string' ? JSON.parse(res) : res;
            if (r && r.ok) {
              message.success(modalMode === 'duplicate' ? 'Producto agregado (copia)' : 'Producto creado');
              setModalOpen(false);
              cargarNuevo(payload); // poner de primero
            } else {
              Modal.error({ title: 'No se pudo crear', content: (r && r.message) || 'Error desconocido' });
            }
          } catch (e) {
            Modal.error({ title: 'Error', content: 'Respuesta inválida del servidor.' });
          }
        })
        .withFailureHandler(function (err) {
          setLoading(false);
          Modal.error({ title: 'Error de servidor', content: String((err && err.message) || err) });
        })
        .crearProducto(payload);
    } else {
      google.script.run
        .withSuccessHandler(function (res) {
          setLoading(false);
          try {
            var r = typeof res === 'string' ? JSON.parse(res) : res;
            if (r && r.ok) {
              message.success('Producto actualizado');
              setModalOpen(false);
              cargar();
            } else {
              Modal.error({ title: 'No se pudo actualizar', content: (r && r.message) || 'Error desconocido' });
            }
          } catch (e) {
            Modal.error({ title: 'Error', content: 'Respuesta inválida del servidor.' });
          }
        })
        .withFailureHandler(function (err) {
          setLoading(false);
          Modal.error({ title: 'Error de servidor', content: String((err && err.message) || err) });
        })
        .actualizarProducto(payload);
    }
  }

  // Track cambios del formulario para habilitar Guardar en 'duplicate'
  function onFormValuesChange(_, all) {
    if (modalMode !== 'duplicate') return;
    var orig = dupOriginalRef.current || {};
    function nNum(v){ return Number(v||0); }
    function nStr(v){ return v == null ? '' : String(v); }
    var changed =
      nNum(all.precio) !== nNum(orig.precio) ||
      nNum(all.stock) !== nNum(orig.stock) ||
      nStr(all.fechaEntrada) !== nStr(orig.fechaEntrada) ||
      nStr(all.descripcion) !== nStr(orig.descripcion) ||
      nStr(all.nombreSucursal) !== nStr(orig.nombreSucursal);
    setCanSubmit(changed);
  }

  // ===== Eliminar =====
  function confirmarEliminar() {
    if (!toDelete) { setDeleteOpen(false); return; }
    setLoading(true);
    google.script.run
      .withSuccessHandler(function (res) {
        setLoading(false);
        try {
          var r = typeof res === 'string' ? JSON.parse(res) : res;
          if (r && r.ok) {
            message.success('Producto eliminado');
            setDeleteOpen(false);
            setToDelete(null);
            cargar(); // vuelve ordenado ID DESC
          } else {
            Modal.error({ title: 'No se pudo eliminar', content: (r && r.message) || 'Error desconocido' });
          }
        } catch (e) {
          Modal.error({ title: 'Error', content: 'Respuesta inválida del servidor.' });
        }
      })
      .withFailureHandler(function (err) {
        setLoading(false);
        Modal.error({ title: 'Error de servidor', content: String((err && err.message) || err) });
      })
      .eliminarProducto(toDelete.id);
  }

  // ====== FILTRADO ======
  function applyFilters(arr) {
    var qnorm = (q || '').toLowerCase().trim();
    var dFrom = parseInputDate(fDesde);
    var dTo = parseInputDate(fHasta);
    var pMin = fPrecioMin != null ? Number(fPrecioMin) : null;
    var pMax = fPrecioMax != null ? Number(fPrecioMax) : null;
    var sMin = fStockMin != null ? Number(fStockMin) : null;
    var sMax = fStockMax != null ? Number(fStockMax) : null;

    return (arr || []).filter(function (r) {
      if (qnorm) {
        var t1 = (r.nombreProducto || '').toString().toLowerCase();
        var t2 = (r.descripcion || '').toString().toLowerCase();
        if (t1.indexOf(qnorm) === -1 && t2.indexOf(qnorm) === -1) return false;
      }
      if (fSucursal && r.nombreSucursal !== fSucursal) return false;
      if (fCategoria && r.categoria !== fCategoria) return false;

      if (fDesde || fHasta) {
        var d = parseFechaFlexible(r.fechaEntrada);
        if (!d) return false;
        if (dFrom && d.getTime() < dFrom.getTime()) return false;
        if (dTo) {
          var dToEnd = new Date(dTo.getFullYear(), dTo.getMonth(), dTo.getDate(), 23, 59, 59, 999);
          if (d.getTime() > dToEnd.getTime()) return false;
        }
      }

      var precio = Number(r.precio || 0);
      if (pMin != null && precio < pMin) return false;
      if (pMax != null && precio > pMax) return false;

      var stock = Number(r.stock || 0);
      if (sMin != null && stock < sMin) return false;
      if (sMax != null && stock > sMax) return false;

      return true;
    });
  }

  var filtered = applyFilters(data);

  // ====== KPIs base ======
  function sumBy(arr, selector) {
    var s = 0;
    for (var i = 0; i < arr.length; i++) s += Number(selector(arr[i]) || 0);
    return s;
  }
  var totalProductos = filtered.length; // número de productos
  var totalStock = sumBy(filtered, function (r) { return r.stock; }); // total unidades
  var valorInventario = sumBy(filtered, function (r) { return Number(r.precio || 0) * Number(r.stock || 0); });

  // ===== Columnas =====
  const columns = [
    { title: 'No.', dataIndex: 'id', key: 'id', width: 70,
      sorter: function(a,b){ return Number(a.id||0) - Number(b.id||0); },
      defaultSortOrder: 'descend'
    },
    { title: 'Nombre', dataIndex: 'nombreProducto', key: 'nombreProducto' },
    { title: 'Categoría', dataIndex: 'categoria', key: 'categoria', width: 180 },
    { title: 'Precio Unitario', dataIndex: 'precio', key: 'precio',
      render: function (v) { return formatHNL(v); },
      sorter: function (a, b) { return Number(a.precio || 0) - Number(b.precio || 0); },
      align: 'right', width: 120
    },
    { title: 'Stock', dataIndex: 'stock', key: 'stock', align: 'right', width: 90 },
    { title: 'Fecha de Entrada', dataIndex: 'fechaEntrada', key: 'fechaEntrada',
      render: function (v) {
        var d = parseFechaFlexible(v);
        return d ? formatYMD(d) : (v == null ? '' : String(v));
      },
      sorter: function(a,b){
        var da = parseFechaFlexible(a.fechaEntrada);
        var db = parseFechaFlexible(b.fechaEntrada);
        var ta = da ? da.getTime() : 0;
        var tb = db ? db.getTime() : 0;
        return ta - tb;
      },
      width: 120
    },
    { title: 'Descripción', dataIndex: 'descripcion', key: 'descripcion' },
    { title: 'Sucursal', dataIndex: 'nombreSucursal', key: 'nombreSucursal', width: 200 },
    { title: 'Acciones', key: 'acciones', fixed: 'right', width: 180,
      render: function(_, record){
        return (
          <Space direction="vertical" size={4}>
            <Button size="small" onClick={function(){ abrirEditar(record); }}>Editar</Button>
            <Button size="small" danger onClick={function(){ abrirEliminar(record); }}>Eliminar</Button>
            <Button size="small" type="dashed" onClick={function(){ abrirAgregar(record); }}>Agregar</Button>
          </Space>
        );
      }
    }
  ];

  // --------- DASHBOARDS (sobre "filtered") ---------
  function useCountUp(value, duration=800){
    const [display, setDisplay] = useState(0);
    const prevRef = useRef(0);
    useEffect(()=>{
      const start = performance.now();
      const from = prevRef.current;
      const to = Number(value||0);
      let raf;
      function tick(t){
        const p = Math.min(1, (t - start)/duration);
        const eased = 1 - Math.pow(1 - p, 3);
        setDisplay(from + (to - from) * eased);
        if (p < 1) raf = requestAnimationFrame(tick);
      }
      raf = requestAnimationFrame(tick);
      prevRef.current = to;
      return ()=> cancelAnimationFrame(raf);
    }, [value, duration]);
    return display;
  }

  function KPI({ title, value, formatter, icon, accent='#EEF2FF' }){
    const v = useCountUp(value);
    return (
      <Card className="fade-in prd-kpi" bodyStyle={{ padding: 14 }}>
        <div style={{ display:'flex', alignItems:'center', gap:12 }}>
          <div style={{ width:38, height:38, borderRadius:12, background:accent, display:'grid', placeItems:'center' }}>
            {icon}
          </div>
          <div style={{ flex:1 }}>
            <div className="prd-kpi-sub">{title}</div>
            <div className="prd-kpi-val">{formatter ? formatter(v) : v.toFixed(0)}</div>
          </div>
        </div>
      </Card>
    );
  }

  function formatPercent(v, total){
    const t = Number(total) || 0;
    if (t <= 0) return '0%';
    return Math.round((Number(v||0)*100)/t) + '%';
  }

  function DonutChart({ data, total, onSelect, title }){
    if (!data || data.length === 0 || total <= 0){
      return <Card bodyStyle={{padding:14}}><div style={{textAlign:'center', color:'#94A3B8'}}>Sin datos</div></Card>;
    }
    const cx = 75, cy = 75, r = 50, strokeW = 18;
    let startAngle = 0;
    const slices = data.map((d)=>{
      const angle = (d.value/total) * 360;
      const endAngle = startAngle + angle;
      const out = { ...d, start: startAngle, end: endAngle };
      startAngle = endAngle;
      return out;
    });
    function polar(cx, cy, r, ang){
      const rad = (ang - 90) * Math.PI/180;
      return { x: cx + r*Math.cos(rad), y: cy + r*Math.sin(rad) };
    }
    function arcPath(cx, cy, r, start, end){
      const s = polar(cx, cy, r, start);
      const e = polar(cx, cy, r, end);
      const large = (end - start) > 180 ? 1 : 0;
      return `M ${s.x} ${s.y} A ${r} ${r} 0 ${large} 1 ${e.x} ${e.y}`;
    }
    return (
      <Card title={<Space><icons.PieChartOutlined /> <span>{title}</span></Space>}
            extra={fSucursal ? <Tag color="blue" onClick={()=>setFSucursal(undefined)} style={{cursor:'pointer'}}>Quitar filtro</Tag> : null}
            bodyStyle={{ padding: 12 }}>
        <div style={{ display:'grid', gridTemplateColumns:'160px 1fr', gap:12, alignItems:'center' }}>
          <svg width={160} height={160} viewBox="0 0 150 150" className="fade-in">
            <circle cx={cx} cy={cy} r={r} fill="none" stroke="#F1F5F9" strokeWidth={strokeW} />
            {slices.map((s,i)=>(
              <path key={i}
                d={arcPath(cx,cy,r,s.start,s.end)}
                stroke={s.color}
                strokeWidth={strokeW}
                fill="none"
                style={{ cursor:'pointer', transition:'opacity .2s ease' }}
                onClick={()=> onSelect && s.label !== 'Otros' && onSelect(s.label)}
                onMouseEnter={e=> e.currentTarget.style.opacity = 0.85}
                onMouseLeave={e=> e.currentTarget.style.opacity = 1}
              />
            ))}
            <circle cx={cx} cy={cy} r={r- strokeW/2 - 4} fill="#FFFFFF"/>
            <text x={cx} y={cy-4} textAnchor="middle" style={{fontSize:12, fill:'#64748B'}}>Valor total</text>
            <text x={cx} y={cy+14} textAnchor="middle" style={{fontSize:14, fontWeight:700}}>{formatHNL(total)}</text>
          </svg>
          <div style={{ display:'grid', gap:6 }}>
            {data.map((d,i)=>(
              <div key={i} style={{ display:'flex', alignItems:'center', gap:8 }}>
                <span style={{ width:10, height:10, borderRadius:3, background:d.color }} />
                <div style={{ flex:1, whiteSpace:'nowrap', overflow:'hidden', textOverflow:'ellipsis' }}>
                  <Tooltip title="Filtrar por sucursal">
                    <a onClick={()=> onSelect && d.label !== 'Otros' && onSelect(d.label)}>{d.label}</a>
                  </Tooltip>
                </div>
                <div style={{ width:100, textAlign:'right', color:'#475569' }}>{formatHNL(d.value)}</div>
                <div style={{ width:48, textAlign:'right', color:'#64748B' }}>{formatPercent(d.value, total)}</div>
              </div>
            ))}
          </div>
        </div>
      </Card>
    );
  }

  function BarList({ data, onSelect, title, hint='Filtrar', icon }){
    const max = data.reduce((a,b)=> Math.max(a, Number(b.value||0)), 0) || 1;
    return (
      <Card title={<Space>{icon}{title}</Space>} bodyStyle={{ padding: 12 }}>
        <div className="fade-in" style={{ display:'grid', gap:8 }}>
          {data.length === 0 ? <div style={{textAlign:'center', color:'#94A3B8'}}>Sin datos</div> : null}
          {data.map((d,i)=>(
            <div key={i} style={{ display:'grid', gridTemplateColumns:'auto 100px', gap:10, alignItems:'center' }}>
              <div style={{ display:'grid', gridTemplateColumns:'16px 1fr', gap:8, alignItems:'center' }}>
                <span style={{ width:10, height:10, borderRadius:3, background:d.color }} />
                <div style={{ position:'relative' }}>
                  <div style={{ fontSize:12, color:'#334155', marginBottom:4, whiteSpace:'nowrap', overflow:'hidden', textOverflow:'ellipsis' }}>
                    <Tooltip title={d.label}><a onClick={()=> onSelect && onSelect(d.label)}>{d.label}</a></Tooltip>
                  </div>
                  <Tooltip title={hint}>
                    <div onClick={()=> onSelect && onSelect(d.label)}
                         style={{ height:8, background:'#F1F5F9', borderRadius:999, cursor:'pointer' }}>
                      <div className="bar" style={{
                        width: (Math.max(3,(d.value/max)*100)).toFixed(2)+'%',
                        height:'100%',
                        borderRadius:999,
                        background:`linear-gradient(90deg, ${d.color} 0%, ${d.color}CC 100%)`,
                        transition:'width .8s ease'
                      }} />
                    </div>
                  </Tooltip>
                </div>
              </div>
              <div style={{ textAlign:'right', fontWeight:600 }}>{formatHNL(d.value)}</div>
            </div>
          ))}
        </div>
      </Card>
    );
  }

  function Sparkline({ data, days }){
    const W = 340, H = 90, pad = 8;
    const maxY = data.reduce((a,b)=>Math.max(a, b.y), 0) || 1;
    const stepX = (W - pad*2) / Math.max(1, days - 1);
    const scaleY = v => (H - pad) - ( (Number(v)/maxY) * (H - pad*2) );
    const points = data.map((d,i)=> [pad + i*stepX, scaleY(d.y)] );
    const path = points.map((p,i)=> (i===0? 'M':'L') + p[0].toFixed(2)+' '+p[1].toFixed(2)).join(' ');
    return (
      <Card title={<Space><icons.AreaChartOutlined /> Entradas (valor) en el tiempo</Space>} bodyStyle={{padding:12}}>
        {data.length === 0 ? <div style={{textAlign:'center', color:'#94A3B8'}}>Sin datos</div> : (
          <svg width={W} height={H} className="fade-in">
            <path d={path} fill="none" stroke="#7FB3FF" strokeWidth="2" />
            <path d={`${path} L ${pad + (days-1)*stepX} ${H-pad} L ${pad} ${H-pad} Z`} fill="#7FB3FF22" />
            {points.map((p,i)=>( <circle key={i} cx={p[0]} cy={p[1]} r="2" fill="#7FB3FF" /> ))}
          </svg>
        )}
        <div style={{ fontSize:12, color:'#64748B', marginTop:6 }}>
          {days} días · Máximo diario {formatHNL(maxY)}
        </div>
      </Card>
    );
  }

  const {
    valorPorSucursal, donutSucursal,
    topProductosValor,
    lowStockItems, lowStockCount,
    entradasSeries, entradasDias
  } = useMemo(() => {
    const items = Array.isArray(filtered) ? filtered : [];
    const bySuc = {};
    items.forEach(r=>{
      const suc = r.nombreSucursal || 'Sin sucursal';
      const val = Number(r.precio||0) * Number(r.stock||0);
      bySuc[suc] = (bySuc[suc] || 0) + val;
    });
    const valorPorSucursal = bySuc;

    const entriesSuc = Object.entries(bySuc).sort((a,b)=>b[1]-a[1]);
    let donutSucursal = entriesSuc.slice(0,6).map(([label,value],i)=>({ label, value, color: PALETTE[i % PALETTE.length] }));
    if (entriesSuc.length > 6) {
      const otros = entriesSuc.slice(6).reduce((acc, [,v]) => acc+v, 0);
      donutSucursal.push({ label: 'Otros', value: otros, color: '#E5E7EB' });
    }

    const topProductosValor = items
      .map(r => ({ rec: r, label: r.nombreProducto || ('ID '+r.id), value: Number(r.precio||0)*Number(r.stock||0) }))
      .sort((a,b)=> b.value - a.value)
      .slice(0,8)
      .map((d,i)=> ({ ...d, color: PALETTE[i % PALETTE.length] }));

    const lowStockItems = items
      .filter(r => Number(r.stock||0) <= Number(lowThreshold||0))
      .sort((a,b)=> Number(a.stock||0) - Number(b.stock||0))
      .slice(0,6);
    const lowStockCount = items.filter(r => Number(r.stock||0) <= Number(lowThreshold||0)).length;

    let start, end;
    const today = new Date(); today.setHours(0,0,0,0);
    if (fDesde || fHasta) {
      start = parseInputDate(fDesde) || new Date(today.getFullYear(), today.getMonth(), today.getDate()-29);
      end = parseInputDate(fHasta) || today;
    } else {
      end = today;
      start = new Date(today.getFullYear(), today.getMonth(), today.getDate()-29);
    }
    start.setHours(0,0,0,0); end.setHours(0,0,0,0);
    const dayMs = 24*60*60*1000;
    const len = Math.max(1, Math.floor((end - start)/dayMs) + 1);
    const daily = new Array(len).fill(0);
    items.forEach(r=>{
      const d = parseFechaFlexible(r.fechaEntrada);
      if (!d) return;
      const dd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      if (dd >= start && dd <= end) {
        const idx = Math.floor((dd - start)/dayMs);
        daily[idx] += Number(r.precio||0) * Number(r.stock||0);
      }
    });
    const entradasSeries = daily.map((v,idx)=>({ x: idx+1, y: v }));
    const entradasDias = len;

    return { valorPorSucursal, donutSucursal, topProductosValor, lowStockItems, lowStockCount, entradasSeries, entradasDias };
  }, [filtered, fDesde, fHasta, lowThreshold]);

  return (
    <div className="productos-wrap">
      <Card
        title={<div className="prd-hero-title"><span className="prd-spark"></span>Productos</div>}
        extra={
          <Space>
            <Button onClick={cargar} loading={loading} icon={<icons.ReloadOutlined />}>Refrescar</Button>
            <Button type="primary" onClick={abrirNuevo} icon={<icons.PlusOutlined />}>Nuevo</Button>
          </Space>
        }
      >
        <style>{`
          .fade-in { animation: fadeIn .45s ease; }
          @keyframes fadeIn { from { opacity:.0; transform: scale(.98) } to { opacity:1; transform: scale(1) } }
          .bar { will-change: width; }
          .prd-hero-title{ position:relative; padding-left:12px; font-weight:800; }
          .prd-spark{
            position:absolute; left:0; top:6px; width:6px; height:22px; border-radius:3px;
            background: linear-gradient(180deg,#60a5fa,#a78bfa,#34d399);
            animation: prdSpark 2.6s ease-in-out infinite;
          }
          @keyframes prdSpark{ 0%{opacity:.4; transform:translateY(0)} 50%{opacity:1; transform:translateY(6px)} 100%{opacity:.4; transform:translateY(0)} }
          .prd-kpi{ border-radius:14px; background: linear-gradient(135deg,#e0eaff,#e9fff6); box-shadow: 0 2px 10px rgba(15,23,42,.06); }
          .prd-kpi-sub{ font-size:12px; color:#6b7280 }
          .prd-kpi-val{ font-size:22px; font-weight:800; color:#0f172a }
          .productos-wrap .prd-table .ant-table{ border-radius:14px; overflow:hidden; }
          .productos-wrap .prd-table .ant-table-thead > tr > th{
            background:#f8fafc !important; border-bottom:0; color:#334155; font-weight:700;
          }
          .productos-wrap .prd-table .ant-table-tbody > tr{
            transition: transform .15s ease, box-shadow .15s ease, background .2s;
            animation: prdFadeUp .35s ease both;
          }
          @keyframes prdFadeUp{ from{ opacity:0; transform:translateY(6px) } to{ opacity:1; transform:translateY(0) } }
          .productos-wrap .prd-table .ant-table-tbody > tr:hover{
            transform: scale(1.01); box-shadow: 0 10px 24px rgba(2,6,23,.08);
          }
          .productos-wrap .prd-table .ant-table-tbody > tr:nth-child(odd) td{ background:#fcfdff; }
        `}</style>

        <Row gutter={[12,12]} style={{ marginBottom: 8 }}>
          <Col xs={24} sm={8}>
            <KPI
              title="Total productos (unidades)"
              value={totalStock}
              icon={<icons.AppstoreOutlined />}
              accent="#E6FFFB"
            />
          </Col>
          <Col xs={24} sm={8}>
            <KPI
              title="Número de productos"
              value={totalProductos}
              icon={<icons.ShoppingCartOutlined />}
              accent="#F1F5FF"
            />
          </Col>
          <Col xs={24} sm={8}>
            <KPI
              title="Valor de inventario"
              value={valorInventario}
              formatter={formatHNL}
              icon={<icons.DollarOutlined />}
              accent="#FFF7ED"
            />
          </Col>
        </Row>

        <Row gutter={[12,12]} style={{ marginBottom: 8 }}>
          <Col xs={24} md={12}>
            <DonutChart
              data={donutSucursal}
              total={Object.values(valorPorSucursal).reduce((a,b)=>a+b,0)}
              onSelect={(label)=> setFSucursal(label)}
              title="Distribución del valor por sucursal"
            />
          </Col>
          <Col xs={24} md={12}>
            <BarList
              data={topProductosValor}
              onSelect={(label)=> setQ(label)}
              title="Top productos por valor en inventario"
              hint="Buscar producto"
              icon={<icons.BarChartOutlined />}
            />
          </Col>
        </Row>

        <Row gutter={[12,12]} style={{ marginBottom: 8 }}>
          <Col xs={24} md={12}>
            <Sparkline data={entradasSeries} days={entradasDias} />
          </Col>
          <Col xs={24} md={12}>
            <Card title={<Space><icons.AlertOutlined /> Stock bajo</Space>} bodyStyle={{padding:12}}>
              <div style={{ display:'flex', alignItems:'center', gap:8, marginBottom:8 }}>
                <span style={{ fontSize:12, color:'#64748B' }}>Umbral:</span>
                <InputNumber min={0} step={1} value={lowThreshold} onChange={setLowThreshold} />
                <span style={{ fontSize:12, color:'#64748B' }}>productos ≤ umbral: <b>{lowStockCount}</b></span>
              </div>
              {lowStockItems.length === 0 ? <div style={{textAlign:'center', color:'#94A3B8'}}>Sin alertas</div> : (
                <div style={{ display:'grid', gap:6 }}>
                  {lowStockItems.map((r,i)=>(
                    <div key={i} style={{ display:'grid', gridTemplateColumns:'1fr 70px 90px 90px auto', gap:8, alignItems:'center' }}>
                      <div style={{ whiteSpace:'nowrap', overflow:'hidden', textOverflow:'ellipsis' }}>{r.nombreProducto || ('ID '+r.id)}</div>
                      <div style={{ textAlign:'right' }}><Tag color="orange">Stock: {r.stock}</Tag></div>
                      <div style={{ textAlign:'right', color:'#475569' }}>{formatHNL(r.precio)}</div>
                      <div style={{ textAlign:'right', fontWeight:600 }}>{formatHNL(Number(r.precio||0)*Number(r.stock||0))}</div>
                      <Button size="small" onClick={()=>abrirEditar(r)}>Revisar</Button>
                    </div>
                  ))}
                </div>
              )}
            </Card>
          </Col>
        </Row>

        {/* Filtros */}
        <Collapse defaultActiveKey={[]} style={{ marginBottom: 8 }}>
          <Collapse.Panel
            header={<Space><icons.FilterOutlined /> Filtros</Space>}
            key="filtros"
            extra={
              <span onClick={function(e){ e.stopPropagation(); }}>
                <Space>
                  <Button onClick={cargar} loading={loading} icon={<icons.ReloadOutlined />}>Refrescar</Button>
                  <Button type="primary" onClick={abrirNuevo} icon={<icons.PlusOutlined />}>Nuevo</Button>
                </Space>
              </span>
            }
          >
            <Row gutter={[12, 12]} align="bottom">
              <Col xs={24} md={8}>
                <label style={{ display: 'block', marginBottom: 4 }}>Buscar (nombre o descripción)</label>
                <Input
                  allowClear
                  placeholder="Buscar..."
                  value={q}
                  onChange={function(e){ setQ(e.target.value); }}
                  prefix={<icons.FilterOutlined />}
                />
              </Col>

              <Col xs={24} md={8}>
                <label style={{ display: 'block', marginBottom: 4 }}>Sucursal</label>
                <Select
                  options={sucursales.map(function (s) { return { value: s.nombreSucursal, label: s.nombreSucursal }; })}
                  showSearch={false}
                  allowClear
                  placeholder="Todas"
                  value={fSucursal}
                  onChange={function(v){ setFSucursal(v); }}
                  style={{ width: '100%' }}
                />
              </Col>

              <Col xs={24} md={8}>
                <label style={{ display: 'block', marginBottom: 4 }}>Categoría</label>
                <Select
                  options={categoriasOptions}
                  showSearch={false}
                  allowClear
                  placeholder="Todas"
                  value={fCategoria}
                  onChange={function(v){ setFCategoria(v); }}
                  style={{ width: '100%' }}
                />
              </Col>

              <Col xs={12} md={4}>
                <label style={{ display: 'block', marginBottom: 4 }}>Desde</label>
                <Input type="date" value={fDesde} onChange={function(e){ setFDesde(e.target.value); }} />
              </Col>
              <Col xs={12} md={4}>
                <label style={{ display: 'block', marginBottom: 4 }}>Hasta</label>
                <Input type="date" value={fHasta} onChange={function(e){ setFHasta(e.target.value); }} />
              </Col>

              <Col xs={12} md={4}>
                <label style={{ display: 'block', marginBottom: 4 }}>Precio min</label>
                <InputNumber
                  min={0} step={0.01} style={{ width: '100%' }}
                  value={fPrecioMin}
                  onChange={function(v){ setFPrecioMin(v); }}
                />
              </Col>
              <Col xs={12} md={4}>
                <label style={{ display: 'block', marginBottom: 4 }}>Precio max</label>
                <InputNumber
                  min={0} step={0.01} style={{ width: '100%' }}
                  value={fPrecioMax}
                  onChange={function(v){ setFPrecioMax(v); }}
                />
              </Col>

              <Col xs={12} md={4}>
                <label style={{ display: 'block', marginBottom: 4 }}>Stock min</label>
                <InputNumber
                  min={0} step={1} style={{ width: '100%' }}
                  value={fStockMin}
                  onChange={function(v){ setFStockMin(v); }}
                />
              </Col>
              <Col xs={12} md={4}>
                <label style={{ display: 'block', marginBottom: 4 }}>Stock max</label>
                <InputNumber
                  min={0} step={1} style={{ width: '100%' }}
                  value={fStockMax}
                  onChange={function(v){ setFStockMax(v); }}
                />
              </Col>

              <Col xs={24} md={8}>
                <Space wrap>
                  <Button onClick={function(){
                    setQ(''); setFSucursal(undefined); setFCategoria(undefined);
                    setFDesde(''); setFHasta('');
                    setFPrecioMin(null); setFPrecioMax(null);
                    setFStockMin(null); setFStockMax(null);
                  }}>
                    Limpiar filtros
                  </Button>
                  <Button type="default" icon={<icons.DownloadOutlined />} onClick={function(){
                    var headers = ['id','nombreProducto','categoria','precio','stock','fechaEntrada','descripcion','nombreSucursal'];
                    var rows = filtered.map(function(r){
                      var d = parseFechaFlexible(r.fechaEntrada);
                      var fecha = d ? formatYMD(d) : '';
                      function esc(x){
                        var s = (x == null ? '' : String(x));
                        if (s.indexOf('"') >= 0 || s.indexOf(',') >= 0 || s.indexOf('\n') >= 0) {
                          s = '"' + s.replace(/"/g, '""') + '"';
                        }
                        return s;
                      }
                      return [
                        esc(r.id),
                        esc(r.nombreProducto),
                        esc(r.categoria || ''),
                        esc(Number(r.precio || 0).toFixed(2)),
                        esc(r.stock),
                        esc(fecha),
                        esc(r.descripcion),
                        esc(r.nombreSucursal)
                      ].join(',');
                    });
                    var csv = headers.join(',') + '\n' + rows.join('\n');
                    var blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url; a.download = 'productos_filtrados.csv';
                    document.body.appendChild(a); a.click();
                    document.body.removeChild(a); URL.revokeObjectURL(url);
                  }}>
                    Exportar CSV (filtrado)
                  </Button>
                </Space>
              </Col>
            </Row>
          </Collapse.Panel>
        </Collapse>

        {/* === TABLA === */}
        <Table
          className="prd-table"
          dataSource={filtered}
          columns={columns}
          loading={loading}
          pagination={{ pageSize: 10 }}
          rowKey={function(r){ return (r && r.id != null) ? r.id : r.key; }}
          scroll={{ x: true }}
        />

        {/* === Modales === */}
        <Modal
          centered
          title={
            <Space>
              {modalMode === 'create' ? <icons.PlusOutlined /> :
               modalMode === 'edit' ? <icons.EditOutlined /> :
               <icons.PlusOutlined />}
              <span>
                {modalMode === 'create' ? 'Nuevo Producto' :
                 modalMode === 'edit' ? 'Editar Producto' :
                 'Agregar (copiar a otra sucursal)'}
              </span>
            </Space>
          }
          open={modalOpen} visible={modalOpen}
          maskClosable={false}
          keyboard={false}
          destroyOnClose
          confirmLoading={loading}
          okText={modalMode === 'create' ? 'Crear' : (modalMode === 'edit' ? 'Guardar' : 'Agregar')}
          cancelText="Cancelar"
          okButtonProps={{ disabled: (modalMode === 'duplicate' && !canSubmit) }}
          onCancel={function(){ setModalOpen(false); }}
          onOk={function(){ form.submit(); }}
          afterOpenChange={function(open){
            if(open){
              setTimeout(function(){
                var el = document.getElementById('nombreProductoInput');
                if(el) el.focus();
              }, 50);
            }
          }}
        >
          <Form form={form} layout="vertical" onFinish={onSubmit} onValuesChange={onFormValuesChange}>
            <Form.Item name="id" style={{ display: 'none' }}>
              <Input />
            </Form.Item>

            <Form.Item label="Nombre" name="nombreProducto"
              rules={[{ required: true, message: 'Ingrese el nombre del producto' }]}>
              <Input
                id="nombreProductoInput"
                placeholder="Ej. Shampoo"
                autoComplete="off"
                disabled={modalMode === 'duplicate'}  /* bloqueado en duplicado */
              />
            </Form.Item>

            {/* Categoría: libre + desplegable (bloqueada en duplicado) */}
            <Form.Item label="Categoría" name="categoria">
              <AutoComplete
                options={categoriasSelectOptions}
                disabled={modalMode === 'duplicate'}
                filterOption={function(inputValue, option){
                  var t = String(option?.value || '').toUpperCase();
                  return t.indexOf(String(inputValue || '').toUpperCase()) >= 0;
                }}
                open={catOpen && modalMode !== 'duplicate'}
                onFocus={function(){ if(modalMode !== 'duplicate') setCatOpen(true); }}
                onBlur={function(){ setCatOpen(false); }}
                onSelect={function(val){ form.setFieldsValue({ categoria: val }); }}
                onChange={function(val){ form.setFieldsValue({ categoria: (val || '').toString().toUpperCase() }); }}
              >
                <Input
                  placeholder="Ej. SUMINISTROS"
                  disabled={modalMode === 'duplicate'}
                  onClick={function(){ if(modalMode !== 'duplicate') setCatOpen(true); }}
                  onChange={function(e){
                    var up = (e.target.value || '').toUpperCase();
                    form.setFieldsValue({ categoria: up });
                  }}
                />
              </AutoComplete>
            </Form.Item>

            <Form.Item
              label="Precio Unitario (L.)"
              name="precio"
              rules={[
                { required: true, message: 'Ingrese el precio unitario' },
                {
                  validator: function(_, value) {
                    if (value === undefined || value === null || value === '') return Promise.resolve();
                    if (typeof value !== 'number' || isNaN(value)) return Promise.reject('SOLO NÚMEROS');
                    if (value < 0) return Promise.reject('EL PRECIO NO PUEDE SER NEGATIVO');
                    return Promise.resolve();
                  }
                }
              ]}
            >
              <InputNumber
                min={0}
                step={0.01}
                precision={2}
                style={{ width: '100%' }}
                placeholder="Ej. 100.00 – Precio Unitario"
              />
            </Form.Item>

            <Form.Item
              label="Stock"
              name="stock"
              rules={[
                { required: true, message: 'Ingrese el stock' },
                {
                  validator: function(_, value) {
                    if (value === undefined || value === null || value === '') return Promise.resolve();
                    if (typeof value !== 'number' || isNaN(value)) return Promise.reject('SOLO NÚMEROS');
                    if (value < 0) return Promise.reject('EL STOCK NO PUEDE SER NEGATIVO');
                    if (!Number.isInteger(value)) return Promise.reject('EL STOCK DEBE SER UN NÚMERO ENTERO');
                    return Promise.resolve();
                  }
                }
              ]}
            >
              <InputNumber
                min={0}
                step={1}
                precision={0}
                style={{ width: '100%' }}
                placeholder="Ej. 10"
              />
            </Form.Item>

            <Form.Item
              label="Fecha de Entrada"
              name="fechaEntrada"
              rules={[
                {
                  validator: function(_, value) {
                    if (!value) return Promise.resolve();
                    var d = parseInputDate(value);
                    if (!d) return Promise.reject('FECHA INVÁLIDA');
                    var hoy = new Date();
                    hoy.setHours(23,59,59,999);
                    if (d.getTime() > hoy.getTime()) return Promise.reject('LA FECHA NO PUEDE SER MAYOR A HOY');
                    return Promise.resolve();
                  }
                }
              ]}
            >
              <Input type="date" />
            </Form.Item>

            <Form.Item label="Descripción" name="descripcion">
              <Input.TextArea rows={3} placeholder="Detalles del producto" />
            </Form.Item>

            <Form.Item label="Sucursal" name="nombreSucursal"
              rules={[{ required: true, message: 'Seleccione una sucursal' }]}>
              <Select
                options={sucursales.map(function (s) { return { value: s.nombreSucursal, label: s.nombreSucursal }; })}
                showSearch={false}
                placeholder="Seleccione sucursal"
              />
            </Form.Item>
          </Form>
        </Modal>

        <Modal
          centered
          title="Eliminar Producto"
          open={deleteOpen} visible={deleteOpen}
          maskClosable={false}
          keyboard={false}
          destroyOnClose
          confirmLoading={loading}
          okText="Eliminar"
          cancelText="Cancelar"
          okButtonProps={{ danger: true }}
          onCancel={function(){ setDeleteOpen(false); setToDelete(null); }}
          onOk={confirmarEliminar}
        >
          <p>
            ¿Seguro que deseas eliminar el producto{' '}
            <b>{toDelete ? (toDelete.nombreProducto || ('ID ' + toDelete.id)) : ''}</b>?
          </p>
          <p>Esta acción no se puede deshacer.</p>
        </Modal>
      </Card>
    </div>
  );
}
//</script>
