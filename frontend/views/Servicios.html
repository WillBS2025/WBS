// <script type="text/jsx">
function Servicios() {
  const { useState, useEffect } = React;
  const { Table, Card, Button, Modal, Form, Input, InputNumber, Select, Space, Row, Col, Divider, message, Tag } = antd;

  // ===== Estado =====
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(false);
  const [sucursales, setSucursales] = useState([]);

  // Modal + formulario
  const [form] = Form.useForm();
  const [modalOpen, setModalOpen] = useState(false);
  const [modalMode, setModalMode] = useState('create'); // 'create' | 'edit'
  const [deleteOpen, setDeleteOpen] = useState(false);
  const [toDelete, setToDelete] = useState(null);

  // ===== Cargar servicios =====
  function cargar(){
    setLoading(true);
    google.script.run
      .withSuccessHandler(function(res){
        try{
          var arr = (typeof res === 'string') ? JSON.parse(res) : res;
          if (!Array.isArray(arr)) arr = [];
          var normalizados = arr.map(function(r,i){ return Object.assign({}, r, { key: (r && r.id != null ? r.id : i) }); });
          setData(normalizados);
        }catch(e){
          Modal.error({ title:'Error', content:'No se pudo leer la respuesta del servidor.' });
        } finally { setLoading(false); }
      })
      .withFailureHandler(function(err){
        setLoading(false);
        Modal.error({ title:'Error de servidor', content: String((err && err.message) || err) });
      })
      .listarServicios();
  }

  // ===== Cargar sucursales para el Select =====
  function cargarSucursales(){
    google.script.run
      .withSuccessHandler(function(res){
        try{
          var r = (typeof res === 'string') ? JSON.parse(res) : res;
          if (r && r.ok && r.sucursales) setSucursales(r.sucursales);
          else setSucursales([]);
        }catch(_){ setSucursales([]); }
      })
      .withFailureHandler(function(){ setSucursales([]); })
      .listarSucursalesActivas();
  }

  useEffect(function(){ cargar(); cargarSucursales(); }, []);

  // ===== Modales =====
  function abrirNuevo(){
    setModalMode('create');
    form.resetFields();
    setModalOpen(true);
  }
  function abrirEditar(rec){
    setModalMode('edit');
    form.setFieldsValue({
      id_servicios: rec.id_servicios,
      nombre_servicio: rec.nombre_servicio || '',
      descripcion: rec.descripcion || '',
      precio: (rec.precio != null ? Number(rec.precio) : null),
      nombre_sucursal: rec.nombre_sucursal || '',
      estado: rec.estado || 'Activo'
    });
    setModalOpen(true);
  }

  function abrirEliminar(rec){
    setToDelete(rec);
    setDeleteOpen(true);
  }

  // ===== Crear / Actualizar =====
  function onSubmit(){
    form.validateFields().then(function(values){
      setLoading(true);
      var payload = Object.assign({}, values);
      if (modalMode === 'create'){
        google.script.run
          .withSuccessHandler(function(res){
            setLoading(false);
            try{
              var r = (typeof res === 'string') ? JSON.parse(res) : res;
              if (r && r.ok){ message.success('Servicio creado'); setModalOpen(false); cargar(); }
              else { Modal.error({ title:'No se pudo crear', content: (r && r.message) || 'Error desconocido' }); }
            }catch(e){
              Modal.error({ title:'Error', content:'Respuesta inválida del servidor.' });
            }
          })
          .withFailureHandler(function(err){ setLoading(false); Modal.error({ title:'Error de servidor', content:String((err&&err.message)||err) }) })
          .crearServicio(payload);
      }else{
        google.script.run
          .withSuccessHandler(function(res){
            setLoading(false);
            try{
              var r = (typeof res === 'string') ? JSON.parse(res) : res;
              if (r && r.ok){ message.success('Servicio actualizado'); setModalOpen(false); cargar(); }
              else { Modal.error({ title:'No se pudo actualizar', content: (r && r.message) || 'Error desconocido' }); }
            }catch(e){
              Modal.error({ title:'Error', content:'Respuesta inválida del servidor.' });
            }
          })
          .withFailureHandler(function(err){ setLoading(false); Modal.error({ title:'Error de servidor', content:String((err&&err.message)||err) }) })
          .actualizarServicio(payload);
      }
    });
  }

  // ===== Eliminar =====
  function confirmarEliminar(){
    if (!toDelete) return;
    setLoading(true);
    google.script.run
      .withSuccessHandler(function(res){
        setLoading(false);
        try{
          var r = (typeof res === 'string') ? JSON.parse(res) : res;
          if (r && r.ok){ message.success('Servicio eliminado'); setDeleteOpen(false); setToDelete(null); cargar(); }
          else { Modal.error({ title:'No se pudo eliminar', content: (r && r.message) || 'Error desconocido' }); }
        }catch(e){ Modal.error({ title:'Error', content:'Respuesta inválida del servidor.' }); }
      })
      .withFailureHandler(function(err){ setLoading(false); Modal.error({ title:'Error de servidor', content:String((err&&err.message)||err) }) })
      .eliminarServicio(toDelete.id_servicios);
  }

  // ===== Columnas =====
  const columns = [
    { title:'Servicio', dataIndex:'nombre_servicio', key:'nombre_servicio', width:220,
      render: (v) => <b>{v || ''}</b> },
    { title:'Descripción', dataIndex:'descripcion', key:'descripcion' },
    { title:'Precio', dataIndex:'precio', key:'precio', width:110, align:'right',
      render: (v) => (v != null ? 'L.' + Number(v).toLocaleString('es-HN', { minimumFractionDigits:2, maximumFractionDigits:2 }) : '') },
    { title:'Sucursal', dataIndex:'nombre_sucursal', key:'nombre_sucursal', width:220 },
    { title:'Estado', dataIndex:'estado', key:'estado', width:110,
      render: (s) => <span className="ant-tag" style={{background:'#f6ffed', borderColor:'#b7eb8f', color:'#389e0d'}}>{s || ''}</span> },
    { title:'', key:'acciones', className:'col-actions', width:92, align:'center',
      render:(_,rec)=>(
        <Space direction="vertical" size={4}>
          <Button size="small" onClick={()=>abrirEditar(rec)} icon={<icons.EditOutlined />}>Editar</Button>
          <Button size="small" type="text" danger onClick={()=>abrirEliminar(rec)} icon={<icons.DeleteOutlined />}>Eliminar</Button>
        </Space>
      )
    }
  ];

  return (
    <Card title="Servicios" extra={(
      <Space>
        <Button icon={<icons.ReloadOutlined />} onClick={cargar}>Refrescar</Button>
        <Button type="primary" icon={<icons.ScissorOutlined />} onClick={abrirNuevo}>Nuevo</Button>
      </Space>
    )}>
      <Table dataSource={data} columns={columns} loading={loading} pagination={{ pageSize: 8 }} />
      
      {/* Modal Crear/Editar */}
      <Modal
        visible={modalOpen}
        onCancel={()=>setModalOpen(false)}
        onOk={onSubmit}
        title={modalMode === 'create' ? 'Nuevo Servicio' : 'Editar Servicio'}
        okText={modalMode === 'create' ? 'Crear' : 'Guardar'}
        confirmLoading={loading}
      >
        <Form form={form} layout="vertical">
          <Form.Item name="id_servicios" hidden><Input /></Form.Item>
          <Form.Item label="Nombre del servicio" name="nombre_servicio" rules={[{ required:true, message:'Ingrese el nombre del servicio' }]}>
            <Input placeholder="Ej. Corte de cabello" />
          </Form.Item>
          <Form.Item label="Descripción" name="descripcion">
            <Input.TextArea rows={3} placeholder="Detalles del servicio" />
          </Form.Item>
          <Form.Item label="Precio" name="precio" rules={[{ required:true, message:'Ingrese el precio' }]}>
            <InputNumber min={0} step={1} precision={2} style={{width:'100%'}} />
          </Form.Item>
          <Form.Item label="Sucursal" name="nombre_sucursal" rules={[{ required:true, message:'Seleccione una sucursal' }]}>
            <Select
              placeholder="Seleccione sucursal"
              options={(sucursales || []).map(function(s){ return { value: s.nombreSucursal, label: s.nombreSucursal }; })}
            />
          </Form.Item>
          <Form.Item label="Estado" name="estado" initialValue="Activo">
            <Select options={[{value:'Activo',label:'Activo'},{value:'Inactivo',label:'Inactivo'}]} />
          </Form.Item>
        </Form>
      </Modal>

      {/* Modal Eliminar */}
      <Modal visible={deleteOpen} onCancel={()=>{setDeleteOpen(false); setToDelete(null);}}
             title="Confirmar eliminación" okType="danger" okText="Eliminar"
             onOk={confirmarEliminar} confirmLoading={loading}>
        <p>¿Seguro que deseas eliminar el servicio <b>{toDelete ? (toDelete.nombre_servicio || ('ID ' + toDelete.id_servicios)) : ''}</b>?</p>
        <p>Esta acción no se puede deshacer.</p>
      </Modal>
    </Card>
  );
}
// </script>
