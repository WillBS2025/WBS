// <script type="text/jsx">
function Sucursales() {
  const { useState, useEffect, useRef } = React; // ← NUEVO useRef para animación KPI
  const { Table, Card, Button, Modal, Form, Input, Select, Space, Row, Col, Divider, message, Tag } = antd;

  // ===== Estado =====
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(false);

  // Modal + formulario
  const [form] = Form.useForm();
  const [modalOpen, setModalOpen] = useState(false);
  const [modalMode, setModalMode] = useState('create'); // 'create' | 'edit'
  const [deleteOpen, setDeleteOpen] = useState(false);
  const [toDelete, setToDelete] = useState(null);

  // ===== Helpers Fecha =====
  function parseFechaFlexible(v){
    if (v instanceof Date) return v;
    if (typeof v === 'number') return new Date(v);
    if (typeof v === 'string'){
      if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return new Date(v + 'T00:00:00');
      var m = v.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
      if (m){
        var d = parseInt(m[1],10), mo = parseInt(m[2],10)-1, y = parseInt(m[3],10); if (y < 100) y += 2000; return new Date(y,mo,d);
      }
      var d2 = new Date(v); if (!isNaN(d2)) return d2; return null;
    }
    var d0 = new Date(v); return isNaN(d0) ? null : d0;
  }
  function formatDDMMYYYY(d){
    var y = d.getFullYear();
    var m = String(d.getMonth()+1).padStart(2,'0');
    var day = String(d.getDate()).padStart(2,'0');
    return `${day}/${m}/${y}`;
  }
  function formatInputDate(d){
    var y = d.getFullYear(); var m = String(d.getMonth()+1).padStart(2,'0'); var day = String(d.getDate()).padStart(2,'0');
    return y + '-' + m + '-' + day;
  }

  // ===== Datos =====
  function cargar(){
    setLoading(true);
    google.script.run
      .withSuccessHandler(function(res){
        try{
          var arr = JSON.parse(res) || [];
          var normalizados = arr.map(function(r,i){ return Object.assign({}, r, { key: (r && r.id != null ? r.id : i) }); });
          setData(normalizados);
        }catch(e){
          Modal.error({ title:'Error', content:'No se pudo leer la respuesta del servidor.' });
        } finally { setLoading(false); }
      })
      .withFailureHandler(function(err){
        setLoading(false);
        Modal.error({ title:'Error de servidor', content: String((err && err.message) || err) });
      })
      .sucursales_listar();                    // ← antes: .listarSucursales()
  }
  useEffect(function(){ cargar(); }, []);

  // ===== Modales =====
  function abrirNuevo(){ setModalMode('create'); form.resetFields(); setModalOpen(true); }
  function abrirEditar(rec){
    setModalMode('edit');
    var d = parseFechaFlexible(rec.fechaInauguracion);
    form.setFieldsValue({
      id: rec.id,
      nombreSucursal: rec.nombreSucursal || '',
      telefono: rec.telefono || '',
      direccion: rec.direccion || '',
      correoElectronico: rec.correoElectronico || '',
      estado: rec.estado || 'Activo',
      fechaInauguracion: d ? formatInputDate(d) : ''
    });
    setModalOpen(true);
  }
  function abrirEliminar(rec){ setToDelete(rec); setDeleteOpen(true); }

  // ===== Crear/Actualizar =====
  function onSubmit(values){
    var payload = Object.assign({}, values);
    if (!payload.estado) payload.estado = 'Activo';

    setLoading(true);
    if (modalMode === 'create'){
      delete payload.id;
      google.script.run
        .withSuccessHandler(function(res){
          setLoading(false);
          try{
            var r = typeof res === 'string' ? JSON.parse(res) : res;
            if (r && r.ok){ message.success('Sucursal creada'); setModalOpen(false); cargar(); }
            else { Modal.error({ title:'No se pudo crear', content: (r && r.message) || 'Error desconocido' }); }
          }catch(e){ Modal.error({ title:'Error', content:'Respuesta inválida del servidor.' }); }
        })
        .withFailureHandler(function(err){ setLoading(false); Modal.error({ title:'Error de servidor', content: String((err && err.message) || err) }); })
        .sucursales_crear(payload);            // ← antes: .crearSucursal(...)
    } else {
      google.script.run
        .withSuccessHandler(function(res){
          setLoading(false);
          try{
            var r = typeof res === 'string' ? JSON.parse(res) : res;
            if (r && r.ok){ message.success('Sucursal actualizada'); setModalOpen(false); cargar(); }
            else { Modal.error({ title:'No se pudo actualizar', content: (r && r.message) || 'Error desconocido' }); }
          }catch(e){ Modal.error({ title:'Error', content:'Respuesta inválida del servidor.' }); }
        })
        .withFailureHandler(function(err){ setLoading(false); Modal.error({ title:'Error de servidor', content: String((err && err.message) || err) }); })
        .sucursales_actualizar(payload);       // ← antes: .actualizarSucursal(...)
    }
  }

  // ===== Eliminar =====
  function confirmarEliminar(){
    if (!toDelete) return;
    setLoading(true);
    google.script.run
      .withSuccessHandler(function(res){
        setLoading(false);
        try{
          var r = typeof res === 'string' ? JSON.parse(res) : res;
          if (r && r.ok){ message.success('Sucursal eliminada'); setDeleteOpen(false); setToDelete(null); cargar(); }
          else { Modal.error({ title:'No se pudo eliminar', content: (r && r.message) || 'Error desconocido' }); }
        }catch(e){ Modal.error({ title:'Error', content:'Respuesta inválida del servidor.' }); }
      })
      .withFailureHandler(function(err){ setLoading(false); Modal.error({ title:'Error de servidor', content: String((err && err.message) || err) }); })
      .sucursales_eliminar(toDelete.id);       // ← antes: .eliminarSucursal(...)
  }

  // ===== Columnas (sin ID, Dirección ancha, Acciones compactas) =====
  const columns = [
    {
      title:'Sucursal',
      dataIndex:'nombreSucursal',
      key:'nombreSucursal',
      width:220,
      render: (t) => <b>{t}</b>,
    },
    {
      title:'Dirección',
      dataIndex:'direccion',
      key:'direccion',
      className:'col-direccion',
      onCell: () => ({ style: { whiteSpace:'normal', wordBreak:'break-word' } }),
      width:360,
    },
    {
      title:'Teléfono',
      dataIndex:'telefono',
      key:'telefono',
      width:130,
    },
    {
      title:'Correo',
      dataIndex:'correoElectronico',
      key:'correoElectronico',
      width:240,
      ellipsis:true,
    },
    {
      title:'Inauguración',
      dataIndex:'fechaInauguracion',
      key:'fechaInauguracion',
      width:130,
      render: (v) => {
        var d = parseFechaFlexible(v);
        return d ? formatDDMMYYYY(d) : '';
      }
    },
    {
      title:'Estado',
      dataIndex:'estado',
      key:'estado',
      width:110,
      render: (s) => <span className="ant-tag" style={{background:'#f6ffed', borderColor:'#b7eb8f', color:'#389e0d'}}>{s || ''}</span>
    },
    {
      title:'',
      key:'acciones',
      className:'col-actions',
      width:92,
      align:'center',
      render:(_,rec)=>(
        <Space direction="vertical" size={4}>
          <Button size="small" onClick={()=>abrirEditar(rec)} icon={<icons.EditOutlined />}>Editar</Button>
          <Button size="small" type="text" danger onClick={()=>abrirEliminar(rec)} icon={<icons.DeleteOutlined />}>Eliminar</Button>
        </Space>
      )
    }
  ];

  // ======== NUEVO: KPIs simples (no afectan sidebar) ========
  function edadEnDias(d){
    var dt = parseFechaFlexible(d); if (!dt) return null;
    var ms = Date.now() - dt.getTime(); return Math.max(0, Math.floor(ms/86400000));
  }
  function promedio(arr){
    if (!arr.length) return 0;
    return arr.reduce((a,b)=>a+(b||0),0)/arr.length;
  }
  const total = data.length;
  const activas = data.filter(r => String(r.estado||'')==='Activo').length;
  const inactivas = data.filter(r => String(r.estado||'')==='Inactivo').length;
  const edades = data.map(r=>edadEnDias(r.fechaInauguracion)).filter(x=>x!=null);
  const antiguedadPromAnos = edades.length ? (promedio(edades)/365).toFixed(1) : 0;

  // KPI animadito (autónomo y seguro)
  function useCountUp(value, duration=700){
    const [display, setDisplay] = useState(0);
    const prevRef = useRef(0);
    useEffect(()=>{
      const start = performance.now();
      const from = prevRef.current;
      const to = Number(value||0);
      let raf;
      function tick(t){
        const p = Math.min(1, (t - start)/duration);
        const eased = 1 - Math.pow(1 - p, 3);
        setDisplay(from + (to - from) * eased);
        if (p < 1) raf = requestAnimationFrame(tick);
      }
      raf = requestAnimationFrame(tick);
      prevRef.current = to;
      return ()=> cancelAnimationFrame(raf);
    }, [value, duration]);
    return display;
  }
  function KPI({ title, value, suffix }){
    const v = useCountUp(value);
    return (
      <Card bodyStyle={{ padding: 14 }} className="suc-kpi">
        <div className="suc-kpi-sub">{title}</div>
        <div className="suc-kpi-val">{Math.round(Number(v))}{suffix||''}</div>
      </Card>
    );
  }

  return (
    <div className="sucursales-wrap">
      <Card
        title={<div className="suc-hero-title"><span className="suc-spark"></span>Sucursales</div>}
        extra={
          <Space>
            <Button onClick={cargar} loading={loading} icon={<icons.ReloadOutlined />}>Refrescar</Button>
            <Button type="primary" onClick={abrirNuevo} icon={<icons.PlusOutlined />}>Nuevo</Button>
          </Space>
        }
      >
        {/* ======== ESTILOS SCOPEADOS (no tocan el sidebar) ======== */}
        <style>{`
          .sucursales-wrap * { box-sizing: border-box; }
          .suc-hero-title{ position:relative; padding-left:12px; font-weight:800; }
          .suc-spark{
            position:absolute; left:0; top:6px; width:6px; height:22px; border-radius:3px;
            background: linear-gradient(180deg,#60a5fa,#a78bfa,#34d399);
            animation: sucSpark 2.6s ease-in-out infinite;
          }
          @keyframes sucSpark{ 0%{opacity:.4; transform:translateY(0)} 50%{opacity:1; transform:translateY(6px)} 100%{opacity:.4; transform:translateY(0)} }

          /* KPIs */
          .suc-kpi{ border-radius:14px; background: linear-gradient(135deg,#e0eaff,#e9fff6); box-shadow: 0 2px 10px rgba(15,23,42,.06); }
          .suc-kpi-sub{ font-size:12px; color:#6b7280 }
          .suc-kpi-val{ font-size:26px; font-weight:800; color:#0f172a }

          /* Centrar tabla y darle “card feel” */
          .sucursales-wrap .tbl-center{ max-width: 1200px; margin: 0 auto; }
          .sucursales-wrap .sucursales-table .ant-table{ border-radius:14px; overflow:hidden; }
          .sucursales-wrap .sucursales-table .ant-table-thead > tr > th{
            background:#f8fafc !important; border-bottom:0; color:#334155; font-weight:700;
          }
          .sucursales-wrap .sucursales-table .ant-table-tbody > tr{
            transition: transform .15s ease, box-shadow .15s ease, background .2s;
            animation: sucFadeUp .35s ease both;
          }
          @keyframes sucFadeUp{ from{ opacity:0; transform:translateY(6px) } to{ opacity:1; transform:translateY(0) } }
          .sucursales-wrap .sucursales-table .ant-table-tbody > tr:hover{
            transform: scale(1.01); box-shadow: 0 10px 24px rgba(2,6,23,.08);
          }
          .sucursales-wrap .sucursales-table .ant-table-tbody > tr:nth-child(odd) td{ background:#fcfdff; }
        `}</style>

        {/* ======== DASHBOARDS (no afectan lógica) ======== */}
        <Row gutter={[12,12]} style={{ marginBottom: 8 }}>
          <Col xs={24} sm={8}><KPI title="Antigüedad promedio" value={antiguedadPromAnos} suffix=" años" /></Col>
          <Col xs={24} sm={8}><KPI title="Activas" value={activas} /></Col>
          <Col xs={24} sm={8}><KPI title="Inactivas" value={inactivas} /></Col>
        </Row>

        {/* ======== TABLA (SIN CAMBIOS FUNCIONALES) ======== */}
        <div className="tbl-center">
          <Table
            className="sucursales-table"
            dataSource={data}
            columns={columns}
            loading={loading}
            pagination={false}
            rowKey={(r)=> (r && r.id != null) ? r.id : r.key}
            tableLayout="auto"
            scroll={{ x: true }}
          />
        </div>

        {/* Modal Crear/Editar */}
        <Modal
          centered
          title={modalMode === 'create' ? 'Nueva Sucursal' : 'Editar Sucursal'}
          open={modalOpen}
          visible={modalOpen}
          okText={modalMode === 'create' ? 'Crear' : 'Guardar'}
          cancelText="Cancelar"
          maskClosable={false}
          keyboard={false}
          onCancel={()=> setModalOpen(false)}
          onOk={()=> form.submit()}
        >
          <Form form={form} layout="vertical" onFinish={onSubmit}>
            <Form.Item name="id" style={{ display:'none' }}><Input /></Form.Item>

            <Form.Item label="Nombre" name="nombreSucursal" rules={[{ required:true, message:'Ingrese el nombre' }]}>
              <Input placeholder="Ej. WBS - Sede Centro" autoComplete="off" />
            </Form.Item>

            <Form.Item label="Fecha de Inauguración" name="fechaInauguracion">
              <Input type="date" />
            </Form.Item>

            <Form.Item label="Teléfono" name="telefono">
              <Input placeholder="Ej. 2510-5645" />
            </Form.Item>

            <Form.Item label="Dirección" name="direccion">
              <Input.TextArea rows={2} placeholder="Ej. Barrio Guamilito" />
            </Form.Item>

            <Form.Item label="Correo electrónico" name="correoElectronico" rules={[{ type:'email', message:'Correo inválido' }]}>
              <Input placeholder="ejemplo@correo.com" />
            </Form.Item>

            <Form.Item label="Estado" name="estado" rules={[{ required:true, message:'Seleccione el estado' }]} initialValue="Activo">
              <Select options={[ {value:'Activo',label:'Activo'}, {value:'Inactivo',label:'Inactivo'} ]} />
            </Form.Item>
          </Form>
        </Modal>

        {/* Modal Eliminar */}
        <Modal
          centered
          title="Eliminar Sucursal"
          open={deleteOpen}
          visible={deleteOpen}
          maskClosable={false}
          keyboard={false}
          onCancel={()=>{ setDeleteOpen(false); setToDelete(null); }}
          onOk={confirmarEliminar}
        >
          <p>¿Seguro que deseas eliminar la sucursal <b>{toDelete ? (toDelete.nombreSucursal || ('ID ' + toDelete.id)) : ''}</b>?</p>
          <p>Esta acción no se puede deshacer.</p>
        </Modal>
      </Card>
    </div>
  );
}

// </script>
