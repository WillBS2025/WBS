
<div id="SucursalesView"></div>
<script type="text/babel">
function Sucursales(){
  const { useState, useEffect } = React;
  const { Table, Card, Button, Modal, Form, Input, Select, Space, message } = antd;

  /************* estado *************/
  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(false);
  const [open, setOpen] = useState(false);
  const [mode, setMode] = useState("create");
  const [form] = Form.useForm();
  const [toDelete, setToDelete] = useState(null);
  const [openDelete, setOpenDelete] = useState(false);

  /************* utils *************/
  function safeParse(x){
    try{ return (typeof x === 'string') ? JSON.parse(x) : x; }catch(e){ return x; }
  }
  function normalizarListado(raw){
    const arr = safeParse(raw);
    if (Array.isArray(arr)) return arr;
    if (arr && Array.isArray(arr.data)) return arr.data;
    if (arr && Array.isArray(arr.rows)) return arr.rows;
    return [];
  }

  /************* carga *************/
  function cargar(){
    setLoading(true);
    google.script.run
      .withSuccessHandler(function(res){
        setLoading(false);
        setRows(normalizarListado(res));
      })
      .withFailureHandler(function(err){
        setLoading(false);
        Modal.error({ title:'Error de servidor', content: String((err && err.message) || err) });
      })
      .listarSucursales();
  }
  useEffect(cargar, []);

  /************* abrir modales *************/
  function abrirNuevo(){
    setMode("create");
    form.resetFields();
    form.setFieldsValue({ estado: "Activo" });
    setOpen(true);
  }
  function abrirEditar(rec){
    setMode("edit");
    form.setFieldsValue({
      id: rec.id,
      nombreSucursal: rec.nombreSucursal || "",
      direccion: rec.direccion || "",
      telefono: rec.telefono || "",
      correoElectronico: rec.correoElectronico || "",
      fechaInauguracion: rec.fechaInauguracion || "",
      estado: rec.estado || "Activo"
    });
    setOpen(true);
  }
  function abrirEliminar(rec){
    setToDelete(rec); setOpenDelete(true);
  }

  /************* submit create/update *************/
  function onSubmit(){
    form.validateFields().then(values => {
      setLoading(true);
      const fn = (mode === "create") ? "crearSucursal" : "actualizarSucursal";
      google.script.run
        .withSuccessHandler(function(res){
          setLoading(false);
          const r = safeParse(res);
          if (r && (r.ok || r.id)){
            message.success(mode==="create" ? "Sucursal creada" : "Sucursal actualizada");
            setOpen(false);
            cargar();
          } else {
            Modal.error({ title:"Error", content: (r && r.message) || "Operación fallida" });
          }
        })
        .withFailureHandler(function(err){
          setLoading(false);
          Modal.error({ title:"Error de servidor", content: String((err && err.message) || err) });
        })[fn](JSON.stringify(values));
    });
  }

  /************* eliminar *************/
  function confirmarEliminar(){
    if (!toDelete) return;
    setLoading(true);
    google.script.run
      .withSuccessHandler(function(res){
        setLoading(false);
        const r = safeParse(res);
        if (r && (r.ok)){
          message.success("Sucursal eliminada");
          setOpenDelete(false); setToDelete(null);
          cargar();
        } else {
          Modal.error({ title:"Error", content: (r && r.message) || "No se pudo eliminar" });
        }
      })
      .withFailureHandler(function(err){
        setLoading(false);
        Modal.error({ title:"Error de servidor", content:String((err && err.message) || err) });
      })
      .eliminarSucursal(String(toDelete.id));
  }

  /************* columnas *************/
  const cols = [
    { title:'Sucursal', dataIndex:'nombreSucursal', key:'nombreSucursal' },
    { title:'Dirección', dataIndex:'direccion', key:'direccion' },
    { title:'Teléfono', dataIndex:'telefono', key:'telefono' },
    { title:'Correo', dataIndex:'correoElectronico', key:'correoElectronico' },
    { title:'Inauguración', dataIndex:'fechaInauguracion', key:'fechaInauguracion' },
    { title:'Estado', dataIndex:'estado', key:'estado' },
    {
      title:'Acciones',
      key:'acciones',
      render: (_, rec) => (
        <Space>
          <Button type="link" onClick={() => abrirEditar(rec)}>Editar</Button>
          <Button type="link" danger onClick={() => abrirEliminar(rec)}>Eliminar</Button>
        </Space>
      )
    }
  ];

  /************* render *************/
  return (
    <Card
      title="Sucursales"
      extra={<Space><Button onClick={cargar}>Refrescar</Button><Button type="primary" onClick={abrirNuevo}>Nueva</Button></Space>}
    >
      <Table rowKey={r=>String(r.id)} loading={loading} columns={cols} dataSource={rows} pagination={false} />

      <Modal
        title={mode==="create" ? "Nueva sucursal" : "Editar sucursal"}
        open={open} visible={open}
        onCancel={()=>setOpen(false)}
        onOk={onSubmit}
        okText="Guardar" cancelText="Cancelar"
        confirmLoading={loading}
        destroyOnClose maskClosable={false} keyboard={false}
      >
        <Form form={form} layout="vertical">
          <Form.Item name="id" style={{display:'none'}}><Input /></Form.Item>

          <Form.Item name="nombreSucursal" label="Sucursal" rules={[{required:true, message:"Ingrese el nombre"}]}>
            <Input />
          </Form.Item>

          <Form.Item name="direccion" label="Dirección" rules={[{required:true, message:"Ingrese la dirección"}]}>
            <Input />
          </Form.Item>

          <Form.Item name="telefono" label="Teléfono">
            <Input />
          </Form.Item>

          <Form.Item name="correoElectronico" label="Correo">
            <Input type="email" />
          </Form.Item>

          <Form.Item name="fechaInauguracion" label="Inauguración">
            <Input placeholder="dd/mm/aaaa" />
          </Form.Item>

          <Form.Item name="estado" label="Estado" rules={[{required:true}]}>
            <Select options={[{value:'Activo', label:'Activo'}, {value:'Inactivo', label:'Inactivo'}]} />
          </Form.Item>
        </Form>
      </Modal>

      <Modal
        open={openDelete} visible={openDelete}
        onCancel={()=>{ setOpenDelete(false); setToDelete(null); }}
        onOk={confirmarEliminar}
        okText="Eliminar" okType="danger" cancelText="Cancelar"
        confirmLoading={loading}
      >
        <p>¿Eliminar la sucursal <b>{toDelete ? toDelete.nombreSucursal : ""}</b>?</p>
      </Modal>
    </Card>
  );
}
ReactDOM.render(<Sucursales/>, document.getElementById('SucursalesView'));
</script>
