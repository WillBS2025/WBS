//<script type="text/jsx">

function Login({ onLogin }) {
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);

  const onFinish = (values) => {
    setLoading(true);

    google.script.run
      .withSuccessHandler((resp) => {
        setLoading(false);

        if (resp && resp.success) {
          if (resp.message) message.success(resp.message);

          const raw = resp.user || {};
          const username = raw.nombre_usuario || values.nombre_usuario || raw.username || "";
          const email = raw.email || raw.correo || "";
          const baseName =
            raw.nombre_usuario ||
            raw.nombre || raw.name || raw.fullName || raw.displayName ||
            (username ? String(username).split("@")[0] : "Usuario");

          const user = {
            nombre_usuario: String(username || "").trim(),
            name: String(baseName || "").trim() || "Usuario",
            email: String(email || "").trim() || "",
            nombreCompleto: String(raw.nombreCompleto || raw.fullName || raw.name || "").trim()
          };

          try {
            localStorage.setItem("userInfo", JSON.stringify(user));
            localStorage.setItem("userRole", resp.role || raw.rol || "admin");
          } catch (_) {}

          onLogin(true);
        } else {
          Modal.error({
            title: "Error de autenticación",
            content: (resp && resp.message) || "Credenciales inválidas",
          });
          onLogin(false);
        }
      })
      .withFailureHandler((error) => {
        setLoading(false);
        Modal.error({
          title: "Error de comunicación",
          content: "Ha ocurrido un error al intentar iniciar sesión. Por favor, inténtalo de nuevo más tarde.",
        });
        console.error("Error al llamar a Apps Script:", error);
      })
      .verificarCredenciales(values.nombre_usuario, values.contrasenia);
  };

  // ========= Logo inmediato (inline / cache local) =========
  useEffect(() => {
    window.APP_BRAND = 'WILITO Barber Shop';

    // 1) Si ya viene inline o hay cache local → pinta al toque
    let inline = window.APP_LOGO_LOGIN;
    let cached = null;
    try { cached = JSON.parse(localStorage.getItem('LOGIN_LOGO_JSON') || 'null'); } catch (_){}

    const r = inline || cached;
    const img = document.getElementById('login-logo');
    if (r && img) {
      img.src = r.src;
      if (r.srcSet) img.setAttribute('srcset', r.srcSet);
    }

    // 2) Fallback (por si no vino inline) — se guarda en cache local
    if (!inline && !cached) {
      google.script.run.withSuccessHandler((resp) => {
        if (!resp) return;
        try { localStorage.setItem('LOGIN_LOGO_JSON', JSON.stringify(resp)); } catch(_){}
        const el = document.getElementById('login-logo');
        if (el) {
          el.src = resp.src;
          if (resp.srcSet) el.setAttribute('srcset', resp.srcSet);
        }
      }).getLoginLogo();
    }
  }, []);
  // =========================================================

  // Estilo de texto con “oro viejo”
  const goldText = {
    backgroundImage: "linear-gradient(135deg,#bfa46f 0%, #a3874a 35%, #bfa46f 70%, #8f7a45 100%)",
    WebkitBackgroundClip: "text",
    backgroundClip: "text",
    color: "transparent",
  };

  return (
    <div className="relative min-h-screen flex items-center justify-center font-sans overflow-hidden">
      <div className="absolute inset-0 bg-animated"></div>

      <div className="relative z-10 w-full max-w-md px-6">
        <Card
          className="shadow-xl rounded-2xl"
          style={{
            background: "linear-gradient(145deg, #111 0%, #1b1b1b 100%)",
            border: "1px solid #bfa46f",
            boxShadow: "0 0 20px rgba(191,164,111,0.25)",
          }}
          headStyle={{ borderBottom: "none", padding: 0 }}
          bodyStyle={{ padding: 28 }}
          title={
            <div className="flex flex-col items-center space-y-3 select-none">
              {/* ====== LOGO CIRCULAR MÁS PEQUEÑO ====== */}
              <img
                id="login-logo"
                alt="WILITO Barber Shop"
                width="120"
                height="120"
                decoding="async"
                style={{
                  width: 135,            // ajusta 110–135 a tu gusto
                  height: 135,
                  objectFit: 'contain',  // muestra TODO tu PNG sin recorte
                  borderRadius: '50%',   // círculo (déjalo si así lo quieres)
                  border: '2px solid #bfa46f',
                  background: 'transparent',  // tu imagen ya es sin fondo
                  boxShadow: '0 0 18px rgba(191,164,111,0.22)',
                  padding: 2
                }}
              />


              {/* ====== ORIGINAL "WB" (conservado oculto) ====== */}
              {false && (
                <div className="w-20 h-20 flex items-center justify-center rounded-full border-2 border-[#bfa46f] shadow-md bg-[#111]">
                  <span className="text-3xl font-extrabold tracking-wide text-[#bfa46f]">WB</span>
                </div>
              )}

              <h1 className="text-2xl font-extrabold tracking-wide" style={goldText}>
                Wilito BarberShop
              </h1>

              <div
                style={{
                  width: 120,
                  height: 1,
                  backgroundImage:
                    "linear-gradient(90deg, transparent, #bfa46f 20%, #a3874a 50%, #bfa46f 80%, transparent)",
                  opacity: 0.9,
                }}
              />
              <p className="text-sm" style={{ color: "#bdb7a6" }}>
                Elegancia • Estilo • Tradición
              </p>
            </div>
          }
        >
          <Form form={form} name="login" initialValues={{ remember: true }} onFinish={onFinish} layout="vertical">
            <Item
              label={<span style={{ color: "#bfa46f", fontWeight: "600" }}>Usuario</span>}
              name="nombre_usuario"
              rules={[
                { required: true, message: '¡Por favor ingresa tu usuario!' },
                {  },
              ]}
            >
              <Input
                size="large"
                className="rounded-md dark-input"
                prefix={<icons.UserOutlined style={{ color: "#bfa46f" }} />}
                placeholder="usuario (ej. andresp)"
              />
            </Item>

            <Item
              label={<span style={{ color: "#bfa46f", fontWeight: "600" }}>Contraseña</span>}
              name="contrasenia"
              rules={[{ required: true, message: "¡Por favor ingresa tu contraseña!" }]}
            >
              <Input.Password
                size="large"
                className="rounded-md dark-input"
                prefix={<icons.LockOutlined style={{ color: "#bfa46f" }} />}
                placeholder="••••••••"
              />
            </Item>

            <div className="flex items-center justify-between mb-4">
              <span className="text-sm text-gray-400 hover:underline cursor-pointer">
                ¿Olvidaste tu contraseña?
              </span>
            </div>

            <Item>
              <Button
                type="primary"
                htmlType="submit"
                loading={loading}
                block
                size="large"
                className="rounded-md shadow-md hover:shadow-lg transition-all duration-300"
                style={{
                  background: "linear-gradient(135deg,#bfa46f,#a3874a,#bfa46f)",
                  border: "none",
                  color: "#111",
                  fontWeight: "bold",
                  letterSpacing: "0.5px",
                  textTransform: "uppercase",
                }}
              >
                Ingresar
              </Button>
            </Item>

            <div className="text-center text-xs text-gray-500 mt-4">
              © {new Date().getFullYear()} Wilito BarberShop • Todos los derechos reservados
            </div>
          </Form>
        </Card>
      </div>
    </div>
  );
}

//</script>
