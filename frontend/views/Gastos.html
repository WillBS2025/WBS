// <script type="text/jsx">
function Gastos() {
  const { useState, useEffect, useMemo, useRef } = React;
  const { Table, Card, Button, Modal, Form, Input, InputNumber, Select, Space, Row, Col, Tag, message, Tooltip, Divider, Collapse } = antd;

  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(false);
  const [sucursales, setSucursales] = useState([]);
  const [form] = Form.useForm();
  const [modalOpen, setModalOpen] = useState(false);
  const [modalMode, setModalMode] = useState('create');
  const [editing, setEditing] = useState(null);
  const [lockCategoria, setLockCategoria] = useState(false);

  const today = new Date();
  const defaultMonth = String(today.getFullYear()) + '-' + String(today.getMonth()+1).padStart(2,'0');
  const [mesYear, setMesYear] = useState(defaultMonth);
  const [fCategoria, setFCategoria] = useState(undefined);
  const [fSucursal, setFSucursal] = useState(undefined);
  const [q, setQ] = useState('');

  const CATEGORIAS = ['Luz','Agua','Internet','Salarios','Alquiler','Insumos','Limpieza','Mantenimiento','Publicidad','Impuestos','Servicios Profesionales','Otros'];
  const METODOS = ['Efectivo','Tarjeta','Transferencia','Cheque','Otro'];

  const initialMontoRef = useRef(null);

  const PALETTE = ['#7FB3FF','#9FD3FF','#B8E1C6','#FFD6A5','#F9A8D4','#C3B8FF','#BDE0FE','#CFF5E7','#FFE3B3','#D0BCFF','#B0BEC5','#C6E2FF'];

  // --------- UTILIDADES ---------
  function formatHNL(value) {
    var n = Number(value);
    if (!isFinite(n)) n = 0;
    try { return new Intl.NumberFormat('es-HN', { style: 'currency', currency: 'HNL', maximumFractionDigits: 2 }).format(n); }
    catch(_) { return 'L. ' + (Math.round(n * 100) / 100).toFixed(2); }
  }
  function toInputDate(d){
    if (!d) return '';
    var y = d.getFullYear();
    var m = String(d.getMonth()+1).padStart(2,'0');
    var day = String(d.getDate()).padStart(2,'0');
    return y + '-' + m + '-' + day;
  }
  function parseInputDate(s){
    if (!s) return null;
    var m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return null;
    return new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
  }
  function safeDate(v){
    try{ return (v && typeof v === 'string') ? new Date(v) : (v instanceof Date ? v : new Date(v)); }catch(_){ return null; }
  }
  function formatPercent(v, total){
    const t = Number(total) || 0;
    if (t <= 0) return '0%';
    return Math.round((Number(v||0)*100)/t) + '%';
  }

  // --------- CARGA DE DATOS ---------
  function cargar() {
    setLoading(true);
    var m = 0, y = 0;
    if (mesYear && /^\d{4}-\d{2}$/.test(mesYear)) {
      y = Number(mesYear.slice(0,4));
      m = Number(mesYear.slice(5,7));
    }
    var filtros = { mes: m, anio: y };
    if (fCategoria) filtros.categoria = fCategoria;
    if (fSucursal) filtros.nombreSucursal = fSucursal;
    if (q && q.trim()) filtros.q = q.trim();

    google.script.run
      .withSuccessHandler(function(res){
        setLoading(false);
        try{
          var arr = JSON.parse(res) || [];
          var normalized = arr.map(function(r,i){
            var d = r && r.fecha;
            if (d && typeof d === 'string' && /^\d{4}-\d{2}-\d{2}/.test(d)) {
              try { r.fecha = new Date(d); } catch(_){}
            }
            return Object.assign({}, r, { key: (r && r.id != null ? r.id : i) });
          });
          setData(normalized);
        }catch(e){
          Modal.error({ title: 'ERROR', content: 'RESPUESTA INVÁLIDA DEL SERVIDOR' });
        }
      })
      .withFailureHandler(function(err){
        setLoading(false);
        Modal.error({ title: 'ERROR DE SERVIDOR', content: String((err && err.message) || err) });
      })
      .listarGastos(JSON.stringify(filtros));
  }

  function cargarSucursales(){
    google.script.run
      .withSuccessHandler(function(res){
        try{
          var r = (typeof res === 'string') ? JSON.parse(res) : res;
          var arr = Array.isArray(r) ? r : (r && r.ok && Array.isArray(r.sucursales) ? r.sucursales : []);
          setSucursales(arr || []);
        }catch(_){ setSucursales([]); }
      })
      .withFailureHandler(function(){ setSucursales([]); })
      .sucursales_listar_activas();
  }

  useEffect(function(){
    cargar();
    cargarSucursales();
  }, []);

  useEffect(function(){ cargar(); }, [mesYear, fCategoria, fSucursal]);

  // --------- MODALES / CRUD ---------
  function abrirNuevo(){
    setModalMode('create');
    setEditing(null);
    setLockCategoria(false);
    form.resetFields();
    var montoInicial = 0;
    initialMontoRef.current = montoInicial;
    form.setFieldsValue({
      fecha: toInputDate(new Date()),
      categoria: undefined,
      descripcion: '',
      monto: montoInicial,
      metodoPago: undefined,
      proveedor: '',
      nombreSucursal: undefined
    });
    setModalOpen(true);
  }

  function abrirEditar(record){
    setModalMode('edit');
    setEditing(record || null);
    setLockCategoria(false);
    form.resetFields();
    var montoInicial = Number(record.monto || 0);
    initialMontoRef.current = montoInicial;
    form.setFieldsValue({
      id: record.id,
      fecha: toInputDate(record.fecha ? new Date(record.fecha) : new Date()),
      categoria: record.categoria || undefined,
      descripcion: record.descripcion || '',
      monto: montoInicial,
      metodoPago: record.metodoPago || undefined,
      proveedor: record.proveedor || '',
      nombreSucursal: record.nombreSucursal || undefined
    });
    setModalOpen(true);
  }

  function abrirNuevoPago(record){
    setModalMode('create');
    setEditing(null);
    setLockCategoria(true);
    form.resetFields();
    var montoInicial = Number(record.monto || 0);
    initialMontoRef.current = montoInicial;
    form.setFieldsValue({
      fecha: toInputDate(new Date()),
      categoria: record.categoria || undefined,
      descripcion: record.descripcion || '',
      monto: montoInicial,
      metodoPago: record.metodoPago || undefined,
      proveedor: record.proveedor || '',
      nombreSucursal: record.nombreSucursal || undefined
    });
    setModalOpen(true);
  }

  function onSubmit(){
    form.validateFields().then(function(values){
      setLoading(true);
      var payload = {
        fecha: parseInputDate(values.fecha),
        categoria: values.categoria || '',
        descripcion: values.descripcion || '',
        monto: Number(values.monto || 0),
        metodoPago: values.metodoPago || '',
        proveedor: values.proveedor || '',
        nombreSucursal: values.nombreSucursal || ''
      };

      if (modalMode === 'create') {
        google.script.run
          .withSuccessHandler(function(res){
            setLoading(false);
            try{
              var r = typeof res === 'string' ? JSON.parse(res) : res;
              if (r && r.ok){
                message.success('Gasto creado');
                setModalOpen(false);
                cargar();
              }else{
                Modal.error({ title:'NO SE PUDO CREAR', content: (r && r.message) || 'Error desconocido' });
              }
            }catch(_){
              Modal.error({ title:'ERROR', content:'RESPUESTA INVÁLIDA DEL SERVIDOR' });
            }
          })
          .withFailureHandler(function(err){
            setLoading(false);
            Modal.error({ title:'ERROR DE SERVIDOR', content: String((err && err.message) || err) });
          })
          .crearGasto(JSON.stringify(payload));
      } else {
        payload.id = editing && editing.id;
        google.script.run
          .withSuccessHandler(function(res){
            setLoading(false);
            try{
              var r = typeof res === 'string' ? JSON.parse(res) : res;
              if (r && r.ok){
                message.success('Gasto actualizado');
                setModalOpen(false);
                cargar();
              }else{
                Modal.error({ title:'NO SE PUDO ACTUALIZAR', content: (r && r.message) || 'Error desconocido' });
              }
            }catch(_){
              Modal.error({ title:'ERROR', content:'RESPUESTA INVÁLIDA DEL SERVIDOR' });
            }
          })
          .withFailureHandler(function(err){
            setLoading(false);
            Modal.error({ title:'ERROR DE SERVIDOR', content: String((err && err.message) || err) });
          })
          .actualizarGasto(JSON.stringify(payload));
      }
    });
  }

  function eliminar(record){
    Modal.confirm({
      title: '¿Eliminar gasto?',
      content: 'Esta acción no se puede deshacer.',
      okText: 'Eliminar',
      okType: 'danger',
      cancelText: 'Cancelar',
      onOk: function(){
        setLoading(true);
        google.script.run
          .withSuccessHandler(function(res){
            setLoading(false);
            try{
              var r = typeof res === 'string' ? JSON.parse(res) : res;
              if (r && r.ok){
                message.success('Gasto eliminado');
                cargar();
              }else{
                Modal.error({ title:'NO SE PUDO ELIMINAR', content: (r && r.message) || 'Error desconocido' });
              }
            }catch(_){
              Modal.error({ title:'ERROR', content:'RESPUESTA INVÁLIDA DEL SERVIDOR' });
            }
          })
          .withFailureHandler(function(err){
            setLoading(false);
            Modal.error({ title:'ERROR DE SERVIDOR', content: String((err && err.message) || err) });
          })
          .eliminarGasto(String(record.id));
      }
    });
  }

  function limpiarFiltros(){
    setMesYear(defaultMonth);
    setFCategoria(undefined);
    setFSucursal(undefined);
    setQ('');
    setTimeout(cargar, 0);
  }

  function handleMontoFocus() {
    var v = form.getFieldValue('monto');
    if (v === initialMontoRef.current) form.setFieldsValue({ monto: null });
  }

  // --------- DASHBOARDS ---------
  const {
    total, count, avg,
    byCategoria, bySucursal, byMetodo,
    donutData, barsSucursal,
    dailySeries, daysInMonth
  } = useMemo(() => {
    const items = Array.isArray(data) ? data : [];
    let total = 0;
    let count = items.length;
    const byCategoria = {};
    const bySucursal = {};
    const byMetodo = {};

    items.forEach(r => {
      const monto = Number(r.monto || 0);
      total += monto;
      const cat = (r.categoria || 'Sin categoría');
      const suc = (r.nombreSucursal || 'Sin sucursal');
      const met = (r.metodoPago || 'Sin método');
      byCategoria[cat] = (byCategoria[cat] || 0) + monto;
      bySucursal[suc] = (bySucursal[suc] || 0) + monto;
      byMetodo[met] = (byMetodo[met] || 0) + monto;
    });

    const avg = count > 0 ? (total / count) : 0;

    const entriesCat = Object.entries(byCategoria).sort((a,b)=>b[1]-a[1]);
    let donutData = entriesCat.slice(0,6).map(([label,value],i)=>({ label, value, color: PALETTE[i % PALETTE.length] }));
    if (entriesCat.length > 6) {
      const otros = entriesCat.slice(6).reduce((acc, [,v]) => acc+v, 0);
      donutData.push({ label: 'Otros', value: otros, color: '#E5E7EB' });
    }

    const barsSucursal = Object.entries(bySucursal)
      .sort((a,b)=>b[1]-a[1])
      .slice(0,6)
      .map(([label,value],i)=>({ label, value, color: PALETTE[i % PALETTE.length] }));

    let y = Number(String(mesYear).slice(0,4));
    let m = Number(String(mesYear).slice(5,7));
    const daysInMonth = (!isNaN(y) && !isNaN(m)) ? new Date(y, m, 0).getDate() : 30;
    const daily = new Array(daysInMonth).fill(0);
    items.forEach(r=>{
      const d = safeDate(r.fecha);
      if (!d) return;
      const ry = d.getFullYear();
      const rm = d.getMonth() + 1;
      if (ry === y && rm === m) {
        const day = d.getDate();
        daily[day-1] += Number(r.monto || 0);
      }
    });
    const dailySeries = daily.map((v,idx)=>({ x: idx+1, y: v }));

    return { total, count, avg, byCategoria, bySucursal, byMetodo, donutData, barsSucursal, dailySeries, daysInMonth };
  }, [data, mesYear]);

  // --------- MINI COMPONENTES ---------
  function useCountUp(value, duration=800){
    const [display, setDisplay] = useState(0);
    const prevRef = useRef(0);
    useEffect(()=>{
      const start = performance.now();
      const from = prevRef.current;
      const to = Number(value||0);
      let raf;
      function tick(t){
        const p = Math.min(1, (t - start)/duration);
        const eased = 1 - Math.pow(1 - p, 3);
        setDisplay(from + (to - from) * eased);
        if (p < 1) raf = requestAnimationFrame(tick);
      }
      raf = requestAnimationFrame(tick);
      prevRef.current = to;
      return ()=> cancelAnimationFrame(raf);
    }, [value, duration]);
    return display;
  }

  function KPI({ title, value, formatter, icon, accent='#EEF2FF' }){
    const v = useCountUp(value);
    return (
      <Card className="gas-kpi fade-in" bodyStyle={{ padding: 14 }}>
        <div style={{ display:'flex', alignItems:'center', gap:12 }}>
          <div style={{ width:38, height:38, borderRadius:12, background:accent, display:'grid', placeItems:'center' }}>
            {icon}
          </div>
          <div style={{ flex:1 }}>
            <div style={{ fontSize:12, color:'#64748B' }}>{title}</div>
            <div style={{ fontSize:22, fontWeight:700 }}>{formatter ? formatter(v) : v.toFixed(0)}</div>
          </div>
        </div>
      </Card>
    );
  }

  function DonutChart({ data, total, onSelect }){
    if (!data || data.length === 0 || total <= 0){
      return <Card bodyStyle={{padding:14}}><div style={{textAlign:'center', color:'#94A3B8'}}>Sin datos para este período</div></Card>;
    }
    const size = 140, cx = 75, cy = 75, r = 50, strokeW = 18;
    let startAngle = 0;
    const slices = data.map((d,i)=>{
      const angle = (d.value/total) * 360;
      const endAngle = startAngle + angle;
      const out = { ...d, start: startAngle, end: endAngle };
      startAngle = endAngle;
      return out;
    });

    function polar(cx, cy, r, ang){
      const rad = (ang - 90) * Math.PI/180;
      return { x: cx + r*Math.cos(rad), y: cy + r*Math.sin(rad) };
    }
    function arcPath(cx, cy, r, start, end){
      const s = polar(cx, cy, r, start);
      const e = polar(cx, cy, r, end);
      const large = (end - start) > 180 ? 1 : 0;
      return `M ${s.x} ${s.y} A ${r} ${r} 0 ${large} 1 ${e.x} ${e.y}`;
    }

    return (
      <Card title={<Space><icons.PieChartOutlined /> <span>Distribución por categoría</span></Space>}
            extra={fCategoria ? <Tag color="blue" onClick={()=>setFCategoria(undefined)} style={{cursor:'pointer'}}>Quitar filtro</Tag> : null}
            bodyStyle={{ padding: 12 }}>
        <div style={{ display:'grid', gridTemplateColumns:'160px 1fr', gap:12, alignItems:'center' }}>
          <svg width={160} height={160} viewBox="0 0 150 150" className="fade-in" style={{transform:'scale(1)', transition:'transform .4s ease'}}>
            <circle cx={cx} cy={cy} r={r} fill="none" stroke="#F1F5F9" strokeWidth={strokeW} />
            {slices.map((s,i)=>(
              <path key={i}
                d={arcPath(cx,cy,r,s.start,s.end)}
                stroke={s.color}
                strokeWidth={strokeW}
                fill="none"
                style={{ cursor:'pointer', transition:'opacity .2s ease' }}
                onClick={()=> onSelect && onSelect(s.label)}
                onMouseEnter={e=> e.currentTarget.style.opacity = 0.85}
                onMouseLeave={e=> e.currentTarget.style.opacity = 1}
              />
            ))}
            <circle cx={cx} cy={cy} r={r- strokeW/2 - 4} fill="#FFFFFF"/>
            <text x={cx} y={cy-4} textAnchor="middle" style={{fontSize:12, fill:'#64748B'}}>Total</text>
            <text x={cx} y={cy+14} textAnchor="middle" style={{fontSize:14, fontWeight:700}}>{formatHNL(total)}</text>
          </svg>
          <div style={{ display:'grid', gap:6 }}>
            {data.map((d,i)=>(
              <div key={i} style={{ display:'flex', alignItems:'center', gap:8 }}>
                <span style={{ width:10, height:10, borderRadius:3, background:d.color }} />
                <div style={{ flex:1, whiteSpace:'nowrap', overflow:'hidden', textOverflow:'ellipsis' }}>
                  <Tooltip title="Filtrar por categoría">
                    <a onClick={()=> onSelect && onSelect(d.label)}>{d.label}</a>
                  </Tooltip>
                </div>
                <div style={{ width:80, textAlign:'right', color:'#475569' }}>{formatHNL(d.value)}</div>
                <div style={{ width:48, textAlign:'right', color:'#64748B' }}>{formatPercent(d.value, total)}</div>
              </div>
            ))}
          </div>
        </div>
      </Card>
    );
  }

  function BarList({ data, onSelect, title, hint='Filtrar', icon }){
    const max = data.reduce((a,b)=> Math.max(a, Number(b.value||0)), 0) || 1;
    return (
      <Card title={<Space>{icon}{title}</Space>}
            extra={fSucursal ? <Tag color="blue" onClick={()=>setFSucursal(undefined)} style={{cursor:'pointer'}}>Quitar filtro</Tag> : null}
            bodyStyle={{ padding: 12 }}>
        <div className="fade-in" style={{ display:'grid', gap:8 }}>
          {data.length === 0 ? <div style={{textAlign:'center', color:'#94A3B8'}}>Sin datos</div> : null}
          {data.map((d,i)=>(
            <div key={i} style={{ display:'grid', gridTemplateColumns:'auto 80px', gap:10, alignItems:'center' }}>
              <div style={{ display:'grid', gridTemplateColumns:'16px 1fr', gap:8, alignItems:'center' }}>
                <span style={{ width:10, height:10, borderRadius:3, background:d.color }} />
                <div style={{ position:'relative' }}>
                  <div style={{ fontSize:12, color:'#334155', marginBottom:4, whiteSpace:'nowrap', overflow:'hidden', textOverflow:'ellipsis' }}>{d.label}</div>
                  <Tooltip title={hint}>
                    <div onClick={()=> onSelect && onSelect(d.label)}
                         style={{ height:8, background:'#F1F5F9', borderRadius:999, cursor:'pointer' }}>
                      <div className="bar" style={{
                        width: (Math.max(3,(d.value/max)*100)).toFixed(2)+'%',
                        height:'100%',
                        borderRadius:999,
                        background:`linear-gradient(90deg, ${d.color} 0%, ${d.color}CC 100%)`,
                        transition:'width .8s ease'
                      }} />
                    </div>
                  </Tooltip>
                </div>
              </div>
              <div style={{ textAlign:'right', fontWeight:600 }}>{formatHNL(d.value)}</div>
            </div>
          ))}
        </div>
      </Card>
    );
  }

  function Sparkline({ data, days }){
    const W = 340, H = 90, pad = 8;
    const maxY = data.reduce((a,b)=>Math.max(a, b.y), 0) || 1;
    const stepX = (W - pad*2) / Math.max(1, days - 1);
    const scaleY = v => (H - pad) - ( (Number(v)/maxY) * (H - pad*2) );
    const points = data.map((d,i)=> [pad + i*stepX, scaleY(d.y)] );
    const path = points.map((p,i)=> (i===0? 'M':'L') + p[0].toFixed(2)+' '+p[1].toFixed(2)).join(' ');
    return (
      <Card title={<Space><icons.AreaChartOutlined /> Tendencia diaria</Space>} bodyStyle={{padding:12}}>
        {data.length === 0 ? <div style={{textAlign:'center', color:'#94A3B8'}}>Sin datos</div> : (
          <svg width={W} height={H} className="fade-in">
            <path d={path} fill="none" stroke="#7FB3FF" strokeWidth="2" />
            <path d={`${path} L ${pad + (days-1)*stepX} ${H-pad} L ${pad} ${H-pad} Z`} fill="#7FB3FF22" />
            {points.map((p,i)=>(<circle key={i} cx={p[0]} cy={p[1]} r="2" fill="#7FB3FF" />))}
          </svg>
        )}
        <div style={{ fontSize:12, color:'#64748B', marginTop:6 }}>
          {days} días · Máximo diario {formatHNL(maxY)}
        </div>
      </Card>
    );
  }

  // === Filtros como componente reutilizable ===
  function Filtros({ style }) {
    return (
      <Row gutter={[12,12]} style={{ marginBottom: 12, ...(style||{}) }}>
        <Col xs={24} md={6}>
          <label className="block text-xs text-gray-500 mb-1">Mes</label>
          <input type="month" className="w-full border rounded px-2 py-1"
                 value={mesYear} onChange={e=>setMesYear(e.target.value)} />
        </Col>
        <Col xs={24} md={6}>
          <label className="block text-xs text-gray-500 mb-1">Categoría</label>
          <Select allowClear placeholder="Todas" className="w-full"
                  value={fCategoria} onChange={setFCategoria}
                  options={CATEGORIAS.map(function(c){ return { value:c, label:c }; })} />
        </Col>
        <Col xs={24} md={6}>
          <label className="block text-xs text-gray-500 mb-1">Sucursal</label>
          <Select allowClear placeholder="Todas" className="w-full"
                  value={fSucursal} onChange={setFSucursal}
                  options={(sucursales||[]).map(function(s){ return { value:s.nombreSucursal, label:s.nombreSucursal }; })} />
        </Col>
        <Col xs={24} md={6}>
          <label className="block text-xs text-gray-500 mb-1">Buscar</label>
          <Input.Search placeholder="Texto libre..." value={q}
                        onChange={e=>setQ(e.target.value)} onSearch={cargar} allowClear />
        </Col>
      </Row>
    );
  }

  // --------- COLUMNAS TABLA ---------
  const columns = [
    { title: 'Fecha', dataIndex: 'fecha', key: 'fecha',
      render: function(v){
        try{
          var d = (v && typeof v === 'string') ? new Date(v) : v;
          var y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
          return dd + '/' + m + '/' + y;
        }catch(_){ return ''; }
      }
    },
    { title: 'Categoría', dataIndex: 'categoria', key: 'categoria',
      render: function(v){ return <Tag color="blue">{v || '-'}</Tag>; }
    },
    { title: 'Descripción', dataIndex: 'descripcion', key: 'descripcion' },
    { title: 'Monto (L.)', dataIndex: 'monto', key: 'monto',
      align: 'right',
      render: function(v){ return <b>{formatHNL(v)}</b>; }
    },
    { title: 'Método', dataIndex: 'metodoPago', key: 'metodoPago' },
    { title: 'Proveedor', dataIndex: 'proveedor', key: 'proveedor' },
    { title: 'Sucursal', dataIndex: 'nombreSucursal', key: 'nombreSucursal' },
    { title: 'Acciones', key: 'acciones',
      render: function(_,record){
        return (
          <Space direction="vertical" size={4}>
            <Space size={4}>
              <Button size="small" onClick={()=>abrirEditar(record)} icon={<icons.EditOutlined />}>Editar</Button>
              <Button size="small" danger onClick={()=>eliminar(record)} icon={<icons.DeleteOutlined />}>Eliminar</Button>
            </Space>
            <Button size="small" type="dashed" onClick={()=>abrirNuevoPago(record)} icon={<icons.CopyOutlined />}>Nuevo pago</Button>
          </Space>
        );
      }
    }
  ];

  // --------- RENDER (diseño estilo Sucursales) ---------
  return (
    <div className="gastos-wrap">
      <Card
        title={<div className="gas-hero-title"><span className="gas-spark"></span>Gastos</div>}
        extra={
          <Space>
            <Button onClick={cargar} loading={loading} icon={<icons.ReloadOutlined />}>Refrescar</Button>
            <Button onClick={limpiarFiltros}>Limpiar filtros</Button>
            <Button type="primary" onClick={abrirNuevo} icon={<icons.PlusOutlined />}>Nuevo</Button>
          </Space>
        }
      >
        <style>{`
          .fade-in { animation: fadeIn .45s ease; }
          @keyframes fadeIn { from { opacity:.0; transform: translateY(4px) } to { opacity:1; transform: translateY(0) } }
          .bar { will-change: width; }

          /* Hero con spark (como Sucursales) */
          .gas-hero-title{ position:relative; padding-left:12px; font-weight:800; }
          .gas-spark{
            position:absolute; left:0; top:6px; width:6px; height:22px; border-radius:3px;
            background: linear-gradient(180deg,#60a5fa,#a78bfa,#34d399);
            animation: gasSpark 2.6s ease-in-out infinite;
          }
          @keyframes gasSpark{ 0%{opacity:.4; transform:translateY(0)} 50%{opacity:1; transform:translateY(6px)} 100%{opacity:.4; transform:translateY(0)} }

          /* KPI tiles con gradiente suave */
          .gas-kpi{ border-radius:14px; background: linear-gradient(135deg,#e0eaff,#e9fff6); box-shadow: 0 2px 10px rgba(15,23,42,.06); }

          /* Centrados y tabla “pastel” */
          .tbl-center { max-width: 1200px; margin: 0 auto; }
          .gastos-wrap .gas-table .ant-table{ border-radius:14px; overflow:hidden; }
          .gastos-wrap .gas-table .ant-table-thead > tr > th{
            background:#f8fafc !important; border-bottom:0; color:#334155; font-weight:700;
          }
          .gastos-wrap .gas-table .ant-table-tbody > tr{
            transition: transform .15s ease, box-shadow .15s ease, background .2s;
            animation: gasFadeUp .35s ease both;
          }
          @keyframes gasFadeUp{ from{ opacity:0; transform:translateY(6px) } to{ opacity:1; transform:translateY(0) } }
          .gastos-wrap .gas-table .ant-table-tbody > tr:hover{
            transform: scale(1.01); box-shadow: 0 10px 24px rgba(2,6,23,.08);
          }
          .gastos-wrap .gas-table .ant-table-tbody > tr:nth-child(odd) td{ background:#fcfdff; }
        `}</style>

        {/* Filtros originales: ocultos (se conservan) */}
        <Filtros style={{ display:'none' }} />

        {/* Tarjeta "Total del período": OCULTA (se conserva) */}
        <Row gutter={[12,12]} style={{ marginBottom: 12, display:'none' }}>
          <Col xs={24} md={8}>
            <div className="p-3 bg-gray-50 rounded border">
              <div className="text-gray-500 text-xs">Total del período</div>
              <div className="text-2xl font-bold">{formatHNL(total)}</div>
            </div>
          </Col>
        </Row>

        {/* KPIs y gráficos (sin cambios de lógica) */}
        <Row gutter={[12,12]} style={{ marginBottom: 12 }}>
          <Col xs={24} sm={8}>
            <KPI title="Total" value={total} formatter={formatHNL}
                 icon={<icons.WalletOutlined />} accent="#EEF2FF" />
          </Col>
          <Col xs={24} sm={8}>
            <KPI title="N.º de gastos" value={count}
                 icon={<icons.NumberOutlined />} accent="#E6FFFB" />
          </Col>
          <Col xs={24} sm={8}>
            <KPI title="Promedio por gasto" value={avg} formatter={formatHNL}
                 icon={<icons.RiseOutlined />} accent="#F0FFF4" />
          </Col>
        </Row>

        <Row gutter={[12,12]} style={{ marginBottom: 12 }}>
          <Col xs={24} md={12}>
            <DonutChart data={donutData} total={total} onSelect={(label)=> setFCategoria(label)} />
          </Col>
          <Col xs={24} md={12}>
            <BarList data={barsSucursal}
                     onSelect={(label)=> setFSucursal(label)}
                     title="Gasto por sucursal"
                     hint="Filtrar por sucursal"
                     icon={<icons.BarChartOutlined />} />
          </Col>
        </Row>

        <Row gutter={[12,12]} style={{ marginBottom: 12 }}>
          <Col xs={24} md={12}>
            <Sparkline data={dailySeries} days={daysInMonth} />
          </Col>
          <Col xs={24} md={12}>
            <Card title={<Space><icons.ClusterOutlined /> Método de pago</Space>} bodyStyle={{padding:12}}>
              {Object.keys(byMetodo).length === 0 ? <div style={{textAlign:'center', color:'#94A3B8'}}>Sin datos</div> : (
                <div style={{ display:'grid', gap:8 }}>
                  {Object.entries(byMetodo).map(([k,v],i)=>(
                    <div key={k} style={{ display:'flex', alignItems:'center', gap:10 }}>
                      <span style={{ width:10, height:10, borderRadius:3, background:PALETTE[i % PALETTE.length] }} />
                      <div style={{ flex:1 }}>{k}</div>
                      <div style={{ width:80, textAlign:'right', fontWeight:600 }}>{formatHNL(v)}</div>
                      <div style={{ width:48, textAlign:'right', color:'#64748B' }}>{formatPercent(v, total)}</div>
                    </div>
                  ))}
                </div>
              )}
            </Card>
          </Col>
        </Row>

        {/* === Filtros arriba de la TABLA con collapse === */}
        <Collapse ghost defaultActiveKey={['1']} style={{ marginBottom: 12 }}>
          <Collapse.Panel header="Filtros" key="1">
            <Filtros />
          </Collapse.Panel>
        </Collapse>

        {/* Tabla centrada con estilo */}
        <div className="tbl-center">
          <Table
            className="gas-table"
            dataSource={data}
            columns={columns}
            loading={loading}
            pagination={{ pageSize: 10 }}
            rowKey="id"
            scroll={{ x: true }}
          />
        </div>

        {/* Modal */}
        <Modal
          visible={modalOpen}
          title={modalMode === 'create' ? 'Nuevo gasto' : 'Editar gasto'}
          onCancel={()=>setModalOpen(false)}
          onOk={onSubmit}
          okText={modalMode === 'create' ? 'Guardar' : 'Actualizar'}
          confirmLoading={loading}
          destroyOnClose
        >
          <Form form={form} layout="vertical">
            <Form.Item name="fecha" label="Fecha" rules={[{ required:true, message:'LA FECHA ES OBLIGATORIA' }]}>
              <input type="date" className="w-full border rounded px-2 py-1" />
            </Form.Item>

            <Form.Item name="categoria" label="Categoría" rules={[{ required:true, message:'SELECCIONE UNA CATEGORÍA' }]}>
              <Select
                showSearch
                placeholder="Seleccione"
                disabled={lockCategoria}
                options={CATEGORIAS.map(function(c){ return { value:c, label:c }; })}
              />
            </Form.Item>

            <Form.Item name="descripcion" label="Descripción" rules={[{ required:true, message:'INGRESE UNA DESCRIPCIÓN' }]}>
              <Input.TextArea rows={3} placeholder="Detalle del gasto" />
            </Form.Item>

            <Row gutter={12}>
              <Col span={12}>
                <Form.Item name="monto" label="Monto (L.)" rules={[
                  { required:true, message:'INGRESE UN MONTO' },
                  { validator:(_,v)=> (v==null || Number(v) <= 0) ? Promise.reject('EL MONTO DEBE SER MAYOR QUE 0') : Promise.resolve() }
                ]}>
                  <InputNumber className="w-full" min={0} step={0.01} onFocus={handleMontoFocus} />
                </Form.Item>
              </Col>
              <Col span={12}>
                <Form.Item name="metodoPago" label="Método de pago" rules={[{ required:true, message:'SELECCIONE MÉTODO DE PAGO' }]}>
                  <Select placeholder="Seleccione" options={METODOS.map(function(m){ return { value:m, label:m }; })} />
                </Form.Item>
              </Col>
            </Row>

            <Row gutter={12}>
              <Col span={12}>
                <Form.Item name="proveedor" label="Proveedor">
                  <Input placeholder="Opcional" />
                </Form.Item>
              </Col>
              <Col span={12}>
                <Form.Item name="nombreSucursal" label="Sucursal" rules={[{ required:true, message:'SELECCIONE UNA SUCURSAL' }]}>
                  <Select allowClear showSearch placeholder="Seleccione"
                          options={(sucursales||[]).map(function(s){ return { value:s.nombreSucursal, label:s.nombreSucursal }; })} />
                </Form.Item>
              </Col>
            </Row>
          </Form>
        </Modal>
      </Card>
    </div>
  );
}
// </script>
